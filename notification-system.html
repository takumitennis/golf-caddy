<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ÈÄöÁü•„Ç∑„Çπ„ÉÜ„É†</title>
  <style>
    :root {
      --primary-color: #2f8f2f;
      --primary-dark: #1e5f1e;
      --primary-light: #4caf50;
      --secondary-color: #ffffff;
      --accent-color: #ff6b35;
      --text-color: #333333;
      --text-light: #666666;
      --bg-light: #f8f9fa;
      --bg-dark: #2c3e50;
      --border-radius: 12px;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      --shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.15);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Helvetica Neue", Arial, "Hiragino Sans", "Yu Gothic", "Meiryo", sans-serif;
      background: var(--bg-light);
      color: var(--text-color);
      line-height: 1.6;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, var(--bg-dark), #34495e);
      color: white;
      padding: 1.5rem 2rem;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
    }

    .header h1 {
      font-size: 1.6rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .header p {
      opacity: 0.9;
      font-size: 0.95rem;
    }

    /* Container */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }

    /* Notification Bell */
    .notification-bell {
      position: fixed;
      top: 2rem;
      right: 2rem;
      background: var(--primary-color);
      color: white;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: var(--transition);
      z-index: 1000;
    }

    .notification-bell:hover {
      transform: scale(1.1);
      box-shadow: var(--shadow-hover);
    }

    .notification-bell .badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--accent-color);
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: bold;
    }

    .notification-bell i {
      font-size: 1.5rem;
    }

    /* Notification Panel */
    .notification-panel {
      position: fixed;
      top: 5rem;
      right: 2rem;
      width: 400px;
      max-height: 500px;
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-hover);
      z-index: 999;
      display: none;
      overflow: hidden;
    }

    .notification-panel.show {
      display: block;
      animation: slideInDown 0.3s ease-out;
    }

    @keyframes slideInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .notification-header {
      background: var(--primary-color);
      color: white;
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .notification-header h3 {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .mark-all-read {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 0.9rem;
      text-decoration: underline;
    }

    .notification-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .notification-item {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #e1e8ed;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
    }

    .notification-item:hover {
      background: #f8f9fa;
    }

    .notification-item.unread {
      background: #f0f8ff;
      border-left: 4px solid var(--primary-color);
    }

    .notification-item.unread::before {
      content: '';
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 8px;
      height: 8px;
      background: var(--primary-color);
      border-radius: 50%;
    }

    .notification-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: var(--text-color);
    }

    .notification-message {
      color: var(--text-light);
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    .notification-time {
      color: var(--text-light);
      font-size: 0.8rem;
    }

    /* Main Content */
    .content-grid {
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: 2rem;
      margin-top: 2rem;
    }

    /* Notification History */
    .notification-history {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .history-header {
      background: var(--primary-color);
      color: white;
      padding: 1.5rem;
    }

    .history-header h2 {
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .history-filters {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }

    .filter-btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: var(--border-radius);
      background: rgba(255, 255, 255, 0.2);
      color: white;
      cursor: pointer;
      transition: var(--transition);
      font-size: 0.9rem;
    }

    .filter-btn.active {
      background: white;
      color: var(--primary-color);
    }

    .filter-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .history-list {
      max-height: 600px;
      overflow-y: auto;
    }

    .history-item {
      padding: 1.5rem;
      border-bottom: 1px solid #e1e8ed;
      transition: var(--transition);
    }

    .history-item:hover {
      background: #f8f9fa;
    }

    .history-item.unread {
      background: #f0f8ff;
    }

    .history-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.5rem;
    }

    .history-item-title {
      font-weight: 600;
      color: var(--text-color);
      flex: 1;
    }

    .history-item-time {
      color: var(--text-light);
      font-size: 0.85rem;
      margin-left: 1rem;
    }

    .history-item-message {
      color: var(--text-light);
      margin-bottom: 0.5rem;
    }

    .history-item-actions {
      display: flex;
      gap: 0.5rem;
    }

    .action-btn {
      padding: 0.25rem 0.75rem;
      border: none;
      border-radius: calc(var(--border-radius) - 4px);
      background: var(--bg-light);
      color: var(--text-color);
      cursor: pointer;
      transition: var(--transition);
      font-size: 0.8rem;
    }

    .action-btn:hover {
      background: var(--primary-color);
      color: white;
    }

    /* Settings Panel */
    .settings-panel {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 1.5rem;
      height: fit-content;
    }

    .settings-panel h3 {
      color: var(--primary-color);
      margin-bottom: 1.5rem;
      font-size: 1.2rem;
      font-weight: 600;
    }

    .setting-group {
      margin-bottom: 2rem;
    }

    .setting-group h4 {
      margin-bottom: 1rem;
      color: var(--text-color);
      font-weight: 600;
    }

    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid #e1e8ed;
    }

    .setting-item:last-child {
      border-bottom: none;
    }

    .setting-label {
      color: var(--text-color);
      font-weight: 500;
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 24px;
      background: #ccc;
      border-radius: 12px;
      cursor: pointer;
      transition: var(--transition);
    }

    .toggle-switch.active {
      background: var(--primary-color);
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: var(--transition);
    }

    .toggle-switch.active::after {
      transform: translateX(26px);
    }

    .notification-type {
      margin-bottom: 1rem;
    }

    .notification-type label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      padding: 0.5rem 0;
    }

    .notification-type input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary-color);
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      padding: 1.5rem;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      text-align: center;
      transition: var(--transition);
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    .stat-number {
      font-size: 2rem;
      font-weight: bold;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }

    .stat-label {
      color: var(--text-light);
      font-size: 0.9rem;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .content-grid {
        grid-template-columns: 1fr;
      }

      .notification-panel {
        width: 90%;
        right: 5%;
        left: 5%;
      }

      .notification-bell {
        top: 1rem;
        right: 1rem;
        width: 50px;
        height: 50px;
      }

      .notification-bell i {
        font-size: 1.2rem;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 1rem;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .history-filters {
        flex-direction: column;
      }

      .filter-btn {
        text-align: center;
      }
    }

    /* Loading Animation */
    .loading {
      opacity: 0;
      transform: translateY(20px);
      transition: var(--transition);
    }

    .loading.loaded {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <!-- Notification Bell -->
  <div class="notification-bell" id="notificationBell">
    <i>üîî</i>
    <div class="badge" id="notificationBadge">0</div>
  </div>

  <!-- Notification Panel -->
  <div class="notification-panel" id="notificationPanel">
    <div class="notification-header">
      <h3>ÈÄöÁü•</h3>
      <button class="mark-all-read" id="markAllRead">ÂÖ®„Å¶Êó¢Ë™≠</button>
    </div>
    <div class="notification-list" id="notificationList">
      <!-- Notifications will be populated here -->
    </div>
  </div>

  <!-- Header -->
  <div class="header">
    <h1>üîî ÈÄöÁü•„Ç∑„Çπ„ÉÜ„É†</h1>
    <p>„É™„Ç¢„É´„Çø„Ç§„É†ÈÄöÁü•„Å®Ë®≠ÂÆöÁÆ°ÁêÜ</p>
  </div>

  <div class="container">
    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card loading">
        <div class="stat-number" id="totalNotifications">0</div>
        <div class="stat-label">Á∑èÈÄöÁü•Êï∞</div>
      </div>
      <div class="stat-card loading">
        <div class="stat-number" id="unreadNotifications">0</div>
        <div class="stat-label">Êú™Ë™≠ÈÄöÁü•</div>
      </div>
      <div class="stat-card loading">
        <div class="stat-number" id="todayNotifications">0</div>
        <div class="stat-label">‰ªäÊó•„ÅÆÈÄöÁü•</div>
      </div>
      <div class="stat-card loading">
        <div class="stat-number" id="weeklyNotifications">0</div>
        <div class="stat-label">‰ªäÈÄ±„ÅÆÈÄöÁü•</div>
      </div>
    </div>

    <div class="content-grid">
      <!-- Notification History -->
      <div class="notification-history">
        <div class="history-header">
          <h2>ÈÄöÁü•Â±•Ê≠¥</h2>
          <div class="history-filters">
            <button class="filter-btn active" data-filter="all">ÂÖ®„Å¶</button>
            <button class="filter-btn" data-filter="unread">Êú™Ë™≠</button>
            <button class="filter-btn" data-filter="booking">‰∫àÁ¥Ñ</button>
            <button class="filter-btn" data-filter="message">„É°„ÉÉ„Çª„Éº„Ç∏</button>
            <button class="filter-btn" data-filter="system">„Ç∑„Çπ„ÉÜ„É†</button>
          </div>
        </div>
        <div class="history-list" id="historyList">
          <!-- History items will be populated here -->
        </div>
      </div>

      <!-- Settings Panel -->
      <div class="settings-panel">
        <h3>‚öôÔ∏è ÈÄöÁü•Ë®≠ÂÆö</h3>
        
        <div class="setting-group">
          <h4>ÈÄöÁü•„ÅÆÊúâÂäπÂåñ</h4>
          <div class="setting-item">
            <span class="setting-label">„Éó„ÉÉ„Ç∑„É•ÈÄöÁü•</span>
            <div class="toggle-switch active" id="pushToggle"></div>
          </div>
          <div class="setting-item">
            <span class="setting-label">„É°„Éº„É´ÈÄöÁü•</span>
            <div class="toggle-switch active" id="emailToggle"></div>
          </div>
          <div class="setting-item">
            <span class="setting-label">SMSÈÄöÁü•</span>
            <div class="toggle-switch" id="smsToggle"></div>
          </div>
        </div>

        <div class="setting-group">
          <h4>ÈÄöÁü•„Çø„Ç§„Éó</h4>
          <div class="notification-type">
            <label>
              <input type="checkbox" checked id="bookingNotifications">
              ‰∫àÁ¥ÑÈñ¢ÈÄ£„ÅÆÈÄöÁü•
            </label>
          </div>
          <div class="notification-type">
            <label>
              <input type="checkbox" checked id="messageNotifications">
              „É°„ÉÉ„Çª„Éº„Ç∏ÈÄöÁü•
            </label>
          </div>
          <div class="notification-type">
            <label>
              <input type="checkbox" checked id="systemNotifications">
              „Ç∑„Çπ„ÉÜ„É†ÈÄöÁü•
            </label>
          </div>
          <div class="notification-type">
            <label>
              <input type="checkbox" id="promotionNotifications">
              „Éó„É≠„É¢„Éº„Ç∑„Éß„É≥ÈÄöÁü•
            </label>
          </div>
        </div>

        <div class="setting-group">
          <h4>ÈÄöÁü•È†ªÂ∫¶</h4>
          <div class="setting-item">
            <span class="setting-label">Âç≥Â∫ß„Å´ÈÄöÁü•</span>
            <div class="toggle-switch active" id="instantToggle"></div>
          </div>
          <div class="setting-item">
            <span class="setting-label">Êó•Ê¨°„Çµ„Éû„É™„Éº</span>
            <div class="toggle-switch" id="dailyToggle"></div>
          </div>
          <div class="setting-item">
            <span class="setting-label">ÈÄ±Ê¨°„Çµ„Éû„É™„Éº</span>
            <div class="toggle-switch" id="weeklyToggle"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabase = window.supabase.createClient(
      "https://vqjxajzaasuqfgvhvxci.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxanhhanphYXN1cWZndmh2eGNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2MjIxMzgsImV4cCI6MjA2OTE5ODEzOH0.NmKwgZA1_-TTvMTQt07QRXtIlR-DPOPATVPuQ3QuO54"
    );

    let currentUser = null;
    let notifications = [];
    let currentFilter = 'all';

    // Loading animation
    const observerOptions = {
      threshold: 0.1,
      rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver(function(entries) {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('loaded');
        }
      });
    }, observerOptions);

    document.querySelectorAll('.loading').forEach(el => {
      observer.observe(el);
    });

    // Initialize
    async function initialize() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        window.location.href = '/login.html';
        return;
      }
      
      currentUser = user;
      await loadNotifications();
      await loadStats();
      setupEventListeners();
      setupRealtimeSubscription();
    }

    // Load notifications
    async function loadNotifications() {
      try {
        const { data, error } = await supabase
          .from('notifications')
          .select('*')
          .eq('user_id', currentUser.id)
          .order('created_at', { ascending: false })
          .limit(50);

        if (error) throw error;

        notifications = data || [];
        renderNotifications();
        renderHistory();
        updateBadge();
      } catch (error) {
        console.error('Error loading notifications:', error);
        // Use mock data for demo
        notifications = getMockNotifications();
        renderNotifications();
        renderHistory();
        updateBadge();
      }
    }

    // Mock notifications for demo
    function getMockNotifications() {
      return [
        {
          id: 1,
          title: 'Êñ∞„Åó„ÅÑ‰∫àÁ¥Ñ„Åå‰ΩúÊàê„Åï„Çå„Åæ„Åó„Åü',
          message: '2024Âπ¥1Êúà20Êó•„ÅÆ‰∫àÁ¥Ñ„ÅåÁ¢∫ÂÆö„Åó„Åæ„Åó„Åü„ÄÇ',
          type: 'booking',
          is_read: false,
          created_at: new Date().toISOString()
        },
        {
          id: 2,
          title: '„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂèó‰ø°„Åó„Åæ„Åó„Åü',
          message: 'ABC„Ç¥„É´„ÉïÂ†¥„Åã„ÇâÊñ∞„Åó„ÅÑ„É°„ÉÉ„Çª„Éº„Ç∏„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ',
          type: 'message',
          is_read: false,
          created_at: new Date(Date.now() - 3600000).toISOString()
        },
        {
          id: 3,
          title: '„Ç∑„Çπ„ÉÜ„É†„É°„É≥„ÉÜ„Éä„É≥„Çπ„ÅÆ„ÅäÁü•„Çâ„Åõ',
          message: '1Êúà25Êó•Ê∑±Â§ú2ÊôÇ„Åã„Çâ4ÊôÇ„Åæ„Åß„É°„É≥„ÉÜ„Éä„É≥„Çπ„ÇíÂÆüÊñΩ„Åó„Åæ„Åô„ÄÇ',
          type: 'system',
          is_read: true,
          created_at: new Date(Date.now() - 7200000).toISOString()
        },
        {
          id: 4,
          title: '„Ç∑„Éï„ÉàÊõ¥Êñ∞„ÅÆ„ÅäÁü•„Çâ„Åõ',
          message: 'Êù•Êúà„ÅÆ„Ç∑„Éï„Éà„ÅåÊõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü„ÄÇ„ÅîÁ¢∫Ë™ç„Åè„Å†„Åï„ÅÑ„ÄÇ',
          type: 'booking',
          is_read: true,
          created_at: new Date(Date.now() - 86400000).toISOString()
        }
      ];
    }

    // Render notifications in panel
    function renderNotifications() {
      const list = document.getElementById('notificationList');
      const unreadNotifications = notifications.filter(n => !n.is_read).slice(0, 10);
      
      list.innerHTML = unreadNotifications.length === 0 
        ? '<div style="padding: 2rem; text-align: center; color: var(--text-light);">Êñ∞„Åó„ÅÑÈÄöÁü•„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>'
        : unreadNotifications.map(notification => `
            <div class="notification-item ${!notification.is_read ? 'unread' : ''}" data-id="${notification.id}">
              <div class="notification-title">${notification.title}</div>
              <div class="notification-message">${notification.message}</div>
              <div class="notification-time">${formatTime(notification.created_at)}</div>
            </div>
          `).join('');
    }

    // Render history
    function renderHistory() {
      const list = document.getElementById('historyList');
      const filteredNotifications = filterNotifications(notifications, currentFilter);
      
      list.innerHTML = filteredNotifications.length === 0 
        ? '<div style="padding: 2rem; text-align: center; color: var(--text-light);">ÈÄöÁü•Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>'
        : filteredNotifications.map(notification => `
            <div class="history-item ${!notification.is_read ? 'unread' : ''}" data-id="${notification.id}">
              <div class="history-item-header">
                <div class="history-item-title">${notification.title}</div>
                <div class="history-item-time">${formatTime(notification.created_at)}</div>
              </div>
              <div class="history-item-message">${notification.message}</div>
              <div class="history-item-actions">
                ${!notification.is_read ? '<button class="action-btn mark-read">Êó¢Ë™≠</button>' : ''}
                <button class="action-btn delete-notification">ÂâäÈô§</button>
              </div>
            </div>
          `).join('');
    }

    // Filter notifications
    function filterNotifications(notifications, filter) {
      switch (filter) {
        case 'unread':
          return notifications.filter(n => !n.is_read);
        case 'booking':
          return notifications.filter(n => n.type === 'booking');
        case 'message':
          return notifications.filter(n => n.type === 'message');
        case 'system':
          return notifications.filter(n => n.type === 'system');
        default:
          return notifications;
      }
    }

    // Update badge
    function updateBadge() {
      const badge = document.getElementById('notificationBadge');
      const unreadCount = notifications.filter(n => !n.is_read).length;
      badge.textContent = unreadCount;
      badge.style.display = unreadCount > 0 ? 'flex' : 'none';
    }

    // Load stats
    async function loadStats() {
      const total = notifications.length;
      const unread = notifications.filter(n => !n.is_read).length;
      const today = notifications.filter(n => {
        const today = new Date().toDateString();
        return new Date(n.created_at).toDateString() === today;
      }).length;
      const weekly = notifications.filter(n => {
        const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
        return new Date(n.created_at) > weekAgo;
      }).length;

      document.getElementById('totalNotifications').textContent = total;
      document.getElementById('unreadNotifications').textContent = unread;
      document.getElementById('todayNotifications').textContent = today;
      document.getElementById('weeklyNotifications').textContent = weekly;
    }

    // Setup event listeners
    function setupEventListeners() {
      // Notification bell
      document.getElementById('notificationBell').addEventListener('click', () => {
        const panel = document.getElementById('notificationPanel');
        panel.classList.toggle('show');
      });

      // Mark all read
      document.getElementById('markAllRead').addEventListener('click', () => {
        markAllAsRead();
      });

      // Filter buttons
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFilter = btn.dataset.filter;
          renderHistory();
        });
      });

      // Toggle switches
      document.querySelectorAll('.toggle-switch').forEach(toggle => {
        toggle.addEventListener('click', () => {
          toggle.classList.toggle('active');
        });
      });

      // Close panel when clicking outside
      document.addEventListener('click', (e) => {
        const panel = document.getElementById('notificationPanel');
        const bell = document.getElementById('notificationBell');
        
        if (!panel.contains(e.target) && !bell.contains(e.target)) {
          panel.classList.remove('show');
        }
      });

      // History item actions
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('mark-read')) {
          const item = e.target.closest('.history-item');
          const id = parseInt(item.dataset.id);
          markAsRead(id);
        }
        
        if (e.target.classList.contains('delete-notification')) {
          const item = e.target.closest('.history-item');
          const id = parseInt(item.dataset.id);
          deleteNotification(id);
        }
      });

      // Notification item click
      document.addEventListener('click', (e) => {
        if (e.target.closest('.notification-item')) {
          const item = e.target.closest('.notification-item');
          const id = parseInt(item.dataset.id);
          markAsRead(id);
          document.getElementById('notificationPanel').classList.remove('show');
        }
      });
    }

    // Mark as read
    async function markAsRead(id) {
      try {
        const notification = notifications.find(n => n.id === id);
        if (notification) {
          notification.is_read = true;
          renderNotifications();
          renderHistory();
          updateBadge();
          loadStats();
        }
      } catch (error) {
        console.error('Error marking as read:', error);
      }
    }

    // Mark all as read
    async function markAllAsRead() {
      try {
        notifications.forEach(n => n.is_read = true);
        renderNotifications();
        renderHistory();
        updateBadge();
        loadStats();
      } catch (error) {
        console.error('Error marking all as read:', error);
      }
    }

    // Delete notification
    async function deleteNotification(id) {
      try {
        notifications = notifications.filter(n => n.id !== id);
        renderNotifications();
        renderHistory();
        updateBadge();
        loadStats();
      } catch (error) {
        console.error('Error deleting notification:', error);
      }
    }

    // Setup realtime subscription
    function setupRealtimeSubscription() {
      const channel = supabase
        .channel('notifications')
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'notifications',
          filter: `user_id=eq.${currentUser.id}`
        }, (payload) => {
          const newNotification = payload.new;
          notifications.unshift(newNotification);
          renderNotifications();
          renderHistory();
          updateBadge();
          loadStats();
          
          // Show toast notification
          showToast(newNotification.title, newNotification.message);
        })
        .subscribe();

      return () => {
        supabase.removeChannel(channel);
      };
    }

    // Show toast notification
    function showToast(title, message) {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 2rem;
        left: 2rem;
        background: white;
        border-left: 4px solid var(--primary-color);
        padding: 1rem;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-hover);
        z-index: 10000;
        max-width: 300px;
        animation: slideInLeft 0.3s ease-out;
      `;
      
      toast.innerHTML = `
        <div style="font-weight: 600; margin-bottom: 0.5rem;">${title}</div>
        <div style="color: var(--text-light); font-size: 0.9rem;">${message}</div>
      `;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideOutLeft 0.3s ease-out';
        setTimeout(() => {
          document.body.removeChild(toast);
        }, 300);
      }, 5000);
    }

    // Format time
    function formatTime(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diff = now - date;
      
      if (diff < 60000) return '‰ªä';
      if (diff < 3600000) return `${Math.floor(diff / 60000)}ÂàÜÂâç`;
      if (diff < 86400000) return `${Math.floor(diff / 3600000)}ÊôÇÈñìÂâç`;
      if (diff < 604800000) return `${Math.floor(diff / 86400000)}Êó•Ââç`;
      
      return date.toLocaleDateString('ja-JP');
    }

    // Add CSS animations
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideInLeft {
        from {
          opacity: 0;
          transform: translateX(-100%);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
      
      @keyframes slideOutLeft {
        from {
          opacity: 1;
          transform: translateX(0);
        }
        to {
          opacity: 0;
          transform: translateX(-100%);
        }
      }
    `;
    document.head.appendChild(style);

    // Initialize the app
    initialize();
  </script>
</body>
</html> 