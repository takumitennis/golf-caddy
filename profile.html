<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç™»éŒ²</title>
  <style>
    body{font-family:Helvetica,Arial,sans-serif;padding:30px}
    form{max-width:400px;margin:auto}
    label{display:block;margin:12px 0 4px}
    input{width:100%;padding:8px}
    button{margin-top:20px;padding:10px 24px;border:none;border-radius:6px;background:#006aad;color:#fff;cursor:pointer}
  </style>
</head>
<body>
  <h2 id="title">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å…¥åŠ›</h2>
  <form id="profForm"></form>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    /* ==== Supabase åˆæœŸåŒ– ==== */
    const SUPABASE_URL  = "https://vqjxajzaasuqfgvhvxci.supabase.co";
    const SUPABASE_KEY  = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxanhhanphYXN1cWZndmh2eGNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2MjIxMzgsImV4cCI6MjA2OTE5ODEzOH0.NmKwgZA1_-TTvMTQt07QRXtIlR-DPOPATVPuQ3QuO54";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    /* ==== å½¹å‰²åˆ¤å®šï¼ˆ?role=golf or caddyï¼‰ ==== */
    const role  = new URLSearchParams(location.search).get("role") || "caddy";

    const form  = document.getElementById("profForm");
    const title = document.getElementById("title");

    /* ==== é …ç›®å®šç¾© ==== */
    const FIELDS = {
      golf: [
        {id:"name",         label:"ã‚´ãƒ«ãƒ•å ´å"},
        {id:"contact_name", label:"æ‹…å½“è€…å"},
        {id:"phone",        label:"é›»è©±ç•ªå·"},
        {id:"perks",        label:"ã‚­ãƒ£ãƒ‡ã‚£ç‰¹å…¸ï¼ˆä¾‹ï¼šæ‰“ã¡ã£ã±ãªã—ç„¡æ–™ï¼‰"}
      ],
      caddy:[
        {id:"name",        label:"æ°å"},
        {id:"phone",       label:"é›»è©±ç•ªå·"},
        {id:"line_id",     label:"LINE ID"},
        {id:"golf_years",  label:"ã‚´ãƒ«ãƒ•æ­´(å¹´)",  type:"number"},
        {id:"caddy_years", label:"ã‚­ãƒ£ãƒ‡ã‚£æ­´(å¹´)", type:"number"}
      ]
    };

    /* ==== 1. ãƒ•ã‚©ãƒ¼ãƒ æç”» ==== */
    title.textContent = role === "golf" ? "ã‚´ãƒ«ãƒ•å ´ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç™»éŒ²" : "ã‚­ãƒ£ãƒ‡ã‚£ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç™»éŒ²";
    FIELDS[role].forEach(f => {
      form.insertAdjacentHTML("beforeend",
        `<label for="${f.id}">${f.label}</label>
         <input id="${f.id}" type="${f.type||'text'}" required />`);
    });
    form.insertAdjacentHTML("beforeend", `<button type="submit">ç™»éŒ²</button>`);

    /* ==== 2. é€ä¿¡å‡¦ç† ==== */
    form.onsubmit = async e => {
      e.preventDefault();

      const { data: { user } } = await supabase.auth.getUser();
      if (!user) { alert("æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã™"); location.href="/"; return; }

      /* å…¥åŠ›å€¤ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆåŒ– */
      const data = Object.fromEntries(
        FIELDS[role].map(f => [f.id, document.getElementById(f.id).value])
      );
      data.email = user.email;                // ğŸ‘ˆ ã“ã“ã§ãƒ¡ãƒ¼ãƒ«ã‚’è¿½åŠ 

      /* ä¸»ã‚­ãƒ¼ã‚’è‡ªå‹•ç™ºè¡Œï¼ˆg123456 / c123456ï¼‰ */
      if (role === "golf")  data.gID = "g" + user.id.slice(0,6);
      if (role === "caddy") data.cID = "c" + user.id.slice(0,6);

      /* ãƒ†ãƒ¼ãƒ–ãƒ« INSERT */
      const table = role === "golf" ? "golf_courses" : "caddies";
      const { error } = await supabase.from(table).insert(data);
      if (error) { alert(error.message); return; }

      alert("ç™»éŒ²å®Œäº†ï¼");
      location.href = "dashboard.html";
    };
  </script>
</body>
</html>