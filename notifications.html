<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>お知らせ</title>
  <style>
    body{font-family:'Segoe UI',sans-serif;margin:0;background:#f5f6fa;color:#222}
    header{background:#2c3e50;color:#fff;padding:16px 20px;display:flex;align-items:center;gap:12px}
    header h1{margin:0;font-size:1.1rem}
    header a{margin-left:auto;color:#fff;text-decoration:none;opacity:.9}
    .container{max-width:900px;margin:18px auto;padding:0 16px}
    .card{background:#fff;border-radius:10px;padding:16px;margin:12px 0;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .title{font-weight:700;margin:0 0 6px}
    .meta{font-size:.85rem;color:#777;margin-bottom:8px}
    .empty{color:#888;text-align:center;margin-top:32px}
    .toolbar{display:flex;gap:8px;align-items:center;margin:8px 0 16px}
    .toolbar button{border:1px solid #ddd;background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <h1>お知らせ</h1>
    <a href="/">ホームへ</a>
  </header>
  <div class="container">
    <div class="toolbar">
      <span id="userRole" style="font-size:.9rem;color:#666">読み込み中...</span>
      <button id="markReadBtn">すべて既読にする</button>
    </div>
    <div id="list"></div>
    <div id="empty" class="empty" style="display:none;">お知らせはまだありません</div>
  </div>

  <script>
    const supabase = window.supabase.createClient(
      "https://vqjxajzaasuqfgvhvxci.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxanhhanphYXN1cWZndmh2eGNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2MjIxMzgsImV4cCI6MjA2OTE5ODEzOH0.NmKwgZA1_-TTvMTQt07QRXtIlR-DPOPATVPuQ3QuO54"
    );

    let role = 'guest';
    const lastSeenKey = (r)=>`ann_last_seen_${r}`;

    async function loadAnnouncements(){
      const list = document.getElementById('list');
      const empty = document.getElementById('empty');
      list.innerHTML = '';
      const { data: { user } } = await supabase.auth.getUser();
      role = user?.user_metadata?.role || 'guest';
      document.getElementById('userRole').textContent = `ロール: ${role}`;

      const { data, error } = await supabase
        .from('announcements')
        .select('id,title,content,created_at,audience')
        .or(`audience.eq.all,audience.eq.${role}`)
        .order('created_at', { ascending: false })
        .limit(50);
      if (error){
        list.innerHTML = `<div class="card">読み込みエラー: ${error.message}<br><br>
        まだテーブルがないようです。SupabaseのSQLで次を実行してください:<pre style='white-space:pre-wrap;'>
CREATE TABLE IF NOT EXISTS public.announcements (
  id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
  title text NOT NULL,
  content text NOT NULL,
  audience text NOT NULL CHECK (audience IN ('all','golf','caddy')),
  created_at timestamptz NOT NULL DEFAULT now()
);
ALTER TABLE public.announcements ENABLE ROW LEVEL SECURITY;
CREATE POLICY ann_read_all ON public.announcements FOR SELECT USING (true);
-- 例: INSERT INTO public.announcements (title, content, audience) VALUES ('アップデート','新機能を公開しました','all');
</pre></div>`;
        return;
      }
      if (!data || data.length === 0){ empty.style.display='block'; return; }
      empty.style.display='none';
      data.forEach(a=>{
        const d = new Date(a.created_at);
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="title">${a.title || 'お知らせ'}</div>
          <div class="meta">${d.toLocaleString()} / 対象: ${a.audience}</div>
          <div>${(a.content || '').replace(/\n/g,'<br>')}</div>
        `;
        list.appendChild(card);
      });

      // 既読に更新（最新のcreated_atを保存）
      if (data[0]?.created_at){
        localStorage.setItem(lastSeenKey(role), data[0].created_at);
      }
    }

    document.getElementById('markReadBtn').onclick = ()=>{
      const latest = document.querySelector('#list .card .meta')?.textContent || '';
      // すでにload時に更新しているため、ここでは単に現在時刻を保存
      localStorage.setItem(lastSeenKey(role), new Date().toISOString());
      alert('既読にしました。');
    };

    loadAnnouncements();
  </script>
</body>
  
</html>


