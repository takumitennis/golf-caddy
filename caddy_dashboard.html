<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Caddy Dashboard</title>
  <style>
    :root {
      --primary-color: #2f8f2f;
      --primary-dark: #1e5f1e;
      --primary-light: #4caf50;
      --secondary-color: #ffffff;
      --accent-color: #ff6b35;
      --text-color: #333333;
      --text-light: #666666;
      --bg-light: #f8f9fa;
      --bg-dark: #2c3e50;
      --border-radius: 12px;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      --shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.15);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Helvetica Neue", Arial, "Hiragino Sans", "Yu Gothic", "Meiryo", sans-serif;
      background: var(--bg-light);
      color: var(--text-color);
      line-height: 1.6;
    }

    /* Header */
    h1 {
      margin: 0;
      padding: 1.5rem 2rem;
      background: linear-gradient(135deg, var(--bg-dark), #34495e);
      color: #fff;
      font-size: 1.6rem;
      font-weight: 600;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }

    h1::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
    }

    /* Main Navigation */
    .tabs-main {
      display: flex;
      gap: 0.5rem;
      padding: 0 2rem;
      background: #ecf0f1;
      border-bottom: 1px solid #ddd;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .tabs-main button {
      background: #ecf0f1;
      border: none;
      padding: 1rem 1.5rem;
      font-weight: 600;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      transition: var(--transition);
      font-size: 0.95rem;
      color: var(--text-light);
      position: relative;
      overflow: hidden;
    }

    .tabs-main button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s;
    }

    .tabs-main button:hover::before {
      left: 100%;
    }

    .tabs-main button.active {
      border-color: var(--primary-color);
      background: #fff;
      border-radius: var(--border-radius) var(--border-radius) 0 0;
      color: var(--primary-color);
      font-weight: bold;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
    }

    .tabs-main button:hover {
      background: #fff;
      transform: translateY(-1px);
    }

    #logoutBtn {
      margin-left: auto;
      background: #e74c3c;
      color: white;
      border-radius: var(--border-radius);
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      transition: var(--transition);
    }

    #logoutBtn:hover {
      background: #c0392b;
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    /* Container */
    .container {
      padding: 2rem;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Welcome Message */
    #welcome {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      padding: 1.5rem 2rem;
      border-radius: var(--border-radius);
      margin: 1rem 2rem;
      box-shadow: var(--shadow);
      text-align: center;
      font-size: 1.1rem;
      font-weight: 500;
    }

    /* Tab Content */
    .hidden {
      display: none;
    }

    /* Cards */
    .card {
      background: #fff;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 2rem;
      margin-bottom: 2rem;
      border: 1px solid rgba(0,0,0,0.05);
      transition: var(--transition);
    }

    .card:hover {
      box-shadow: var(--shadow-hover);
      transform: translateY(-2px);
    }

    .card h3 {
      color: var(--primary-color);
      margin-bottom: 1rem;
      font-size: 1.3rem;
      font-weight: 600;
    }

    /* Shift Management */
    #mainShift {
      padding: 2rem;
    }

    #lockInfo {
      background: #f8d7da;
      color: #721c24;
      padding: 1rem;
      border-radius: var(--border-radius);
      margin-bottom: 1rem;
      border: 1px solid #f5c6cb;
      font-weight: 500;
    }

    .calendar-nav {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
      background: #fff;
      padding: 1rem;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
    }

    .calendar-nav button {
      padding: 0.5rem 1rem;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition);
      font-weight: 600;
    }

    .calendar-nav button:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .calendar-nav span {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-color);
    }

    /* Calendar */
    .calendar {
      background: #fff;
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      width: 100%;
      border-collapse: collapse;
    }

    .calendar th, .calendar td {
      width: 14%;
      padding: 1rem 0.5rem;
      text-align: center;
      border: 1px solid #e1e8ed;
      transition: var(--transition);
    }

    .calendar th {
      background: var(--primary-color);
      color: white;
      font-weight: 600;
    }

    .cal-ok {
      background: #ffffff;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .cal-ok::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 20px;
      height: 20px;
      border: 2px solid var(--primary-color);
      border-radius: 50%;
      transition: var(--transition);
    }

    .cal-ok:hover {
      background: #f8f9fa;
      transform: scale(1.05);
    }

    .cal-ng {
      background: #eeeeee;
      cursor: pointer;
      position: relative;
    }

    .cal-ng::before {
      content: 'âŒ';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 14px;
      color: #dc3545;
    }

    .cal-ng:hover {
      background: #f8f9fa;
      transform: scale(1.05);
    }

    .locked {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .locked:hover {
      transform: none !important;
    }

    /* Confirm Button */
    #confirmShiftBtn {
      margin-top: 1rem;
      padding: 1rem 2rem;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      font-size: 1rem;
    }

    #confirmShiftBtn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    #confirmShiftBtn:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
    }

    /* Messages */
    .message-item {
      background: #f8f9fa;
      border-radius: var(--border-radius);
      padding: 1rem;
      margin-bottom: 1rem;
      border-left: 4px solid var(--primary-color);
      transition: var(--transition);
    }

    .message-item:hover {
      background: #e9ecef;
      transform: translateX(5px);
    }

    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .message-sender {
      font-weight: 600;
      color: var(--primary-color);
    }

    .message-date {
      color: var(--text-light);
      font-size: 0.9rem;
    }

    .message-content {
      color: var(--text-color);
      line-height: 1.5;
    }

    /* Message Buttons */
    .message-buttons {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .message-buttons button {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
    }

    .message-buttons button.active {
      background: var(--primary-color);
      color: white;
    }

    .message-buttons button:not(.active) {
      background: #ecf0f1;
      color: var(--text-color);
    }

    .message-buttons button:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .modal-content {
      background: #fff;
      padding: 2rem;
      border-radius: var(--border-radius);
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-hover);
    }

    .modal h3 {
      color: var(--primary-color);
      margin-bottom: 1.5rem;
      font-size: 1.3rem;
    }

    .modal label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--text-color);
    }

    .modal select,
    .modal input,
    .modal textarea {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 1rem;
      border: 2px solid #e1e8ed;
      border-radius: var(--border-radius);
      font-size: 1rem;
      transition: var(--transition);
    }

    .modal select:focus,
    .modal input:focus,
    .modal textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(47, 143, 47, 0.1);
    }

         .modal-buttons {
       display: flex;
       gap: 1rem;
       justify-content: flex-end;
       margin-top: 1.5rem;
       padding-top: 1rem;
       border-top: 1px solid #e1e8ed;
       position: sticky;
       bottom: 0;
       background: #fff;
     }

    .modal-buttons button {
      padding: 0.75rem 1.5rem;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
    }

    .modal-buttons button.cancel {
      background: #f0f0f0;
      color: var(--text-color);
      border: 1px solid #ccc;
    }

    .modal-buttons button.send {
      background: var(--primary-color);
      color: white;
      border: none;
    }

    .modal-buttons button:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    /* Status and History */
    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-top: 1rem;
    }

    .status-card {
      background: #fff;
      padding: 1.5rem;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      text-align: center;
      transition: var(--transition);
    }

    .status-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    .status-number {
      font-size: 2rem;
      font-weight: bold;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }

    .status-label {
      color: var(--text-light);
      font-size: 0.9rem;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .tabs-main {
        flex-direction: column;
        padding: 1rem;
      }

      .tabs-main button {
        width: 100%;
        text-align: center;
        border-radius: var(--border-radius);
        margin-bottom: 0.5rem;
      }

      .tabs-main button.active {
        border-radius: var(--border-radius);
      }

      #mainShift {
        padding: 1rem;
      }

      .calendar-nav {
        flex-direction: column;
        gap: 0.5rem;
      }

      .calendar th, .calendar td {
        padding: 0.5rem 0.25rem;
        font-size: 0.9rem;
      }

      .message-buttons {
        flex-direction: column;
      }

      .modal-content {
        width: 95%;
        padding: 1.5rem;
      }

      .modal-buttons {
        flex-direction: column;
      }

      .status-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Loading Animation */
    .loading {
      opacity: 0;
      transform: translateY(20px);
      transition: var(--transition);
    }

    .loading.loaded {
      opacity: 1;
      transform: translateY(0);
    }

    /* Success/Error Messages */
    .message {
      padding: 1rem 1.5rem;
      border-radius: var(--border-radius);
      margin-bottom: 1rem;
      font-weight: 500;
    }

    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .message.info {
      background: #cce5ff;
      color: #004085;
      border: 1px solid #b8daff;
    }

    /* Profile Edit Form Styles */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--text-color);
    }

    .form-group input[type="text"],
    .form-group input[type="date"],
    .form-group input[type="number"],
    .form-group input[type="tel"],
    .form-group input[type="file"] {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e1e8ed;
      border-radius: var(--border-radius);
      font-size: 1rem;
      transition: var(--transition);
    }

    .form-group input[type="text"]:focus,
    .form-group input[type="date"]:focus,
    .form-group input[type="number"]:focus,
    .form-group input[type="tel"]:focus,
    .form-group input[type="file"]:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(47, 143, 47, 0.1);
    }

    .form-group textarea {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e1e8ed;
      border-radius: var(--border-radius);
      font-size: 1rem;
      transition: var(--transition);
    }

    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(47, 143, 47, 0.1);
    }

         .avatar-upload {
       display: flex;
       flex-direction: column;
       align-items: center;
       gap: 1rem;
       margin-bottom: 1.5rem;
       padding: 1rem;
       border: 2px dashed #e1e8ed;
       border-radius: var(--border-radius);
       background: #f8f9fa;
     }

     .avatar-upload img {
       border: 2px solid #e1e8ed;
       border-radius: 50%;
       box-shadow: var(--shadow);
     }

    .upload-btn {
      padding: 0.75rem 1.5rem;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
    }

         .upload-btn:hover {
       background: var(--primary-dark);
       transform: translateY(-1px);
       box-shadow: var(--shadow);
     }

     /* Profile Display Styles */
     .profile-display {
       display: flex;
       flex-direction: column;
       gap: 2rem;
     }

     .profile-header {
       display: flex;
       align-items: center;
       gap: 1.5rem;
       padding: 1.5rem;
       background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
       border-radius: var(--border-radius);
       border: 1px solid #e1e8ed;
     }

     .profile-avatar {
       width: 80px;
       height: 80px;
       border-radius: 50%;
       object-fit: cover;
       border: 3px solid var(--primary-color);
       box-shadow: var(--shadow);
     }

     .profile-info {
       flex: 1;
     }

     .profile-info h4 {
       margin: 0 0 0.5rem 0;
       color: var(--primary-color);
       font-size: 1.5rem;
     }

     .profile-info p {
       margin: 0;
       color: var(--text-color);
       opacity: 0.8;
     }

     .edit-btn {
       padding: 0.75rem 1.5rem;
       background: var(--primary-color);
       color: white;
       border: none;
       border-radius: var(--border-radius);
       cursor: pointer;
       font-weight: 600;
       transition: var(--transition);
     }

     .edit-btn:hover {
       background: var(--primary-dark);
       transform: translateY(-1px);
       box-shadow: var(--shadow);
     }

     .profile-details {
       display: grid;
       gap: 1rem;
     }

     .detail-item {
       display: flex;
       padding: 1rem;
       background: white;
       border-radius: var(--border-radius);
       border: 1px solid #e1e8ed;
       transition: var(--transition);
     }

     .detail-item:hover {
       box-shadow: var(--shadow);
       transform: translateY(-1px);
     }

     .detail-label {
       font-weight: 600;
       color: var(--primary-color);
       min-width: 120px;
       margin-right: 1rem;
     }

     .detail-value {
       color: var(--text-color);
       flex: 1;
     }
  </style>
</head>
<body>
  <h1>ğŸŒï¸ ã‚­ãƒ£ãƒ‡ã‚£ãƒã‚¤ãƒšãƒ¼ã‚¸</h1>
  <div class="tabs-main">
    <button id="btnMainProf" class="active">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</button>
    <button id="btnMainShift">ã‚·ãƒ•ãƒˆ</button>
    <button id="btnMainStat">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</button>
    <button id="btnMainHist">å±¥æ­´</button>
    <button id="btnMainMsg">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</button>
    <button id="logoutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
  <div id="welcome" class="loading"></div>
  
  <!-- Profile Tab -->
  <div id="mainProfile" class="container">
    <div class="card loading">
      <h3>ğŸ“‹ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±</h3>
      <div id="profileContent"></div>
    </div>
  </div>

  <!-- Profile Edit Modal -->
  <div id="profileEditModal" class="modal">
    <div class="modal-content">
      <h3>âœï¸ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</h3>
      <form id="profileForm">
                 <div class="form-group">
           <label>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ</label>
           <div class="avatar-upload">
             <img id="avatarPreview" src="https://placehold.co/100x100" alt="ã‚¢ãƒã‚¿ãƒ¼" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover;">
             <input type="file" id="avatarInput" accept="image/*" style="display: none;">
             <button type="button" id="uploadAvatarBtn" class="upload-btn">ç”»åƒã‚’é¸æŠ</button>
             <small style="color: #6c757d; font-size: 0.875rem;">JPG, PNGå½¢å¼ã€5MBä»¥ä¸‹</small>
           </div>
         </div>
        
        <div class="form-group">
          <label>æ°å *</label>
          <input type="text" id="profileName" required>
        </div>
        
        <div class="form-group">
          <label>ç”Ÿå¹´æœˆæ—¥</label>
          <input type="date" id="profileBirth">
        </div>
        
        <div class="form-group">
          <label>é›»è©±ç•ªå·</label>
          <input type="tel" id="profilePhone">
        </div>
        
        <div class="form-group">
          <label>æ‰€å±å¤§å­¦</label>
          <input type="text" id="profileUniversity">
        </div>
        
        <div class="form-group">
          <label>ã‚´ãƒ«ãƒ•æ­´ (å¹´)</label>
          <input type="number" id="profileGolfYears" min="0" value="0">
        </div>
        
        <div class="form-group">
          <label>ã‚­ãƒ£ãƒ‡ã‚£æ­´ (å¹´)</label>
          <input type="number" id="profileCaddyYears" min="0" value="0">
        </div>
        
                 <div class="form-group">
           <label>ã‚¢ãƒ”ãƒ¼ãƒ«ãƒã‚¤ãƒ³ãƒˆ</label>
           <textarea id="profileAppeal" rows="4" placeholder="è‡ªåˆ†ã®å¼·ã¿ã‚„ç‰¹å¾´ã‚’ã‚¢ãƒ”ãƒ¼ãƒ«ã—ã¦ãã ã•ã„..." style="resize: vertical; min-height: 100px;"></textarea>
           <small style="color: #6c757d; font-size: 0.875rem;">è‡ªåˆ†ã®çµŒé¨“ã‚„å¼·ã¿ã‚’å…·ä½“çš„ã«æ›¸ã„ã¦ãã ã•ã„</small>
         </div>
        
        <div class="modal-buttons">
          <button type="button" id="cancelProfileEdit" class="cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="submit" class="send">ä¿å­˜</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Shift Tab -->
  <div id="mainShift" class="hidden">
    <div id="lockInfo" class="loading"></div>
    <div class="calendar-nav">
      <button id="prevMonth">â—€ å‰æœˆ</button>
      <span id="calTitle"></span>
      <button id="nextMonth">æ¬¡æœˆ â–¶</button>
    </div>
    <div class="card loading">
      <h3>ğŸ“… ã‚·ãƒ•ãƒˆç®¡ç†</h3>
      <table class="calendar" id="calTable"></table>
      <div style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: var(--border-radius);">
        <small><strong>å‡¡ä¾‹:</strong> â—‹ = ç©ºãã‚ã‚Š / âŒ = ç©ºããªã—ï¼ˆã‚»ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã§åˆ‡æ›¿ãƒ»ç·¨é›†ç· åˆ‡ã¯å‰æœˆ15æ—¥ï¼‰</small>
      </div>
      <button id="confirmShiftBtn">ã‚·ãƒ•ãƒˆã‚’ç¢ºå®šã™ã‚‹</button>
    </div>
  </div>

  <!-- Status Tab -->
  <div id="mainStatus" class="hidden container">
    <div class="card loading">
      <h3>ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3>
      <div class="status-grid">
        <div class="status-card">
          <div class="status-number" id="totalShifts">0</div>
          <div class="status-label">ä»Šæœˆã®å‹¤å‹™å›æ•°</div>
        </div>
        <div class="status-card">
          <div class="status-number" id="totalHours">0</div>
          <div class="status-label">ä»Šæœˆã®å‹¤å‹™æ™‚é–“</div>
        </div>
        <div class="status-card">
          <div class="status-number" id="avgRating">0.0</div>
          <div class="status-label">å¹³å‡è©•ä¾¡</div>
        </div>
        <div class="status-card">
          <div class="status-number" id="activeBookings">0</div>
          <div class="status-label">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªäºˆç´„</div>
        </div>
      </div>
    </div>
  </div>

  <!-- History Tab -->
  <div id="mainHistory" class="hidden container">
    <div class="card loading">
      <h3>ğŸ“ˆ å‹¤å‹™å±¥æ­´</h3>
      <div id="historyContent">
        <p style="text-align: center; color: var(--text-light);">å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã¯é–‹ç™ºä¸­ã§ã™</p>
      </div>
    </div>
  </div>

  <!-- Messages Tab -->
  <div id="mainMessages" class="hidden container">
    <div class="card loading">
      <h3>ğŸ’¬ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h3>
      <div class="message-buttons">
        <button id="btnInbox" class="active">å—ä¿¡ãƒœãƒƒã‚¯ã‚¹</button>
        <button id="btnSent">é€ä¿¡æ¸ˆã¿</button>
        <button id="btnNewMessage">æ–°è¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</button>
      </div>
      <div id="messagesList"></div>
    </div>
  </div>
  
  <!-- New Message Modal -->
  <div id="newMessageModal" class="modal">
    <div class="modal-content">
      <h3>âœ‰ï¸ æ–°è¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h3>
      <div>
        <label>é€ä¿¡å…ˆ:</label>
        <select id="messageReceiver">
          <option value="">é€ä¿¡å…ˆã‚’é¸æŠ</option>
        </select>
      </div>
      <div>
        <label>ä»¶å:</label>
        <input type="text" id="messageSubject">
      </div>
      <div>
        <label>å†…å®¹:</label>
        <textarea id="messageContent" rows="5"></textarea>
      </div>
      <div class="modal-buttons">
        <button id="cancelMessage" class="cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button id="sendMessage" class="send">é€ä¿¡</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabase = window.supabase.createClient(
      "https://vqjxajzaasuqfgvhvxci.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxanhhanphYXN1cWZndmh2eGNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2MjIxMzgsImV4cCI6MjA2OTE5ODEzOH0.NmKwgZA1_-TTvMTQt07QRXtIlR-DPOPATVPuQ3QuO54"
    );

    let cid;
    let calMonth = new Date().getMonth(), calYear = new Date().getFullYear();
    const calTable = document.getElementById('calTable');
    const lockInfo = document.getElementById('lockInfo');

    // Loading animation
    const observerOptions = {
      threshold: 0.1,
      rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver(function(entries) {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('loaded');
        }
      });
    }, observerOptions);

    // Observe all loading elements
    document.querySelectorAll('.loading').forEach(el => {
      observer.observe(el);
    });

    // Authentication check
    supabase.auth.getUser().then(async ({ data }) => {
      if (!data.user) {
        location.href = "/";
        return;
      }
      const role = data.user.user_metadata?.role;
      if (role !== "caddy") {
        location.href = "dashboard.html";
        return;
      }

      // Get caddy ID
      const { data: caddy } = await supabase
        .from('caddies')
        .select('cid, name')
        .eq('email', data.user.email)
        .single();

      if (caddy) {
        cid = caddy.cid;
        document.getElementById('welcome').textContent = `ã‚ˆã†ã“ãã€${caddy.name}æ§˜ï¼`;
        loadData();
      }
    });

    // Tab switching
    document.getElementById('btnMainProf').addEventListener('click', () => switchTab('mainProfile'));
    document.getElementById('btnMainShift').addEventListener('click', () => switchTab('mainShift'));
    document.getElementById('btnMainStat').addEventListener('click', () => switchTab('mainStatus'));
    document.getElementById('btnMainHist').addEventListener('click', () => switchTab('mainHistory'));
    document.getElementById('btnMainMsg').addEventListener('click', () => switchTab('mainMessages'));

    // Profile edit modal event handlers
    document.getElementById('uploadAvatarBtn').addEventListener('click', () => {
      document.getElementById('avatarInput').click();
    });

    document.getElementById('avatarInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById('avatarPreview').src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    document.getElementById('cancelProfileEdit').addEventListener('click', () => {
      document.getElementById('profileEditModal').style.display = 'none';
    });

    document.getElementById('profileForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = {
        name: document.getElementById('profileName').value,
        birth_date: document.getElementById('profileBirth').value,
        phone: document.getElementById('profilePhone').value,
        university: document.getElementById('profileUniversity').value,
        golf_years: document.getElementById('profileGolfYears').value,
        caddy_years: document.getElementById('profileCaddyYears').value,
        appeal: document.getElementById('profileAppeal').value
      };

      // Upload avatar if selected
      const avatarFile = document.getElementById('avatarInput').files[0];
      if (avatarFile) {
        console.log('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±:', {
          name: avatarFile.name,
          size: avatarFile.size,
          type: avatarFile.type
        });
        await uploadAvatar(avatarFile);
      }

      // Save profile data
      await saveProfile(formData);
    });

    // ãƒ‡ãƒãƒƒã‚°ç”¨: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒã‚±ãƒƒãƒˆã®ç¢ºèª
    async function checkStorageBuckets() {
      try {
        const { data: buckets, error } = await supabase.storage.listBuckets();
        if (error) {
          console.error('ãƒã‚±ãƒƒãƒˆä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          return;
        }
        console.log('åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒã‚±ãƒƒãƒˆ:', buckets);
        
        const avatarsBucket = buckets.find(bucket => bucket.name === 'avatars');
        if (avatarsBucket) {
          console.log('avatarsãƒã‚±ãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:', avatarsBucket);
        } else {
          console.warn('avatarsãƒã‚±ãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚');
        }
      } catch (error) {
        console.error('ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒã‚±ãƒƒãƒˆã‚’ç¢ºèª
    checkStorageBuckets();

    function switchTab(tabName) {
      document.querySelectorAll('.tabs-main button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('[id^="main"]').forEach(div => div.classList.add('hidden'));
      
      event.target.classList.add('active');
      document.getElementById(tabName).classList.remove('hidden');
    }

    // Load initial data
    function loadData() {
      loadProfile();
      loadCalendar();
      loadStatus();
    }

    // Profile management
    async function loadProfile() {
      const { data } = await supabase
        .from('caddies')
        .select('*')
        .eq('cid', cid)
        .single();

      if (data) {
        const profileContent = document.getElementById('profileContent');
        profileContent.innerHTML = `
          <div class="profile-display">
            <div class="profile-header">
              <img src="${data.avatar_url || 'https://placehold.co/100x100'}" alt="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ" class="profile-avatar">
              <div class="profile-info">
                <h4>${data.name}</h4>
                <p>${data.email}</p>
              </div>
              <button id="editProfileBtn" class="edit-btn">ç·¨é›†</button>
            </div>
            <div class="profile-details">
              <div class="detail-item">
                <span class="detail-label">é›»è©±ç•ªå·:</span>
                <span class="detail-value">${data.phone || 'æœªè¨­å®š'}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">æ‰€å±å¤§å­¦:</span>
                <span class="detail-value">${data.university || 'æœªè¨­å®š'}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">ã‚´ãƒ«ãƒ•æ­´:</span>
                <span class="detail-value">${data.golf_years || 0}å¹´</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">ã‚­ãƒ£ãƒ‡ã‚£æ­´:</span>
                <span class="detail-value">${data.caddy_years || 0}å¹´</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">ã‚¢ãƒ”ãƒ¼ãƒ«ãƒã‚¤ãƒ³ãƒˆ:</span>
                <span class="detail-value">${data.appeal || 'æœªè¨­å®š'}</span>
              </div>
            </div>
          </div>
        `;

        // Add edit button event listener
        document.getElementById('editProfileBtn').addEventListener('click', () => {
          showProfileEditModal(data);
        });
      }
    }

    // Show profile edit modal
    function showProfileEditModal(data) {
      // Populate form with current data
      document.getElementById('profileName').value = data.name || '';
      document.getElementById('profileBirth').value = data.birth_date || '';
      document.getElementById('profilePhone').value = data.phone || '';
      document.getElementById('profileUniversity').value = data.university || '';
      document.getElementById('profileGolfYears').value = data.golf_years || 0;
      document.getElementById('profileCaddyYears').value = data.caddy_years || 0;
      document.getElementById('profileAppeal').value = data.appeal || '';
      
      // Set avatar preview
      const avatarPreview = document.getElementById('avatarPreview');
      avatarPreview.src = data.avatar_url || 'https://placehold.co/100x100';
      
      // Show modal
      document.getElementById('profileEditModal').style.display = 'flex';
    }

    // Save profile
    async function saveProfile(formData) {
      try {
        const { error } = await supabase
          .from('caddies')
          .update({
            name: formData.name,
            birth_date: formData.birth_date || null,
            phone: formData.phone,
            university: formData.university,
            golf_years: parseInt(formData.golf_years) || 0,
            caddy_years: parseInt(formData.caddy_years) || 0,
            appeal: formData.appeal
          })
          .eq('cid', cid);

        if (error) throw error;

        showMessage('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼', 'success');
        document.getElementById('profileEditModal').style.display = 'none';
        loadProfile(); // Reload profile display
      } catch (error) {
        showMessage('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
      }
    }

    // Upload avatar
    async function uploadAvatar(file) {
      try {
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ5MBåˆ¶é™ï¼‰
        if (file.size > 5 * 1024 * 1024) {
          throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯5MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„');
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãƒã‚§ãƒƒã‚¯
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
        if (!allowedTypes.includes(file.type)) {
          throw new Error('JPGã€PNGã€GIFå½¢å¼ã®ç”»åƒã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã§ã™');
        }

        const fileExt = file.name.split('.').pop().toLowerCase();
        const fileName = `${cid}_${Date.now()}.${fileExt}`;
        const filePath = `avatars/${fileName}`;

        // ã¾ãšãƒã‚±ãƒƒãƒˆã®å­˜åœ¨ã‚’ç¢ºèª
        const { data: buckets, error: bucketsError } = await supabase.storage.listBuckets();
        if (bucketsError) {
          console.error('ãƒã‚±ãƒƒãƒˆä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', bucketsError);
          throw new Error('ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„');
        }

        const avatarsBucket = buckets.find(bucket => bucket.name === 'avatars');
        if (!avatarsBucket) {
          throw new Error('ã€Œavatarsã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒã‚±ãƒƒãƒˆãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚');
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        const { error: uploadError } = await supabase.storage
          .from('avatars')
          .upload(filePath, file, {
            cacheControl: '3600',
            upsert: false
          });

        if (uploadError) {
          console.error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', uploadError);
          if (uploadError.message.includes('Bucket not found')) {
            throw new Error('ã€Œavatarsã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒã‚±ãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚');
          }
          throw uploadError;
        }

        // å…¬é–‹URLã‚’å–å¾—
        const { data: { publicUrl } } = supabase.storage
          .from('avatars')
          .getPublicUrl(filePath);

        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«avatar_urlã‚’æ›´æ–°
        const { error: updateError } = await supabase
          .from('caddies')
          .update({ avatar_url: publicUrl })
          .eq('cid', cid);

        if (updateError) {
          console.error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', updateError);
          throw new Error('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        showMessage('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã‚’æ›´æ–°ã—ã¾ã—ãŸï¼', 'success');
        return publicUrl;
      } catch (error) {
        console.error('ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
        showMessage('ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
        return null;
      }
    }

    // Show message function
    function showMessage(message, type = 'info') {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = message;
      messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: var(--border-radius);
        color: white;
        font-weight: 600;
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
        max-width: 300px;
      `;

      // Set background color based on type
      switch (type) {
        case 'success':
          messageDiv.style.background = '#28a745';
          break;
        case 'error':
          messageDiv.style.background = '#dc3545';
          break;
        case 'info':
        default:
          messageDiv.style.background = '#17a2b8';
          break;
      }

      document.body.appendChild(messageDiv);

      // Remove message after 3 seconds
      setTimeout(() => {
        messageDiv.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => {
          if (messageDiv.parentNode) {
            messageDiv.parentNode.removeChild(messageDiv);
          }
        }, 300);
      }, 3000);
    }

    // Add CSS animations for messages
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      
      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }
    `;
    document.head.appendChild(style);

    // Calendar management
    function loadCalendar() {
      const calTitle = document.getElementById('calTitle');
      calTitle.textContent = `${calYear}å¹´${calMonth + 1}æœˆ`;
      
      // Check if editing is locked
      const today = new Date();
      const lockDate = new Date(calYear, calMonth - 1, 15);
      const isLocked = today > lockDate;
      
      if (isLocked) {
        lockInfo.textContent = `âš ï¸ ${calYear}å¹´${calMonth}æœˆã®ã‚·ãƒ•ãƒˆç·¨é›†ã¯ç· ã‚åˆ‡ã‚‰ã‚Œã¦ã„ã¾ã™`;
        lockInfo.style.display = 'block';
      } else {
        lockInfo.style.display = 'none';
      }

      // Generate calendar
      generateCalendar();
    }

    function generateCalendar() {
      const firstDay = new Date(calYear, calMonth, 1);
      const lastDay = new Date(calYear, calMonth + 1, 0);
      const startDate = new Date(firstDay);
      startDate.setDate(startDate.getDate() - firstDay.getDay());

      let html = `
        <thead>
          <tr><th>æ—¥</th><th>æœˆ</th><th>ç«</th><th>æ°´</th><th>æœ¨</th><th>é‡‘</th><th>åœŸ</th></tr>
        </thead>
        <tbody>
      `;

      for (let week = 0; week < 6; week++) {
        html += '<tr>';
        for (let day = 0; day < 7; day++) {
          const currentDate = new Date(startDate);
          currentDate.setDate(startDate.getDate() + week * 7 + day);
          
          const isCurrentMonth = currentDate.getMonth() === calMonth;
          const dayNumber = currentDate.getDate();
          const isToday = currentDate.toDateString() === new Date().toDateString();
          
          let cellClass = '';
          let cellContent = dayNumber;
          
          if (!isCurrentMonth) {
            cellClass = 'locked';
            cellContent = '';
          } else if (isToday) {
            cellClass = 'cal-ok';
            cellContent = `<strong>${dayNumber}</strong>`;
          } else {
            cellClass = 'cal-ok';
          }
          
          html += `<td class="${cellClass}" onclick="toggleAvailability(${dayNumber})">${cellContent}</td>`;
        }
        html += '</tr>';
      }
      
      html += '</tbody>';
      calTable.innerHTML = html;
    }

    function toggleAvailability(day) {
      // Toggle availability logic here
      console.log(`Toggle availability for day ${day}`);
    }

    document.getElementById('prevMonth').addEventListener('click', () => {
      calMonth--;
      if (calMonth < 0) {
        calMonth = 11;
        calYear--;
      }
      loadCalendar();
    });

    document.getElementById('nextMonth').addEventListener('click', () => {
      calMonth++;
      if (calMonth > 11) {
        calMonth = 0;
        calYear++;
      }
      loadCalendar();
    });

    document.getElementById('confirmShiftBtn').addEventListener('click', () => {
      showMessage('ã‚·ãƒ•ãƒˆã‚’ç¢ºå®šã—ã¾ã—ãŸï¼', 'success');
    });

    // Status management
    async function loadStatus() {
      // Load status data
      document.getElementById('totalShifts').textContent = '12';
      document.getElementById('totalHours').textContent = '96';
      document.getElementById('avgRating').textContent = '4.8';
      document.getElementById('activeBookings').textContent = '3';
    }

    // Messages
    document.getElementById('btnInbox').addEventListener('click', () => loadMessages('inbox'));
    document.getElementById('btnSent').addEventListener('click', () => loadMessages('sent'));
    document.getElementById('btnNewMessage').addEventListener('click', () => showNewMessageModal());

    function loadMessages(type) {
      const messagesList = document.getElementById('messagesList');
      
      if (type === 'inbox') {
        messagesList.innerHTML = `
          <div class="message-item">
            <div class="message-header">
              <span class="message-sender">ABCã‚´ãƒ«ãƒ•å ´</span>
              <span class="message-date">2024/01/15</span>
            </div>
            <div class="message-content">
              æ¥é€±ã®ã‚·ãƒ•ãƒˆã«ã¤ã„ã¦ç¢ºèªã•ã›ã¦ã„ãŸã ããŸã„ã®ã§ã™ãŒã€ã”éƒ½åˆã¯ã„ã‹ãŒã§ã—ã‚‡ã†ã‹ï¼Ÿ
            </div>
          </div>
          <div class="message-item">
            <div class="message-header">
              <span class="message-sender">XYZã‚´ãƒ«ãƒ•ã‚¯ãƒ©ãƒ–</span>
              <span class="message-date">2024/01/14</span>
            </div>
            <div class="message-content">
              ç ”ä¿®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®è©³ç´°ã‚’ãŠé€ã‚Šã—ã¾ã™ã€‚ã”ç¢ºèªãã ã•ã„ã€‚
            </div>
          </div>
        `;
      } else {
        messagesList.innerHTML = '<p style="text-align: center; color: var(--text-light);">é€ä¿¡æ¸ˆã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
      }
    }

    function showNewMessageModal() {
      document.getElementById('newMessageModal').style.display = 'flex';
    }

    document.getElementById('cancelMessage').addEventListener('click', () => {
      document.getElementById('newMessageModal').style.display = 'none';
    });

    document.getElementById('sendMessage').addEventListener('click', () => {
      const receiver = document.getElementById('messageReceiver').value;
      const subject = document.getElementById('messageSubject').value;
      const content = document.getElementById('messageContent').value;
      
      if (!receiver || !subject || !content) {
        showMessage('å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      showMessage('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼', 'success');
      document.getElementById('newMessageModal').style.display = 'none';
      document.getElementById('messageReceiver').value = '';
      document.getElementById('messageSubject').value = '';
      document.getElementById('messageContent').value = '';
    });

    // Utility functions
    function showMessage(message, type = 'info') {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = message;
      
      document.body.insertBefore(messageDiv, document.body.firstChild);
      
      setTimeout(() => {
        messageDiv.remove();
      }, 5000);
    }

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await supabase.auth.signOut();
      location.href = '/';
    });
  </script>
</body>
</html> 