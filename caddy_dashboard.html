<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Caddy Dashboard</title>
  <style>
    body{font-family:Helvetica,Arial,sans-serif;padding:20px}
    h1{margin-bottom:20px}
    .calendar th,.calendar td{width:14%;padding:6px;text-align:center;border:1px solid #ccc}
    .cal-ok{background:#ffffff;cursor:pointer}
    .ok-circle{display:inline-block;width:16px;height:16px;border:2px solid #4caf50;border-radius:50%}
    .cal-ng{background:#eeeeee;cursor:pointer}
    .locked{opacity:0.5;cursor:not-allowed}
    .tabs-main button{padding:10px 14px;margin-right:6px;border:none;border-bottom:2px solid transparent;background:#e0e0e0;cursor:pointer;font-size:0.9rem}
    .tabs-main button.active{border-bottom-color:#0077cc;background:#fff}
  </style>
</head>
<body>
  <h1>キャディマイページ</h1>
  <div class="tabs-main">
    <button id="btnMainProf"   class="active">プロフィール</button>
    <button id="btnMainShift">シフト</button>
    <button id="btnMainStat">ステータス</button>
    <button id="btnMainHist">履歴</button>
    <button id="logoutBtn" style="margin-left:auto;">Logout</button>
  </div>
  <div id="welcome" style="margin-top:10px;"></div>
  <div id="mainProfile" style="margin-top:15px;"></div>
  <div id="mainShift" class="hidden">
  <div id="mainStatus" class="hidden" style="margin-top:15px;"></div>
  <div id="mainHistory" class="hidden" style="margin-top:15px;"></div>
  <div id="lockInfo" style="margin:8px 0;color:#d32f2f;"></div>
  <div style="display:flex;align-items:center;gap:10px;">
    <button id="prevMonth">◀</button>
    <span id="calTitle"></span>
    <button id="nextMonth">▶</button>
  </div>
  <table class="calendar" id="calTable" style="margin-top:10px;border-collapse:collapse;width:100%"></table>
  <small>○ = 空きあり / ❌ = 空きなし（セルをクリックで切替・編集締切は前月15日）</small>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabase = window.supabase.createClient(
      "https://vqjxajzaasuqfgvhvxci.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxanhhanphYXN1cWZndmh2eGNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2MjIxMzgsImV4cCI6MjA2OTE5ODEzOH0.NmKwgZA1_-TTvMTQt07QRXtIlR-DPOPATVPuQ3QuO54"
    );

    let cid;
    let calMonth=new Date().getMonth(), calYear=new Date().getFullYear();
    const calTable=document.getElementById('calTable');
    const lockInfo=document.getElementById('lockInfo');

    supabase.auth.getUser().then(async ({ data })=>{
      if(!data.user){location.href="/";return;}
      const role=data.user.user_metadata?.role;
      if(role!=="caddy"){location.href="dashboard.html";return;}
      const { data: row } = await supabase.from('caddies').select('cid,name,avatar_url,birth_date,phone,university,golf_years,caddy_years,appeal,rating,rate,trained_courses').eq('email',data.user.email).single();
      if(!row){alert('プロフィール未登録');location.href='/profile.html?role=caddy';return;}
      cid=row.cid;
      document.getElementById('welcome').textContent=`ようこそ ${row.name} さん`;
      // profile details
      document.getElementById('mainProfile').innerHTML=`
        <div style='display:flex;gap:16px;align-items:center'>
          <img src='${row.avatar_url??"https://placehold.co/100x100"}' style='width:100px;height:100px;border-radius:50%;object-fit:cover;'>
          <h2>${row.name}</h2>
        </div>
        <table style='border-collapse:collapse;width:100%;max-width:480px;margin-top:10px'>
          <tr><th style='text-align:left'>生年月日</th><td>${row.birth_date??"-"}</td></tr>
          <tr><th style='text-align:left'>メール</th><td>${data.user.email}</td></tr>
          <tr><th style='text-align:left'>電話番号</th><td>${row.phone??""}</td></tr>
          <tr><th style='text-align:left'>所属大学</th><td>${row.university??""}</td></tr>
          <tr><th style='text-align:left'>ゴルフ歴</th><td>${row.golf_years??0} 年</td></tr>
          <tr><th style='text-align:left'>キャディ歴</th><td>${row.caddy_years??0} 年</td></tr>
          <tr><th style='text-align:left'>アピール</th><td>${row.appeal??""}</td></tr>
        </table>`;

      // status tab placeholder
      document.getElementById('mainStatus').innerHTML=`
        <p>評価: ${row.rating??0} ⭐️</p>
        <p>キャディ単価: ${row.rate??'-'} 円</p>
        <p>研修済ゴルフ場: ${(row.trained_courses??[]).join(', ')}</p>`;
      renderCal();
    });

    document.getElementById('prevMonth').onclick=()=>{if(--calMonth<0){calMonth=11;calYear--;} renderCal();};
    document.getElementById('nextMonth').onclick=()=>{if(++calMonth>11){calMonth=0;calYear++;} renderCal();};

    async function renderCal(){
      const first=new Date(calYear,calMonth,1);
      const last=new Date(calYear,calMonth+1,0);
      document.getElementById('calTitle').textContent=`${calYear}年 ${calMonth+1}月`;

      // fetch own availability
      const { data, error } = await supabase.from('caddy_availability')
         .select('date')
         .eq('cid', cid)
         .gte('date', first.toISOString().slice(0,10))
         .lte('date', last.toISOString().slice(0,10));
      const availSet=new Set();
      if(!error){ data.forEach(r=>availSet.add(r.date)); }

      // determine lock flag (editing allowed?)
      const deadline=new Date(calYear, calMonth-1, 15); // 前月15日
      const today=new Date();
      const locked = today > deadline;
      lockInfo.textContent= locked? `${calMonth+1}月分の編集締切（前月15日）を過ぎています` : '';

      calTable.innerHTML='';
      const headerRow=document.createElement('tr');
      ['日','月','火','水','木','金','土'].forEach(d=>{const th=document.createElement('th');th.textContent=d;headerRow.appendChild(th);});
      calTable.appendChild(headerRow);
      let row=document.createElement('tr');
      const startWD=first.getDay();
      for(let i=0;i<startWD;i++)row.appendChild(document.createElement('td'));
      for(let day=1;day<=last.getDate();day++){
        const dateStr=`${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const td=document.createElement('td');
        const isAvail=availSet.has(dateStr);
        td.className=isAvail?'cal-ok':'cal-ng';
        td.innerHTML=`<small>${day}</small><br>${isAvail?'<span class="ok-circle"></span>':'❌'}`;
        if(!locked){
          td.onclick=()=>toggle(dateStr,isAvail);
        } else {
          td.classList.add('locked');
        }
        row.appendChild(td);
        if((startWD+day)%7===0){calTable.appendChild(row);row=document.createElement('tr');}
      }
      if(row.children.length){while(row.children.length<7)row.appendChild(document.createElement('td'));calTable.appendChild(row);}  
    }

    async function toggle(dateStr,isAvail){
      if(isAvail){ // delete row
        const { error } = await supabase.from('caddy_availability').delete().eq('cid',cid).eq('date',dateStr);
        if(error){alert(error.message);return;}
      } else {
        const { error } = await supabase.from('caddy_availability').insert({ cid, date: dateStr });
        if(error){alert(error.message);return;}
      }
      renderCal();
    }

    // main tabs
    const mainProf=document.getElementById('mainProfile');
    const mainShift=document.getElementById('mainShift');
    const mainStat=document.getElementById('mainStatus');
    const mainHist=document.getElementById('mainHistory');
    document.getElementById('btnMainProf').onclick=()=>switchMain('prof');
    document.getElementById('btnMainShift').onclick=()=>switchMain('shift');
    document.getElementById('btnMainStat').onclick=()=>switchMain('stat');
    document.getElementById('btnMainHist').onclick=()=>switchMain('hist');
    function switchMain(k){
      [mainProf,mainShift,mainStat,mainHist].forEach(el=>el.classList.add('hidden'));
      btnMainProf.classList.remove('active');btnMainShift.classList.remove('active');btnMainStat.classList.remove('active');btnMainHist.classList.remove('active');
      if(k==='prof'){mainProf.classList.remove('hidden');btnMainProf.classList.add('active');}
      if(k==='shift'){mainShift.classList.remove('hidden');btnMainShift.classList.add('active');}
      if(k==='stat'){mainStat.classList.remove('hidden');btnMainStat.classList.add('active');}
      if(k==='hist'){mainHist.classList.remove('hidden');btnMainHist.classList.add('active');loadHistory();}
    }

    async function loadHistory(){
      const { data, error } = await supabase.from('bookings')
        .select('date,gid,slots,caddy_rate')
        .eq('status','done')
        .contains('caddies', [cid]); // assumes bookings.caddies array
      if(error){console.error(error);return;}
      mainHist.innerHTML='<table style="border-collapse:collapse;width:100%"><thead><tr><th>日付</th><th>ゴルフ場</th><th>単価</th></tr></thead><tbody>'+
        data.map(r=>`<tr><td>${r.date}</td><td>${r.gid}</td><td>${r.caddy_rate??'-'}</td></tr>`).join('')+ '</tbody></table>';
    }
    document.getElementById('logoutBtn').onclick=async()=>{await supabase.auth.signOut();location.href='/';};
  </script>
</body>
</html> 