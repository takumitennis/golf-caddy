<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Caddy Dashboard</title>
  <style>
    body{font-family:Helvetica,Arial,sans-serif;padding:20px; background:#f5f5f5;}
    .container{max-width:1000px; margin:0 auto; background:white; padding:30px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1);}
    h1{margin-bottom:20px; color:#2f8f2f; text-align:center;}
    .welcome{text-align:center; margin-bottom:30px; font-size:1.1em; color:#666;}
    .tabs button{padding:12px 20px;margin-right:8px;border:none;border-bottom:3px solid transparent;background:#eaeaea;cursor:pointer;border-radius:4px 4px 0 0; font-size:14px;}
    .tabs button.active{border-bottom-color:#2f8f2f;background:#fff; color:#2f8f2f; font-weight:bold;}
    .hidden{display:none}
    
    /* Schedule Calendar Styles */
    .calendar-container{margin-top:20px;}
    .calendar-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding:15px; background:#f8f9fa; border-radius:6px;}
    .calendar-title{font-size:1.4em; font-weight:bold; color:#2f8f2f;}
    .calendar-nav{background:#2f8f2f; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer; margin:0 5px;}
    .calendar-nav:hover{background:#237123;}
    
    .calendar{width:100%; border-collapse:collapse; margin-bottom:20px;}
    .calendar th{background:#2f8f2f; color:white; padding:12px; text-align:center; font-weight:bold;}
    .calendar td{
      width:14.28%; 
      height:60px; 
      border:1px solid #ddd; 
      text-align:center; 
      vertical-align:middle; 
      cursor:pointer; 
      position:relative;
      transition:all 0.2s ease;
    }
    .calendar td:hover{background:#f0f8f0;}
    .calendar td.other-month{background:#f8f8f8; color:#ccc;}
    .calendar td.today{background:#fff3cd; border:2px solid #ffc107;}
    
    .day-number{font-weight:bold; margin-bottom:5px;}
    .availability-status{font-size:20px; line-height:1;}
    .available{color:#28a745;}
    .unavailable{color:#dc3545;}
    .not-set{color:#ccc;}
    
    .legend{display:flex; justify-content:center; gap:30px; margin:20px 0; padding:15px; background:#f8f9fa; border-radius:6px;}
    .legend-item{display:flex; align-items:center; gap:8px; font-size:14px;}
    .legend-symbol{font-size:18px; font-weight:bold;}
    
    .save-button{
      background:#2f8f2f; 
      color:white; 
      border:none; 
      padding:12px 30px; 
      border-radius:6px; 
      cursor:pointer; 
      font-size:16px; 
      margin:20px auto; 
      display:block;
    }
    .save-button:hover{background:#237123;}
    .save-button:disabled{background:#ccc; cursor:not-allowed;}
    
    .instructions{
      background:#e8f5e8; 
      border:1px solid #2f8f2f; 
      border-radius:6px; 
      padding:15px; 
      margin-bottom:20px;
      color:#1a5a1a;
    }
    .instructions h3{margin-top:0; color:#2f8f2f;}
    
    .logout-btn{
      position:absolute; 
      top:20px; 
      right:20px; 
      background:#dc3545; 
      color:white; 
      border:none; 
      padding:8px 16px; 
      border-radius:4px; 
      cursor:pointer;
    }
    .logout-btn:hover{background:#c82333;}
  </style>
</head>
<body>
  <button id="logout" class="logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  
  <div class="container">
    <h1>ã‚­ãƒ£ãƒ‡ã‚£ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
    <div id="welcome" class="welcome">Loading...</div>

    <!-- Tabs -->
    <div class="tabs">
      <button id="btnTab1" class="active">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†</button>
      <button id="btnTab2">å¿œå‹Ÿå¯èƒ½ãªå‹Ÿé›†</button>
      <button id="btnTab3">å¿œå‹Ÿå±¥æ­´</button>
    </div>

    <!-- Tab 1: Schedule Management -->
    <div id="tab1">
      <div class="instructions">
        <h3>ğŸ“… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å…¥åŠ›æ–¹æ³•</h3>
        <ul>
          <li>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç©ºãçŠ¶æ³ã‚’è¨­å®šã—ã¦ãã ã•ã„</li>
          <li><span style="color:#28a745; font-size:18px;">âšª</span> = å‹¤å‹™å¯èƒ½ã€€<span style="color:#dc3545; font-size:18px;">âœ–ï¸</span> = å‹¤å‹™ä¸å¯ã€€<span style="color:#ccc; font-size:18px;">ï¼</span> = æœªè¨­å®š</li>
          <li>å¤‰æ›´å¾Œã¯å¿…ãšã€Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</li>
        </ul>
      </div>
      
      <div class="calendar-container">
        <div class="calendar-header">
          <button class="calendar-nav" id="prevMonth">â—€ å‰æœˆ</button>
          <div class="calendar-title" id="calendarTitle">2025å¹´2æœˆ</div>
          <button class="calendar-nav" id="nextMonth">æ¬¡æœˆ â–¶</button>
        </div>
        
        <table class="calendar">
          <thead>
            <tr>
              <th>æ—¥</th><th>æœˆ</th><th>ç«</th><th>æ°´</th><th>æœ¨</th><th>é‡‘</th><th>åœŸ</th>
            </tr>
          </thead>
          <tbody id="calendarBody">
            <!-- Calendar will be generated here -->
          </tbody>
        </table>
        
        <div class="legend">
          <div class="legend-item">
            <span class="legend-symbol available">âšª</span>
            <span>å‹¤å‹™å¯èƒ½</span>
          </div>
          <div class="legend-item">
            <span class="legend-symbol unavailable">âœ–ï¸</span>
            <span>å‹¤å‹™ä¸å¯</span>
          </div>
          <div class="legend-item">
            <span class="legend-symbol not-set">ï¼</span>
            <span>æœªè¨­å®š</span>
          </div>
        </div>
        
        <button class="save-button" id="saveSchedule">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä¿å­˜</button>
      </div>
    </div>

    <!-- Tab 2: Available Bookings (placeholder) -->
    <div id="tab2" class="hidden">
      <h3>å¿œå‹Ÿå¯èƒ½ãªå‹Ÿé›†</h3>
      <p>ã‚´ãƒ«ãƒ•å ´ã‹ã‚‰ã®å‹Ÿé›†ä¸€è¦§ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆå®Ÿè£…äºˆå®šï¼‰</p>
    </div>

    <!-- Tab 3: Application History (placeholder) -->
    <div id="tab3" class="hidden">
      <h3>å¿œå‹Ÿå±¥æ­´</h3>
      <p>éå»ã®å¿œå‹Ÿå±¥æ­´ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆå®Ÿè£…äºˆå®šï¼‰</p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://vqjxajzaasuqfgvhvxci.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxanhhanphYXN1cWZndmh2eGNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2MjIxMzgsImV4cCI6MjA2OTE5ODEzOH0.NmKwgZA1_-TTvMTQt07QRXtIlR-DPOPATVPuQ3QuO54";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let currentDate = new Date();
    let scheduleData = {}; // {YYYY-MM-DD: 'available'|'unavailable'}

    // Tab switching
    document.getElementById('btnTab1').onclick = () => switchTab(1);
    document.getElementById('btnTab2').onclick = () => switchTab(2);
    document.getElementById('btnTab3').onclick = () => switchTab(3);

    function switchTab(tabNum) {
      document.querySelectorAll('.tabs button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('[id^="tab"]').forEach(tab => tab.classList.add('hidden'));
      
      document.getElementById(`btnTab${tabNum}`).classList.add('active');
      document.getElementById(`tab${tabNum}`).classList.remove('hidden');
    }

    // Calendar navigation
    document.getElementById('prevMonth').onclick = () => {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar();
    };

    document.getElementById('nextMonth').onclick = () => {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar();
    };

    // Logout
    document.getElementById('logout').onclick = async () => {
      await supabase.auth.signOut();
      window.location.href = 'index.html';
    };

    // Save schedule
    document.getElementById('saveSchedule').onclick = saveSchedule;

    // Initialize
    async function init() {
      // Check auth
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        window.location.href = 'index.html';
        return;
      }
      
      currentUser = user;
      
      // Get caddy profile
      const { data: caddies } = await supabase
        .from('caddies')
        .select('*')
        .eq('email', user.email)
        .limit(1);
      
      const caddy = caddies && caddies[0];
      document.getElementById('welcome').textContent = 
        caddy ? `ã‚ˆã†ã“ã ${caddy.name} ã•ã‚“` : 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æœªç™»éŒ²ã§ã™';
      
      // Set initial date to next month
      const nextMonth = new Date();
      nextMonth.setMonth(nextMonth.getMonth() + 1);
      currentDate = nextMonth;
      
      await loadSchedule();
      renderCalendar();
    }

    async function loadSchedule() {
      if (!currentUser) return;
      
      const yearMonth = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
      
      const { data } = await supabase
        .from('caddy_availability')
        .select('*')
        .eq('caddy_email', currentUser.email)
        .like('date', `${yearMonth}%`);
      
      scheduleData = {};
      if (data) {
        data.forEach(row => {
          scheduleData[row.date] = row.is_available ? 'available' : 'unavailable';
        });
      }
    }

    async function saveSchedule() {
      if (!currentUser) return;
      
      const saveBtn = document.getElementById('saveSchedule');
      saveBtn.disabled = true;
      saveBtn.textContent = 'ä¿å­˜ä¸­...';
      
      try {
        // Delete existing records for this month
        const yearMonth = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
        await supabase
          .from('caddy_availability')
          .delete()
          .eq('caddy_email', currentUser.email)
          .like('date', `${yearMonth}%`);
        
        // Insert new records
        const records = Object.entries(scheduleData).map(([date, status]) => ({
          caddy_email: currentUser.email,
          date: date,
          is_available: status === 'available'
        }));
        
        if (records.length > 0) {
          const { error } = await supabase
            .from('caddy_availability')
            .insert(records);
          
          if (error) throw error;
        }
        
        alert('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
      } catch (error) {
        console.error('Save error:', error);
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä¿å­˜';
      }
    }

    function renderCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      
      document.getElementById('calendarTitle').textContent = 
        `${year}å¹´${month + 1}æœˆ`;
      
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDate = new Date(firstDay);
      startDate.setDate(startDate.getDate() - firstDay.getDay());
      
      const calendarBody = document.getElementById('calendarBody');
      calendarBody.innerHTML = '';
      
      const today = new Date();
      const currentDateObj = new Date(startDate);
      
      for (let week = 0; week < 6; week++) {
        const row = document.createElement('tr');
        
        for (let day = 0; day < 7; day++) {
          const cell = document.createElement('td');
          const dateStr = formatDate(currentDateObj);
          const isCurrentMonth = currentDateObj.getMonth() === month;
          const isToday = 
            currentDateObj.getFullYear() === today.getFullYear() &&
            currentDateObj.getMonth() === today.getMonth() &&
            currentDateObj.getDate() === today.getDate();
          
          cell.innerHTML = `
            <div class="day-number">${currentDateObj.getDate()}</div>
            <div class="availability-status">${getStatusSymbol(dateStr)}</div>
          `;
          
          if (!isCurrentMonth) {
            cell.classList.add('other-month');
          }
          if (isToday) {
            cell.classList.add('today');
          }
          
          if (isCurrentMonth) {
            cell.onclick = () => toggleAvailability(dateStr, cell);
          }
          
          row.appendChild(cell);
          currentDateObj.setDate(currentDateObj.getDate() + 1);
        }
        
        calendarBody.appendChild(row);
      }
    }

    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function getStatusSymbol(dateStr) {
      const status = scheduleData[dateStr];
      if (status === 'available') return 'âšª';
      if (status === 'unavailable') return 'âœ–ï¸';
      return 'ï¼';
    }

    function toggleAvailability(dateStr, cell) {
      const currentStatus = scheduleData[dateStr];
      let newStatus;
      
      if (currentStatus === 'available') {
        newStatus = 'unavailable';
      } else if (currentStatus === 'unavailable') {
        newStatus = undefined;
      } else {
        newStatus = 'available';
      }
      
      if (newStatus) {
        scheduleData[dateStr] = newStatus;
      } else {
        delete scheduleData[dateStr];
      }
      
      cell.querySelector('.availability-status').textContent = getStatusSymbol(dateStr);
    }

    // Start the app
    init();
  </script>
</body>
</html>