<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Caddy Dashboard</title>
  <style>
    body{font-family:'Segoe UI',sans-serif;margin:0;background:#f5f6fa}
    h1{margin:0;padding:20px 24px;background:#34495e;color:#fff;font-size:1.4rem}
    .container{padding:24px}
    .card{background:#fff;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.08);padding:20px;margin-bottom:24px}
    .tabs-main{
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(2, 1fr);
      gap: 12px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
      margin: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .tabs-main button{
      background: #fff;
      border: 1px solid #e9ecef;
      padding: 16px 12px;
      font-weight: 500;
      font-size: 0.8rem;
      line-height: 1.3;
      border-radius: 12px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .tabs-main button.active{
      background: #27ae60;
      color: #fff;
      border-color: #27ae60;
      box-shadow: 0 4px 12px rgba(39,174,96,0.25);
      transform: translateY(-2px);
    }
    .tabs-main button:hover:not(.active){
      background: #f8f9fa;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.12);
    }
    .tabs-main button.active:hover{
      background: #229954;
      box-shadow: 0 6px 16px rgba(39,174,96,0.3);
    }
    #logoutBtn{
      grid-column: 3;
      grid-row: 2;
      background: #dc3545 !important;
      color: #fff !important;
      border-color: #dc3545 !important;
      box-shadow: 0 2px 4px rgba(220,53,69,0.15) !important;
    }
    #logoutBtn:hover{
      background: #c82333 !important;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(220,53,69,0.25) !important;
    }
    table.calendar{background:#fff;border-radius:6px;overflow:hidden}
    .calendar th,.calendar td{width:14%;padding:6px;text-align:center;border:1px solid #ccc}
    .cal-ok{background:#ffffff;cursor:pointer}
    .ok-circle{display:inline-block;width:16px;height:16px;border:2px solid #4caf50;border-radius:50%}
    .cal-ng{background:#eeeeee;cursor:pointer}
    .cal-booked{background:#e8f5e9;border:2px solid #81c784;cursor:default}
    .locked{opacity:0.5;cursor:not-allowed}
    /* --- LINEé¢¨ãƒãƒ£ãƒƒãƒˆUI --- */
    #mainMessages {
      display: flex;
      flex-direction: column;
      height: 70vh;
      max-height: 600px;
      background: #f7f7f7;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      overflow: hidden;
      position: relative;
    }
    #messagesList {
      flex: 1;
      overflow-y: auto;
      padding: 24px 16px 16px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: #f7f7f7;
    }
    .chat-bubble {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 18px;
      font-size: 1rem;
      line-height: 1.5;
      position: relative;
      word-break: break-word;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
      margin-bottom: 2px;
    }
    .chat-bubble.sent {
      background: #d1f5d3;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    .chat-bubble.received {
      background: #fff;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      border: 1px solid #e0e0e0;
    }
    .chat-meta {
      font-size: 0.8rem;
      color: #888;
      margin-top: 2px;
      text-align: right;
    }
    .chat-meta.received {
      text-align: left;
    }
    #chatInputArea {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      background: #fff;
      border-top: 1px solid #e0e0e0;
      position: absolute;
      left: 0; right: 0; bottom: 0;
    }
    #chatInput {
      flex: 1;
      padding: 10px 14px;
      border-radius: 20px;
      border: 1px solid #ccc;
      font-size: 1rem;
      outline: none;
    }
    #sendChatBtn {
      background: #27ae60;
      color: #fff;
      border: none;
      border-radius: 20px;
      padding: 0 20px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    #sendChatBtn:hover {
      background: #219150;
    }
    /* æ—¢èª­æœªèª­ãƒãƒƒã‚¸ */
    .chat-badge {
      display: inline-block;
      font-size: 0.7rem;
      color: #fff;
      background: #aaa;
      border-radius: 8px;
      padding: 1px 6px;
      margin-left: 6px;
      vertical-align: middle;
    }
    .chat-badge.unread {
      background: #e74c3c;
    }
    .chat-badge.read {
      background: #27ae60;
    }
    /* Utility */
    .hidden{ display:none; }
  </style>
</head>
<body>
  <h1>ã‚­ãƒ£ãƒ‡ã‚£ãƒã‚¤ãƒšãƒ¼ã‚¸<!-- v=2025-08-10-01 --></h1>
  <div class="tabs-main">
    <button id="btnMainProf" class="active">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</button>
    <button id="btnMainShift">ã‚·ãƒ•ãƒˆç·¨é›†</button>
    <button id="btnMainAssign">ã‚­ãƒ£ãƒ‡ã‚£äºˆå®š</button>
    <button id="btnMainLine">LINEè¨­å®š</button>
    <button id="btnMainNotice">ãŠçŸ¥ã‚‰ã›</button>
    <button id="logoutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
  <div id="welcome" style="margin-top:10px;"></div>
  <div id="mainProfile" style="margin-top:15px;"></div>
  <div id="mainShift" class="hidden" style="margin-top:15px;">
    <div id="lockInfo" style="margin:8px 0;color:#d32f2f;display:none;"></div>
    <div style="display:flex;align-items:center;gap:10px;">
      <button id="prevMonth">â—€</button>
      <span id="calTitle"></span>
      <button id="nextMonth">â–¶</button>
    </div>
    <table class="calendar" id="calTable" style="margin-top:10px;border-collapse:collapse;width:100%"></table>
    <div style="display:flex;align-items:center;gap:12px;margin-top:6px;">
      <small>â—‹ = ç©ºãã‚ã‚Š / âŒ = ç©ºããªã—ï¼ˆç·¨é›†ã¯ã€Œã‚·ãƒ•ãƒˆã‚’ç·¨é›†ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ã‹ã‚‰ï¼‰</small>
  </div>
    <div style="margin-top:12px;display:flex;gap:8px;">
      <button id="editShiftBtn" style="padding:8px 16px;">ã‚·ãƒ•ãƒˆã‚’ç·¨é›†ã™ã‚‹</button>
      <button id="saveShiftBtn" style="padding:8px 16px;" disabled>ç¢ºå®šã™ã‚‹</button>
      </div>
    </div>
  <!-- æ–°ã‚¿ãƒ–: ã‚­ãƒ£ãƒ‡ã‚£äºˆå®š -->
  <div id="mainAssigned" class="hidden" style="margin-top:15px;">
    <div style="display:flex;align-items:center;gap:10px;">
      <button id="aPrevMonth">â—€</button>
      <span id="aCalTitle"></span>
      <button id="aNextMonth">â–¶</button>
      
    </div>
    <div style="color:#666; font-size:0.9rem; margin-top:6px;">äºˆç´„ãŒå…¥ã£ã¦ã„ã‚‹æ—¥ã¯ã‚´ãƒ«ãƒ•å ´åãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ï¼‰</div>
    <table class="calendar" id="assignedCalTable" style="margin-top:10px;border-collapse:collapse;width:100%"></table>
  </div>
  
  <!-- ã‚´ãƒ«ãƒ•å ´è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="courseDetailModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:120;">
    <div style="background:#fff; width:92%; max-width:520px; border-radius:10px; padding:16px;">
      <h3 id="cdmName" style="margin:0 0 8px;">ã‚´ãƒ«ãƒ•å ´</h3>
      <img id="cdmImage" src="" alt="course" style="width:100%; max-height:180px; object-fit:cover; border-radius:6px; display:none; margin:6px 0 10px;" />
      <div style="color:#666; font-size:0.9rem; margin-bottom:10px;" id="cdmAddress">ä½æ‰€: æœªè¨­å®š</div>
      <div style="white-space:pre-wrap; background:#f8f9fa; border:1px solid #eee; padding:10px; border-radius:6px; margin-bottom:10px;" id="cdmDescription">èª¬æ˜: æœªè¨­å®š</div>
      <div style="background:#f8fff2; border:1px solid #e3f3d6; padding:10px; border-radius:6px; margin-bottom:12px;" id="cdmPerks">ç‰¹å…¸: ãªã—</div>
      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button id="cdmClose" style="background:#eee; border:1px solid #ddd; border-radius:6px; padding:8px 12px; cursor:pointer;">é–‰ã˜ã‚‹</button>
        <button id="cdmChat" style="background:#27ae60; color:#fff; border:none; border-radius:6px; padding:8px 12px; cursor:pointer;">ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹ã™ã‚‹</button>
      </div>
      </div>
      </div>
      <div id="mainMessages" class="hidden">
      <div id="messagesList"></div>
      <div id="chatInputArea" style="display:none;">
        <input id="chatInput" type="text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." autocomplete="off" />
        <button id="sendChatBtn">é€ä¿¡</button>
      </div>
    </div>
    <!-- LINEé€£æºè¨­å®š -->
    <div id="mainLineSettings" class="hidden" style="margin-top:15px;">
      <div style="background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
        <h3 style="margin:0 0 15px;color:#333;display:flex;align-items:center;gap:8px;">
          ğŸ“± LINEé€šçŸ¥è¨­å®š
        </h3>
        
        <div id="lineNotConnected" style="display:block;">
          <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:15px;">
            <p style="margin:0 0 8px;color:#666;line-height:1.5;">
              ã‚­ãƒ£ãƒ‡ã‚£ç¢ºå®šã‚„ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãªã©ã®é‡è¦ãªé€šçŸ¥ã‚’LINEã§å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
            </p>
            <p style="margin:0;font-size:0.9rem;color:#888;">
              â€» é€šçŸ¥ã‚’å—ã‘å–ã‚‹ã«ã¯ã€ã‚­ãƒ£ãƒ‡ã‚£ãƒ—ãƒ©ã‚¹å…¬å¼LINEã‚’å‹é”è¿½åŠ ã—ã¦é€£æºè¨­å®šã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
            </p>
          </div>
          
          <button id="connectLineBtn" style="background:#00B900;color:white;border:none;padding:12px 24px;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;width:100%;">
            ğŸ¤ LINEé€£æºã‚’è¨­å®šã™ã‚‹
          </button>
        </div>
        
        <div id="lineConnected" style="display:none;">
          <div style="background:#e8f5e8;padding:15px;border-radius:8px;margin-bottom:15px;">
            <p style="margin:0 0 8px;color:#2d5a27;font-weight:600;">
              âœ… LINEé€£æºæ¸ˆã¿
            </p>
            <p style="margin:0;font-size:0.9rem;color:#4a7c59;">
              é‡è¦ãªé€šçŸ¥ã‚’LINEã§å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
            </p>
          </div>
          
          <div style="display:flex;gap:10px;">
            <button id="testLineNotificationBtn" style="background:#3498db;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;flex:1;">
              ãƒ†ã‚¹ãƒˆé€šçŸ¥
            </button>
            <button id="disconnectLineBtn" style="background:#e74c3c;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;flex:1;">
              é€£æºè§£é™¤
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ãŠçŸ¥ã‚‰ã›ï¼ˆé‹å–¶ã‹ã‚‰ï¼‰ -->
    <div id="mainNotice" class="hidden" style="margin-top:15px;">
      <iframe src="notifications.html" style="width:100%;height:70vh;border:1px solid #e0e0e0;border-radius:8px;background:#fff;"></iframe>
    </div>
    
    <!-- äºˆç´„ä¸€è¦§ï¼ˆã‚­ãƒ£ãƒ‡ã‚£äºˆå®šã®ãƒªã‚¹ãƒˆè¡¨ç¤ºç”¨ï¼‰ -->
    <div id="assignedListContainer" class="hidden" style="margin-top:15px;">
      <div style="display:flex;align-items:center;gap:10px;">
        <button id="alPrevMonth" onclick="window.alNav && window.alNav(-1)">â—€</button>
        <span id="alTitle" style="font-weight:600;"></span>
        <button id="alNextMonth" onclick="window.alNav && window.alNav(1)">â–¶</button>
      </div>
      <table style="margin-top:10px; width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="text-align:left; padding:6px; border-bottom:1px solid #eee;">æ—¥ä»˜</th>
            <th style="text-align:left; padding:6px; border-bottom:1px solid #eee;">ã‚´ãƒ«ãƒ•å ´</th>
            <th style="text-align:left; padding:6px; border-bottom:1px solid #eee;">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</th>
          </tr>
        </thead>
        <tbody id="assignedListBody"></tbody>
      </table>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabase = window.supabase.createClient(
      "https://vqjxajzaasuqfgvhvxci.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxanhhanphYXN1cWZndmh2eGNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2MjIxMzgsImV4cCI6MjA2OTE5ODEzOH0.NmKwgZA1_-TTvMTQt07QRXtIlR-DPOPATVPuQ3QuO54"
    );

    let cid;
    let calMonth=new Date().getMonth(), calYear=new Date().getFullYear();
    // ã‚­ãƒ£ãƒ‡ã‚£äºˆå®šç”¨ã®ç‹¬ç«‹ã—ãŸæœˆçŠ¶æ…‹
    let assignedCalMonth = calMonth;
    let assignedCalYear = calYear;
    
    // ã‚­ãƒ£ãƒ‡ã‚£äºˆå®šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ›´æ–°é–¢æ•°ï¼ˆçŠ¶æ…‹ç®¡ç†æ”¹å–„ï¼‰
    function updateAssignedCalendar() {
      console.log('updateAssignedCalendar é–‹å§‹:', { assignedCalYear, assignedCalMonth });
      
      // æœˆã®ç¯„å›²ã‚’æ­£ã—ãè¨ˆç®—
      const first = new Date(assignedCalYear, assignedCalMonth, 1);
      const last = new Date(assignedCalYear, assignedCalMonth + 1, 0);
      
      console.log('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç¯„å›²:', { first, last });
      
      // ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
      const titleElement = document.getElementById('aCalTitle');
      if (titleElement) {
        titleElement.textContent = `${assignedCalYear}å¹´ ${assignedCalMonth + 1}æœˆ`;
      }
      
      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å†æç”»ï¼ˆéåŒæœŸå‡¦ç†ã®ç«¶åˆã‚’é˜²ãï¼‰
      if (window.assignedCalUpdateTimeout) {
        clearTimeout(window.assignedCalUpdateTimeout);
      }
      
      window.assignedCalUpdateTimeout = setTimeout(() => {
        renderAssignedCal(first, last);
      }, 100);
    }
    const calTable=document.getElementById('calTable');
    const pendingInserts = new Set();
    const pendingDeletes = new Set();
    const lockInfo=document.getElementById('lockInfo');

    supabase.auth.getUser().then(async ({ data })=>{
      if(!data.user){location.href="/";return;}
      const role=data.user.user_metadata?.role;
      if(role!=="caddy"){location.href="dashboard.html";return;}
      const { data: row } = await supabase.from('caddies').select('cid,name,avatar_url,birth_date,phone,university,golf_years,caddy_years,appeal,rating,rate,trained_courses').eq('email',data.user.email).single();
      if(!row){
        renderProfileForm();
      } else {
        cid=row.cid;
        renderProfileDisplay(row);
      }
      // æ´¾é£å›æ•°ã‚’å–å¾—ï¼ˆrowãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
      let dispatchCount = 0;
      if (row && row.cid) {
        const { count, error: countError } = await supabase
          .from('booking_caddies')
          .select('*', { count: 'exact', head: true })
          .eq('cid', row.cid);
        
        if (!countError && count !== null) {
          dispatchCount = count;
        }
      }

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¿ãƒ–ã®HTMLã‚’ç”Ÿæˆï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
      if (row && row.cid) {
        const ms1 = document.getElementById('mainStatus');
        if (ms1) ms1.innerHTML = `
          <div class="card">
            <h3>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3>
            <p><strong>ä»Šã¾ã§ã®ã‚­ãƒ£ãƒ‡ã‚£æ´¾é£å›æ•°:</strong> ${dispatchCount} å›</p>
            <p><strong>ç ”ä¿®æ¸ˆã‚´ãƒ«ãƒ•å ´:</strong> ${(row.trained_courses && row.trained_courses.length > 0 ? row.trained_courses.join(', ') : 'ãªã—')}</p>
            <button id='reqTrainingBtn'>ç ”ä¿®ã‚’å¸Œæœ›ã™ã‚‹</button>
          </div>`;
        // ç ”ä¿®å¸Œæœ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã®HTMLã‚’ä¸€åº¦ã ã‘è¿½åŠ 
        if (!document.getElementById('trainModal')) {
          document.body.insertAdjacentHTML('beforeend',`
            <div id='trainModal' style='display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;z-index:100;'>
              <div style='background:#fff;padding:24px;border-radius:8px;width:90%;max-width:500px;'>
                <div id='step1'>
                  <h3>ç ”ä¿®å¸Œæœ›ã‚´ãƒ«ãƒ•å ´é¸æŠ</h3>
                  <select id='courseSelect' style='width:100%;margin-top:12px;padding:8px;font-size:1rem;'></select>
                  <div style='margin-top:20px;text-align:right;'>
                    <button id='cancelModal' style='padding:8px 16px;border:1px solid #ccc;background:#f0f0f0;border-radius:4px;cursor:pointer;'>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button id='nextStep' style='margin-left:10px;padding:8px 16px;border:none;background:#3498db;color:#fff;border-radius:4px;cursor:pointer;'>æ¬¡ã¸</button>
                  </div>
                </div>
                <div id='step2' style='display:none;'>
                  <h3>ç ”ä¿®æ—¥é¸æŠ</h3>
                  <div style='display:flex;align-items:center;gap:10px;margin:12px 0;'>
                    <button id='prevTrainingMonth2'>â—€</button>
                    <span id='trainingCalTitle2'></span>
                    <button id='nextTrainingMonth2'>â–¶</button>
                  </div>
                  <table id='trainingCalTable2' style='width:100%;border-collapse:collapse;'></table>
                  <div id='selectedDateDisplay' style='margin:12px 0;font-weight:bold;'></div>
                  <div style='margin-top:20px;text-align:right;'>
                    <button id='backStep' style='padding:8px 16px;border:1px solid #ccc;background:#f0f0f0;border-radius:4px;cursor:pointer;'>æˆ»ã‚‹</button>
                    <button id='sendReq' style='margin-left:10px;padding:8px 16px;border:none;background:#2ecc71;color:#fff;border-radius:4px;cursor:pointer;' disabled>äºˆç´„é€ä¿¡</button>
                  </div>
                </div>
              </div>
            </div>`);
        }
        const modal = document.getElementById('trainModal');
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å®‰å…¨ã«å·®ã—æ›¿ãˆ
        const oldReqBtn = document.getElementById('reqTrainingBtn');
        const newReqBtn = document.createElement('button');
        newReqBtn.id = 'reqTrainingBtn';
        newReqBtn.textContent = oldReqBtn ? oldReqBtn.textContent : 'ç ”ä¿®ã‚’å¸Œæœ›ã™ã‚‹';
        newReqBtn.style = oldReqBtn ? oldReqBtn.getAttribute('style') : '';
        if (oldReqBtn && oldReqBtn.parentNode){
        oldReqBtn.parentNode.replaceChild(newReqBtn, oldReqBtn);
        } else {
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚«ãƒ¼ãƒ‰å†…ã®æœ«å°¾ã«é…ç½®
          const statusCard = document.getElementById('mainStatus');
          if (statusCard) statusCard.appendChild(newReqBtn);
        }

        // Modal state variables
        let selectedGolfCourse = null;
        let selectedTrainingDate = null;
        let trainingCalMonth2 = new Date().getMonth();
        let trainingCalYear2 = new Date().getFullYear();

      // Step 1: Golf course selection
      newReqBtn.onclick = async () => {
        const { data: courses } = await supabase.from('golf_courses').select('gid,name,email');
        const sel = document.getElementById('courseSelect');
        sel.innerHTML = courses.map(c => `<option value='${c.gid}' data-email='${c.email}' data-name='${c.name}'>${c.name}</option>`).join('');
        
        // Reset modal state
        document.getElementById('step1').style.display = 'block';
        document.getElementById('step2').style.display = 'none';
        selectedGolfCourse = null;
        selectedTrainingDate = null;
        
        modal.style.display = 'flex';
      };

      // Cancel modal
      document.getElementById('cancelModal').onclick = () => modal.style.display = 'none';

      // Next step: Show calendar
      document.getElementById('nextStep').onclick = async () => {
        const sel = document.getElementById('courseSelect');
        selectedGolfCourse = {
          gid: sel.value,
          name: sel.options[sel.selectedIndex].dataset.name,
          email: sel.options[sel.selectedIndex].dataset.email
        };
        
        document.getElementById('step1').style.display = 'none';
        document.getElementById('step2').style.display = 'block';
        
        await renderTrainingCalendar2();
      };

      // Back step
      document.getElementById('backStep').onclick = () => {
        document.getElementById('step2').style.display = 'none';
        document.getElementById('step1').style.display = 'block';
      };

      // Calendar navigation
      document.getElementById('prevTrainingMonth2').onclick = () => {
        if(--trainingCalMonth2 < 0) { trainingCalMonth2 = 11; trainingCalYear2--; }
        renderTrainingCalendar2();
      };
      document.getElementById('nextTrainingMonth2').onclick = () => {
        if(++trainingCalMonth2 > 11) { trainingCalMonth2 = 0; trainingCalYear2++; }
        renderTrainingCalendar2();
      };

      // Send training request
      document.getElementById('sendReq').onclick = async () => {
        if (!selectedGolfCourse || !selectedTrainingDate) {
          alert('ã‚´ãƒ«ãƒ•å ´ã¨æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
          return;
        }
        
        console.log('Sending training request:', {
          cid,
          gid: selectedGolfCourse.gid,
          training_date: selectedTrainingDate,
          status: 'pending'
        });
        
        try {
          // ã¾ãšã€training_requestsãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
          const { data: tableCheck, error: tableError } = await supabase
            .from('training_requests')
            .select('id')
            .limit(1);
          
          console.log('Table check result:', { tableCheck, tableError });
          
          const { data, error } = await supabase.from('training_requests').insert({ 
            cid, 
            gid: selectedGolfCourse.gid, 
            training_date: selectedTrainingDate,
            status: 'pending'
          });
          
          console.log('Training request insert result:', { data, error });
          
          if (error) {
            console.error('Training request insert error:', error);
            throw error;
          }
          
          window.open(`mailto:${selectedGolfCourse.email}?subject=ã‚­ãƒ£ãƒ‡ã‚£ç ”ä¿®å¸Œæœ›&body=ã‚­ãƒ£ãƒ‡ã‚£ID:${cid}%0Aæ°å:${row.name || ''}%0Aå¸Œæœ›ç ”ä¿®æ—¥:${selectedTrainingDate}%0Aç ”ä¿®ã‚’å¸Œæœ›ã—ã¦ã„ã¾ã™ã€‚`);
          alert('ç ”ä¿®å¸Œæœ›ã‚’é€ä¿¡ã—ã¾ã—ãŸ');
          modal.style.display = 'none';
        } catch (error) {
          console.error('Training request error:', error);
          alert('é€ä¿¡ã‚¨ãƒ©ãƒ¼: ' + (error.message || error.toString()));
        }
      };

      // Render training calendar function
      async function renderTrainingCalendar2() {
        const first = new Date(trainingCalYear2, trainingCalMonth2, 1);
        const last = new Date(trainingCalYear2, trainingCalMonth2 + 1, 0);
        document.getElementById('trainingCalTitle2').textContent = `${trainingCalYear2}å¹´ ${trainingCalMonth2 + 1}æœˆ`;
        
        // Fetch available training dates for selected golf course
        const { data: availData, error } = await supabase
          .from('training_availability')
          .select('date')
          .eq('gid', selectedGolfCourse.gid)
          .gte('date', first.toISOString().slice(0,10))
          .lte('date', last.toISOString().slice(0,10));
        
        const availableSet = new Set();
        if (!error && availData) {
          availData.forEach(r => availableSet.add(r.date));
        }
        
        // Build calendar
        const table = document.getElementById('trainingCalTable2');
        table.innerHTML = '';
        const headerRow = document.createElement('tr');
        ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].forEach(d => {
          const th = document.createElement('th');
          th.textContent = d;
          th.style.border = '1px solid #ccc';
          th.style.padding = '4px';
          headerRow.appendChild(th);
        });
        table.appendChild(headerRow);
        
        let row = document.createElement('tr');
        const startWeekDay = first.getDay();
        for(let i = 0; i < startWeekDay; i++){
          row.appendChild(document.createElement('td'));
        }
        
        for(let day = 1; day <= last.getDate(); day++){
          const dateStr = `${trainingCalYear2}-${String(trainingCalMonth2 + 1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
          const td = document.createElement('td');
          const isAvailable = availableSet.has(dateStr);
          const isSelected = selectedTrainingDate === dateStr;
          
          td.innerHTML = `<div style="padding:8px;">${day}</div>`;
          td.style.border = '1px solid #ccc';
          td.style.textAlign = 'center';
          
          if (isSelected) {
            td.style.backgroundColor = '#3498db';
            td.style.color = '#fff';
          } else if (isAvailable) {
            td.style.backgroundColor = '#c8e6c9';
            td.style.cursor = 'pointer';
          } else {
            td.style.backgroundColor = '#ffcdd2';
            td.style.color = '#666';
          }
          
          if (isAvailable) {
            td.onclick = () => {
              selectedTrainingDate = dateStr;
              document.getElementById('selectedDateDisplay').textContent = `é¸æŠæ—¥: ${dateStr}`;
              document.getElementById('sendReq').disabled = false;
              renderTrainingCalendar2(); // Re-render to show selection
            };
          }
          
          row.appendChild(td);
          if((startWeekDay + day) % 7 === 0){
            table.appendChild(row);
            row = document.createElement('tr');
          }
        }
        
        if(row.children.length) {
          while(row.children.length < 7) row.appendChild(document.createElement('td'));
          table.appendChild(row);
        }
      }

      if (typeof initialShowProfile !== 'undefined' && initialShowProfile) {
        switchMain('prof');
        initialShowProfile = false;
              }
      } else {
        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        const ms2 = document.getElementById('mainStatus');
        if (ms2) ms2.innerHTML = `
          <div class="card">
            <h3>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3>
            <p>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç™»éŒ²å¾Œã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
          </div>`;
      }
    });

    const pm = document.getElementById('prevMonth');
    const nm = document.getElementById('nextMonth');
    if (pm) pm.onclick=()=>{ if(--calMonth<0){calMonth=11;calYear--;} renderCal(); };
    if (nm) nm.onclick=()=>{ if(++calMonth>11){calMonth=0;calYear++;} renderCal(); };

    function isMonthLocked(y, m){
      // y: å¹´, m: æœˆ(0-11)ã€‚å¯¾è±¡æœˆã®ç·¨é›†ç· åˆ‡ã¯ã€Œå‰æœˆ15æ—¥ã€
      const deadline = new Date(y, m-1, 15);
      const today = new Date();
      return today > deadline;
    }

    function setInitialEditableMonth(){
      const today = new Date();
      let y = today.getFullYear();
      let m = today.getMonth();
      // ç›´è¿‘ã§ç·¨é›†å¯èƒ½ãªæœˆï¼ˆ12ã‹æœˆå…ˆã¾ã§ã‚’æ¢ç´¢ï¼‰
      for(let i=0;i<12;i++){
        const yy = y + Math.floor((m+i)/12);
        const mm = (m+i)%12;
        if(!isMonthLocked(yy, mm)){
          calYear = yy; calMonth = mm; return;
        }
      }
      // å…¨ã¦ç· åˆ‡æ¸ˆã¿ãªã‚‰ä»Šæœˆã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      calYear = today.getFullYear();
      calMonth = today.getMonth();
    }

    let editMode = false; // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰: trueã®æ™‚ã ã‘ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å¤‰æ›´å¯èƒ½

    async function renderCal(){
      const first=new Date(calYear,calMonth,1);
      const last=new Date(calYear,calMonth+1,0);
      document.getElementById('calTitle').textContent=`${calYear}å¹´ ${calMonth+1}æœˆ`;

      console.log(`=== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»é–‹å§‹ ===`);
      console.log(`æœˆ: ${calYear}å¹´ ${calMonth+1}æœˆ`);
      console.log(`ã‚­ãƒ£ãƒ‡ã‚£ID: ${cid}`);

      // fetch own availability
      const { data, error } = await supabase.from('caddy_availability')
         .select('date')
         .eq('cid', cid)
         .gte('date', first.toISOString().slice(0,10))
         .lte('date', last.toISOString().slice(0,10));
      
      console.log(`ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å–å¾—çµæœ:`, { data, error });
      
      if (error) {
        console.error(`ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å–å¾—ã‚¨ãƒ©ãƒ¼:`, error);
      }
      
      const availSet=new Set();
      if(!error && data){ 
        data.forEach(r=>availSet.add(r.date)); 
        console.log(`å–å¾—ã—ãŸç©ºãæ—¥:`, Array.from(availSet));
      }

      // fetch booked days for current month (bookings joined)
      const { data: assigns } = await supabase
        .from('bookings')
        .select('date, booking_caddies!inner (cid), golf_courses(name)')
        .eq('booking_caddies.cid', cid)
        .gte('date', first.toISOString().slice(0,10))
        .lte('date', last.toISOString().slice(0,10));
      const bookedMap = new Map(); // date -> golf course name
      (assigns||[]).forEach(a=>{ bookedMap.set(a.date, a.golf_courses?.name || 'äºˆç´„'); });

      // å‰æœˆ15æ—¥ç· åˆ‡ãƒ«ãƒ¼ãƒ«ï¼ˆè¡¨ç¤ºä¸Šã¯ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‡ºã•ãªã„ï¼‰
      const locked = isMonthLocked(calYear, calMonth);
      if (lockInfo) { lockInfo.textContent = ''; lockInfo.style.display='none'; }

      calTable.innerHTML='';
      const headerRow=document.createElement('tr');
      ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].forEach(d=>{const th=document.createElement('th');th.textContent=d;headerRow.appendChild(th);});
      calTable.appendChild(headerRow);
      let row=document.createElement('tr');
      const startWD=first.getDay();
      for(let i=0;i<startWD;i++)row.appendChild(document.createElement('td'));
      for(let day=1;day<=last.getDate();day++){
        const dateStr=`${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const td=document.createElement('td');
        const isBooked = bookedMap.has(dateStr);
        const isAvail = availSet.has(dateStr);
        if (isBooked) {
          // äºˆç´„ç¢ºå®šæ—¥ã¯ç·¨é›†å¯¾è±¡ã«ã—ãªã„ã€‚è¡¨ç¤ºã¯ã€Œäºˆå®šç¢ºå®šã€æ–‡å­—
          td.className = 'cal-booked';
          td.innerHTML = `<small>${day}</small><br><span style="color:#2e7d32;font-weight:700;">äºˆå®šç¢ºå®š</span>`;
        } else {
        td.className=isAvail?'cal-ok':'cal-ng';
        td.innerHTML=`<small>${day}</small><br>${isAvail?'<span class="ok-circle"></span>':'âŒ'}`;
          if(editMode && !locked){
          td.onclick=()=>toggle(dateStr,isAvail);
        } else {
          td.classList.add('locked');
          }
        }
        row.appendChild(td);
        if((startWD+day)%7===0){calTable.appendChild(row);row=document.createElement('tr');}
      }
      if(row.children.length){while(row.children.length<7)row.appendChild(document.createElement('td'));calTable.appendChild(row);}  

      // ã€Œã‚­ãƒ£ãƒ‡ã‚£äºˆå®šã€ã‚¿ãƒ–å´ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚‚åŒæœˆã§æ›´æ–°
      if(document.getElementById('mainAssigned')){
        // ã‚­ãƒ£ãƒ‡ã‚£äºˆå®šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æœˆçŠ¶æ…‹ã‚’åŒæœŸ
        assignedCalYear = calYear;
        assignedCalMonth = calMonth;
        
        console.log('ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¨åŒæœŸ:', { calYear, calMonth, assignedCalYear, assignedCalMonth });
        
        const titleElement = document.getElementById('aCalTitle');
        if (titleElement) {
          titleElement.textContent = `${assignedCalYear}å¹´ ${assignedCalMonth+1}æœˆ`;
        }
        
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å†æç”»
        renderAssignedCal(first, last);
      }
    }

    async function toggle(dateStr,isAvail){
      if (!editMode) return; // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§ã¯åå¿œã—ãªã„
      
      console.log(`=== ã‚·ãƒ•ãƒˆç·¨é›†: toggle ===`);
      console.log(`æ—¥ä»˜: ${dateStr}`);
      console.log(`ç¾åœ¨ã®çŠ¶æ…‹: ${isAvail ? 'ç©ºãæ—¥' : 'Ã—'}`);
      console.log(`å¤‰æ›´å¾Œã®çŠ¶æ…‹: ${isAvail ? 'Ã—' : 'ç©ºãæ—¥'}`);
      
      if(isAvail){
        pendingDeletes.add(dateStr);
        pendingInserts.delete(dateStr);
        console.log(`å‰Šé™¤äºˆå®šã«è¿½åŠ : ${dateStr}`);
      } else {
        pendingInserts.add(dateStr);
        pendingDeletes.delete(dateStr);
        console.log(`è¿½åŠ äºˆå®šã«è¿½åŠ : ${dateStr}`);
      }
      
      console.log(`ç¾åœ¨ã®pendingDeletes:`, Array.from(pendingDeletes));
      console.log(`ç¾åœ¨ã®pendingInserts:`, Array.from(pendingInserts));
      
      // è¦‹ãŸç›®ã ã‘å³æ™‚åæ˜ ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã®æš«å®šSetã‚’åŸºã«æç”»ï¼‰
      const cells = calTable.querySelectorAll('td');
      cells.forEach((td)=>{
        const small = td.querySelector('small');
        if(!small) return;
        const day = small.textContent.trim();
        if(!day||isNaN(day)) return;
        const dateStr2=`${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const nowAvail = (dateStr2===dateStr) ? !isAvail : (td.classList.contains('cal-ok'));
        td.className = nowAvail ? 'cal-ok' : 'cal-ng';
        td.innerHTML=`<small>${day}</small><br>${nowAvail?'<span class="ok-circle"></span>':'âŒ'}`;
      });
      
      console.log(`UIæ›´æ–°å®Œäº†`);
    }

    // ã‚­ãƒ£ãƒ‡ã‚£äºˆå®šï¼ˆäºˆç´„ç¢ºå®šåˆ†ï¼‰ã‚’å³å´ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«æç”»
    async function renderAssignedCal(firstDate, lastDate){
      const table = document.getElementById('assignedCalTable');
      table.innerHTML='';
      // è¦‹å‡ºã—
      const headerRow=document.createElement('tr');
      ;['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].forEach(d=>{const th=document.createElement('th');th.textContent=d;headerRow.appendChild(th);});
      table.appendChild(headerRow);

      // äºˆç´„ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆcidã§çµè¾¼ã¿ï¼‰ã€‚æœˆã®ç¯„å›²ã¯JSå´ã§ãƒ•ã‚£ãƒ«ã‚¿
      const { data: assigns, error } = await supabase
        .from('bookings')
        .select(`
          booking_id,
          date,
          gid,
          golf_courses ( gid,name,address,description,perks,image_url ),
          booking_caddies!inner ( cid )
        `)
        .eq('booking_caddies.cid', cid);
      if(error){
        console.warn('äºˆç´„å–å¾—ã‚¨ãƒ©ãƒ¼', error.message);
      }
      const startWD = firstDate.getDay();
      let row=document.createElement('tr');
      for(let i=0;i<startWD;i++)row.appendChild(document.createElement('td'));

      // æ—¥ä»˜æ–‡å­—åˆ—ã®ãŸã‚ã®ç¯„å›²ï¼ˆæ­£ã—ã„æœˆã®ç¯„å›²ã‚’è¨­å®šï¼‰
      const firstStr = `${firstDate.getFullYear()}-${String(firstDate.getMonth() + 1).padStart(2, '0')}-01`;
      const lastStr = `${lastDate.getFullYear()}-${String(lastDate.getMonth() + 1).padStart(2, '0')}-${String(lastDate.getDate()).padStart(2, '0')}`;
      
      console.log('ã‚­ãƒ£ãƒ‡ã‚£äºˆå®šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ - æœˆç¯„å›²:', { firstStr, lastStr, firstDate, lastDate });

      // æ—¥ä»˜â†’äºˆç´„ã®ãƒãƒƒãƒ—ï¼ˆè¡¨ç¤ºã•ã‚Œã‚‹äºˆå®šã®ã¿ï¼‰
      const dateToAssign = new Map();
      (assigns||[])
        .filter(a => {
          if (!a.date) return false;
          
          // æ—¥ä»˜ãŒæŒ‡å®šã•ã‚ŒãŸæœˆã®ç¯„å›²å†…ã«ã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          const dateObj = new Date(a.date);
          const year = dateObj.getFullYear();
          const month = dateObj.getMonth();
          
          // å¹´ã¨æœˆãŒä¸€è‡´ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          const isCorrectMonth = year === assignedCalYear && month === assignedCalMonth;
          
          // è¡¨ç¤ºã•ã‚Œã‚‹äºˆå®šã‹ãƒã‚§ãƒƒã‚¯ï¼ˆgolf_coursesã®æƒ…å ±ãŒã‚ã‚‹ã‹ï¼‰
          const hasDisplayInfo = a.golf_courses && a.golf_courses.name;
          
          console.log(`äºˆå®šãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°: ${a.date}`, { 
            year, month, assignedCalYear, assignedCalMonth, 
            isCorrectMonth, hasDisplayInfo, 
            golfCourseName: a.golf_courses?.name 
          });
          
          return isCorrectMonth && hasDisplayInfo;
        })
        .forEach(a => {
          dateToAssign.set(a.date, a);
        });
      
      console.log('ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã®äºˆç´„æ•°:', dateToAssign.size);
      console.log('è¡¨ç¤ºã•ã‚Œã‚‹äºˆå®š:', Array.from(dateToAssign.values()).map(a => ({ 
        date: a.date, 
        name: a.golf_courses?.name 
      })));

      for(let day=1;day<=lastDate.getDate();day++){
        const dateStr=`${firstDate.getFullYear()}-${String(firstDate.getMonth()+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const td=document.createElement('td');
        const assign = dateToAssign.get(dateStr);
        td.innerHTML = `<small>${day}</small><br>${assign ? `<a href="#" data-bid="${assign.booking_id}" class="assigned-link"><span class="ok-circle" style="border-color:#2e7d32"></span> ${assign.golf_courses?.name || 'äºˆç´„'}</a>` : ''}`;
        if (assign) {
          td.style.background = '#e8f5e9'; // äºˆç´„ã‚ã‚Šã‚’æ·¡ã„ç·‘ã§è¡¨ç¤º
          td.style.border = '2px solid #81c784';
        }
        if(assign){
          td.querySelector('.assigned-link').onclick=(e)=>{e.preventDefault();openCourseDetail(assign)};
        }
        row.appendChild(td);
        if((startWD+day)%7===0){table.appendChild(row);row=document.createElement('tr');}
      }
      if(row.children.length){while(row.children.length<7)row.appendChild(document.createElement('td'));table.appendChild(row);} 
    }

    // ã‚­ãƒ£ãƒ‡ã‚£äºˆå®šï¼ˆäºˆç´„ç¢ºå®šåˆ†ï¼‰ã‚’ã‚´ãƒ«ãƒ•å ´å´ã®äºˆç´„ç¢ºèªã¨åŒæ§˜ã®ãƒªã‚¹ãƒˆã§è¡¨ç¤º
    let alMonth = new Date().getMonth();
    let alYear = new Date().getFullYear();
    // æœˆç§»å‹•ã‚’å¸¸ã«åˆ©ç”¨å¯èƒ½ã«ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ï¼‰
    window.alNav = (delta)=>{
      alMonth += delta;
      if (alMonth < 0) { alMonth = 11; alYear--; }
      if (alMonth > 11) { alMonth = 0; alYear++; }
      // ã‚¿ãƒ–ãŒã‚­ãƒ£ãƒ‡ã‚£äºˆå®šã®æ™‚ã®ã¿åæ˜ 
      const container = document.getElementById('assignedListContainer');
      if (container && container.style.display !== 'none') {
        renderAssignedList();
      }
    };
    async function renderAssignedList(){
      const container = document.getElementById('assignedListContainer');
      const body = document.getElementById('assignedListBody');
      const title = document.getElementById('alTitle');
      if (!container || !body || !title) return;
      // è¡¨ç¤ºåˆ‡æ›¿
      container.classList.remove('hidden');
      container.style.display = 'block';
      const mainAssignedEl = document.getElementById('mainAssigned');
      if (mainAssignedEl) mainAssignedEl.style.display = 'none';

      title.textContent = `${alYear}å¹´ ${alMonth+1}æœˆ`;
      body.innerHTML = '<tr><td colspan="3" style="padding:8px;color:#888;">èª­ã¿è¾¼ã¿ä¸­...</td></tr>';
      const first = `${alYear}-${String(alMonth+1).padStart(2,'0')}-01`;
      const lastDate = new Date(alYear, alMonth+1, 0).getDate();
      const last = `${alYear}-${String(alMonth+1).padStart(2,'0')}-${String(lastDate).padStart(2,'0')}`;

      const { data: bookings, error } = await supabase
        .from('bookings')
        .select(`
          booking_id,date,
          golf_courses ( gid,name,description,perks ),
          booking_caddies!inner ( cid )
        `)
        .eq('booking_caddies.cid', cid)
        .gte('date', first)
        .lte('date', last)
        .order('date', { ascending: true });
      if (error){ body.innerHTML = `<tr><td colspan='3' style='padding:8px;color:#e74c3c;'>${error.message}</td></tr>`; return; }
      if (!bookings || bookings.length===0){ body.innerHTML = `<tr><td colspan='3' style='padding:8px;color:#888;'>å½“æœˆã®äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>`; return; }
      body.innerHTML='';
      for (const b of bookings){
        // æœ€æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å–å¾—ï¼ˆè©²å½“ã‚´ãƒ«ãƒ•å ´ã¨ã®å½“è©²äºˆç´„ï¼‰
        let preview = '';
        try {
          const { data: msgs } = await supabase
            .from('messages')
            .select('content, created_at')
            .eq('booking_id', b.booking_id)
            .or(`and(sender_id.eq.${cid},receiver_id.eq.${b.golf_courses?.gid}),and(sender_id.eq.${b.golf_courses?.gid},receiver_id.eq.${cid})`)
            .order('created_at', { ascending: false })
            .limit(1);
          preview = (msgs && msgs[0]?.content) ? msgs[0].content.slice(0, 40) : '';
        } catch {}

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style='padding:8px;border-bottom:1px solid #eee;'>${b.date}</td>
          <td style='padding:8px;border-bottom:1px solid #eee;'>
            <a href="#" class='alProfile' data-bid='${b.booking_id}' style='color:#2e7d32;font-weight:600;'>${b.golf_courses?.name || ''}</a>
          </td>
          <td style='padding:8px;border-bottom:1px solid #eee;'>
            <a href="#" class='alMsg' data-bid='${b.booking_id}' style='color:#555;'>${preview || 'ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—ï¼‰'}</a>
          </td>
        `;
        body.appendChild(tr);
      }
      // ãƒãƒ³ãƒ‰ãƒ©
      Array.from(document.getElementsByClassName('alProfile')).forEach(btn=>{
        btn.onclick = async (e)=>{
          const bid = e.currentTarget.getAttribute('data-bid');
          const b = bookings.find(x=>x.booking_id===bid);
          if (!b) return;
          openCourseDetail({
            booking_id: b.booking_id,
            gid: b.golf_courses?.gid,
            golf_courses: b.golf_courses
          });
        };
      });
      Array.from(document.getElementsByClassName('alMsg')).forEach(btn=>{
        btn.onclick = async (e)=>{
          e.preventDefault();
          const bid = e.currentTarget.getAttribute('data-bid');
          const b = bookings.find(x=>x.booking_id===bid);
          if (!b) return;
          currentBookingId = bid;
          chatPartnerId = b.golf_courses?.gid;
          chatPartnerName = b.golf_courses?.name || 'ã‚´ãƒ«ãƒ•å ´';
          switchMain('msg');
          await loadChatMessages();
          const chatArea = document.getElementById('chatInputArea');
          if (chatArea) chatArea.style.display='flex';
          const listEl = document.getElementById('messagesList');
          if (listEl) listEl.scrollTop = listEl.scrollHeight;
        };
      });

      // æœˆç§»å‹•: æ¯å›ãƒœã‚¿ãƒ³ã«å†ãƒã‚¤ãƒ³ãƒ‰
      const prevBtn = document.getElementById('alPrevMonth');
      const nextBtn = document.getElementById('alNextMonth');
      if (prevBtn) {
        prevBtn.onclick = null;
        prevBtn.addEventListener('click', (ev)=>{ ev.preventDefault(); if(--alMonth<0){alMonth=11;alYear--;} renderAssignedList(); });
      }
      if (nextBtn) {
        nextBtn.onclick = null;
        nextBtn.addEventListener('click', (ev)=>{ ev.preventDefault(); if(++alMonth>11){alMonth=0;alYear++;} renderAssignedList(); });
      }
    }

    // ã‚´ãƒ«ãƒ•å ´è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    let pendingChat = { bookingId:null, gid:null, name:'' };
    function openCourseDetail(assign){
      const gc = assign.golf_courses || {};
      pendingChat = { bookingId: assign.booking_id, gid: assign.gid || null, name: gc.name || 'ã‚´ãƒ«ãƒ•å ´' };
      document.getElementById('cdmName').textContent = gc.name || 'ã‚´ãƒ«ãƒ•å ´';
      const img = document.getElementById('cdmImage');
      if (gc.image_url){ img.src = gc.image_url; img.style.display='block'; } else { img.style.display='none'; }
      document.getElementById('cdmAddress').textContent = `ä½æ‰€: ${gc.address || 'æœªè¨­å®š'}`;
      document.getElementById('cdmDescription').textContent = `èª¬æ˜: ${gc.description || 'æœªè¨­å®š'}`;
      document.getElementById('cdmPerks').textContent = `ç‰¹å…¸: ${gc.perks || 'ãªã—'}`;
      document.getElementById('courseDetailModal').style.display='flex';
    }

    document.getElementById('cdmClose').onclick=()=>{
      document.getElementById('courseDetailModal').style.display='none';
    };

    // ã€Œãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹ã™ã‚‹ã€â†’ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ãƒ–ã§è©²å½“ã‚´ãƒ«ãƒ•å ´ã¨ãƒãƒ£ãƒƒãƒˆï¼ˆäºˆç´„IDã‚‚ç´ä»˜ã‘ï¼‰
    document.getElementById('cdmChat').onclick=()=>{
      document.getElementById('courseDetailModal').style.display='none';
      if(pendingChat.gid){
        // äºˆç´„IDã¨ç›¸æ‰‹ID/åå‰ã‚’è¨­å®šã—ã¦ãƒãƒ£ãƒƒãƒˆç”»é¢ã¸
        currentBookingId = pendingChat.bookingId;
        chatPartnerId = pendingChat.gid;
        chatPartnerName = pendingChat.name || 'ã‚´ãƒ«ãƒ•å ´';
        switchMain('msg');
        loadChatMessages();
      }
    };

    // main tabs
    const mainProf=document.getElementById('mainProfile');
    const mainShift=document.getElementById('mainShift');
    const mainMsg=document.getElementById('mainMessages');
    const mainNotice=document.getElementById('mainNotice');
    const mainAssigned=document.getElementById('mainAssigned');
    const btnMainProfEl = document.getElementById('btnMainProf');
    const btnMainShiftEl = document.getElementById('btnMainShift');
    const btnMainAssignEl = document.getElementById('btnMainAssign');
    const btnMainLineEl = document.getElementById('btnMainLine');
    const btnMainNoticeEl = document.getElementById('btnMainNotice');
    if (btnMainProfEl) btnMainProfEl.onclick=()=>switchMain('prof');
    if (btnMainShiftEl) btnMainShiftEl.onclick=()=>switchMain('shift');
    if (btnMainAssignEl) btnMainAssignEl.onclick=()=>switchMain('assign');
    if (btnMainLineEl) btnMainLineEl.onclick=()=>switchMain('line');
    if (btnMainNoticeEl) btnMainNoticeEl.onclick=()=>switchMain('notice');
    function switchMain(k){
      const mainLineSettings=document.getElementById('mainLineSettings');
      const map={prof:mainProf,shift:mainShift,assign:mainAssigned,msg:mainMsg,notice:mainNotice,line:mainLineSettings};
      // hide all
      Object.values(map).forEach(el=>{el.style.display='none';});
      // äºˆç´„ãƒªã‚¹ãƒˆï¼ˆæ–°UIï¼‰ã‚‚ç¢ºå®Ÿã«éš ã™
      const assignedListContainer = document.getElementById('assignedListContainer');
      if (assignedListContainer) assignedListContainer.style.display = 'none';
      btnMainProfEl?.classList.remove('active');
      btnMainShiftEl?.classList.remove('active');
      btnMainAssignEl?.classList.remove('active');
      btnMainLineEl?.classList.remove('active');
      btnMainNoticeEl?.classList.remove('active');

      // show selected
      if(map[k]){map[k].style.display='block';}
      if(k==='prof') btnMainProfEl?.classList.add('active');
      if(k==='shift'){
        btnMainShiftEl?.classList.add('active');
        // åˆå›ã¯ç·¨é›†å¯èƒ½ãªç›´è¿‘æœˆã‚’ã‚»ãƒƒãƒˆã—ã¦ã‹ã‚‰æç”»
        setInitialEditableMonth();
        editMode = false; // ã‚·ãƒ•ãƒˆã‚¿ãƒ–å…¥å ´æ™‚ã¯é€šå¸¸ãƒ¢ãƒ¼ãƒ‰
        pendingInserts.clear(); pendingDeletes.clear();
        const saveBtn = document.getElementById('saveShiftBtn');
        const editBtn = document.getElementById('editShiftBtn');
        if (saveBtn) saveBtn.disabled = true;
        if (editBtn) editBtn.disabled = false;
        renderCal();
      }
      if(k==='assign'){
        btnMainAssignEl?.classList.add('active');
        renderAssignedList();
      } 
      if(k==='line'){
        btnMainLineEl?.classList.add('active');
        checkLineConnectionStatus();
      }
      if(k==='notice'){btnMainNoticeEl?.classList.add('active');}
    }

    // åˆæœŸè¡¨ç¤ºï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒæç”»æ¸ˆã¿ã§ã‚ã‚Œã°profã€ãã‚Œä»¥å¤–ã¯shiftã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    try { switchMain('prof'); } catch(e) { switchMain('shift'); }
    // ã‚¿ãƒ–ãƒœã‚¿ãƒ³åˆæœŸçŠ¶æ…‹
    const b1 = document.getElementById('btnMainProf');
    const b2 = document.getElementById('btnMainShift');
    const b3 = document.getElementById('btnMainAssign');
    const b4 = document.getElementById('btnMainMsg');
    if (b1 && !b1.classList.contains('active')) b1.classList.add('active');


    document.getElementById('logoutBtn').onclick=async()=>{await supabase.auth.signOut();location.href='/';};

    // ã‚·ãƒ•ãƒˆç·¨é›†/ç¢ºå®šãƒœã‚¿ãƒ³
    const editBtn = document.getElementById('editShiftBtn');
    const saveBtn = document.getElementById('saveShiftBtn');
    if (editBtn) editBtn.onclick = ()=>{
      // ç· åˆ‡ãƒã‚§ãƒƒã‚¯ï¼ˆç¾åœ¨è¡¨ç¤ºä¸­ã®å¹´æœˆï¼‰
      if (isMonthLocked(calYear, calMonth)){
        alert('ç·¨é›†ç· ã‚åˆ‡ã‚Šã‚’éãã¦ã„ã¾ã™');
        return;
      }
      editMode = true;
      if (saveBtn) saveBtn.disabled = false;
      editBtn.disabled = true;
      renderCal();
    };
    if (saveBtn) saveBtn.onclick = async ()=>{
      // ä¸€æ‹¬åæ˜ 
      console.log(`=== ã‚·ãƒ•ãƒˆä¿å­˜é–‹å§‹ ===`);
      console.log(`ã‚­ãƒ£ãƒ‡ã‚£ID: ${cid}`);
      console.log(`å‰Šé™¤äºˆå®š:`, Array.from(pendingDeletes));
      console.log(`è¿½åŠ äºˆå®š:`, Array.from(pendingInserts));
      
      try {
        if (pendingDeletes.size>0){
          const dates = Array.from(pendingDeletes);
          console.log(`å‰Šé™¤å‡¦ç†é–‹å§‹: ${dates}`);
          const deleteResult = await supabase.from('caddy_availability').delete().eq('cid', cid).in('date', dates);
          console.log(`å‰Šé™¤çµæœ:`, deleteResult);
          if (deleteResult.error) {
            console.error(`å‰Šé™¤ã‚¨ãƒ©ãƒ¼:`, deleteResult.error);
            throw new Error(`å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${deleteResult.error.message}`);
          }
        }
        
        if (pendingInserts.size>0){
          const rows = Array.from(pendingInserts).map(d=>({ cid, date: d }));
          console.log(`è¿½åŠ å‡¦ç†é–‹å§‹: ${rows}`);
          const insertResult = await supabase.from('caddy_availability').insert(rows);
          console.log(`è¿½åŠ çµæœ:`, insertResult);
          if (insertResult.error) {
            console.error(`è¿½åŠ ã‚¨ãƒ©ãƒ¼:`, insertResult.error);
            throw new Error(`è¿½åŠ ã‚¨ãƒ©ãƒ¼: ${insertResult.error.message}`);
          }
        }
        
        console.log(`ä¿å­˜å‡¦ç†å®Œäº†`);
        pendingDeletes.clear();
        pendingInserts.clear();
        editMode = false;
        if (saveBtn) saveBtn.disabled = true;
        if (editBtn) editBtn.disabled = false;
        
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å†æç”»
        console.log(`ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å†æç”»é–‹å§‹`);
        await renderCal();
        console.log(`ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å†æç”»å®Œäº†`);
        
        alert('ã‚·ãƒ•ãƒˆã‚’ç¢ºå®šã—ã¾ã—ãŸ');
      } catch (e) {
        console.error(`=== ã‚·ãƒ•ãƒˆä¿å­˜ã‚¨ãƒ©ãƒ¼ ===`);
        console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', e);
        console.error('ã‚¨ãƒ©ãƒ¼ã‚¹ã‚¿ãƒƒã‚¯:', e.stack);
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e.message||e));
      }
    };

    function renderProfileDisplay(row){
       document.getElementById('welcome').textContent=`ã‚ˆã†ã“ã ${row.name||''} ã•ã‚“`;
       document.getElementById('mainProfile').innerHTML=`
        <div class="card" style='display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap'>
          <div id='avatarCircle' style='width:110px;height:110px;border-radius:50%;background:#ddd;overflow:hidden;'>
            ${row.avatar_url ? (()=>{const u = row.avatar_url + (row.avatar_url.includes('?')?'&':'?')+`v=${Date.now()}`; return `<img src='${u}' style='width:100%;height:100%;object-fit:cover;'>`;})() : ''}
          </div>
          <div style='min-width:220px;flex:1;'>
            <h2 style='margin:0 0 8px;'>${row.name||'æœªè¨­å®š'}</h2>
            <div style='color:#555;font-size:.95rem;line-height:1.9;'>
              <div>é›»è©±: ${row.phone||'æœªè¨­å®š'}</div>
              <div>æ‰€å±å¤§å­¦: ${row.university||'æœªè¨­å®š'}</div>
              <div>ã‚´ãƒ«ãƒ•æ­´: ${row.golf_years??0} å¹´</div>
              <div>ã‚­ãƒ£ãƒ‡ã‚£æ­´: ${row.caddy_years??0} å¹´</div>
            </div>
          </div>
          <div style='flex-basis:100%;margin-top:8px;'>
            <div style='font-weight:700;margin-bottom:6px;'>ã‚¢ãƒ”ãƒ¼ãƒ«</div>
            <div style='white-space:pre-wrap;background:#f8f9fa;border:1px solid #eee;border-radius:6px;padding:10px;'>${row.appeal||'æœªè¨­å®š'}</div>
          </div>
          <div style='margin-left:auto;'>
          <button id='editProfBtn'>ç·¨é›†</button>
          </div>
        </div>`;
       const btn = document.getElementById('editProfBtn');
       if (btn) btn.onclick=renderProfileForm.bind(null,row);
    }

    function renderProfileForm(row={}){
      document.getElementById('mainProfile').innerHTML=`
        <div style='display:flex;gap:24px;align-items:flex-start;flex-wrap:wrap'>
          <form id='profForm' style='max-width:520px;flex:1 1 320px'>
          <label>æ°å<input type='text' id='pName' value='${row.name??""}' required></label><br>
          <label>ç”Ÿå¹´æœˆæ—¥<input type='date' id='pBirth' value='${row.birth_date??""}'></label><br>
          <label>é›»è©±<input type='text' id='pPhone' value='${row.phone??""}'></label><br>
          <label>æ‰€å±å¤§å­¦<input type='text' id='pUni' value='${row.university??""}'></label><br>
          <label>ã‚´ãƒ«ãƒ•æ­´(å¹´)<input type='number' id='pGolf' value='${row.golf_years??0}'></label><br>
          <label>ã‚­ãƒ£ãƒ‡ã‚£æ­´(å¹´)<input type='number' id='pCaddy' value='${row.caddy_years??0}'></label><br>
          <label>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ<input type='file' id='pAvatar' accept='image/*'></label><br>
            <label>ã‚¢ãƒ”ãƒ¼ãƒ«<textarea id='pAppeal' rows='5'>${row.appeal??""}</textarea></label><br>
          <button type='submit'>ä¿å­˜</button>
          </form>
          <div id='profPreview' class='card' style='flex:1 1 260px;min-width:260px;'>
            <div id='ppAvatar' style='width:120px;height:120px;border-radius:50%;background:#ddd;overflow:hidden;'>
              ${row.avatar_url ? (()=>{const u = row.avatar_url + (row.avatar_url.includes('?')?'&':'?')+`v=${Date.now()}`; return `<img src='${u}' style='width:100%;height:100%;object-fit:cover;'>`;})() : ''}
            </div>
            <h3 id='ppName' style='margin:12px 0 8px;'>${row.name||''}</h3>
            <div class='pp-line'>é›»è©±: <span id='ppPhone'>${row.phone||''}</span></div>
            <div class='pp-line'>æ‰€å±å¤§å­¦: <span id='ppUni'>${row.university||''}</span></div>
            <div class='pp-line'>ã‚´ãƒ«ãƒ•æ­´: <span id='ppGolf'>${row.golf_years??0}</span> å¹´</div>
            <div class='pp-line'>ã‚­ãƒ£ãƒ‡ã‚£æ­´: <span id='ppCaddy'>${row.caddy_years??0}</span> å¹´</div>
            <div style='margin-top:8px;font-weight:700;'>ã‚¢ãƒ”ãƒ¼ãƒ«</div>
            <div id='ppAppeal' style='white-space:pre-wrap;background:#f8f9fa;border:1px solid #eee;border-radius:6px;padding:10px;'>${row.appeal||''}</div>
          </div>
        </div>`;
      const form = document.getElementById('profForm');
      if (form) form.onsubmit=saveProfile.bind(null,row);
      // å…¥åŠ›å³æ™‚ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
      const syncText = (id, viewId, suffix='')=>{
        const el = document.getElementById(id); const v = document.getElementById(viewId);
        if (el && v){ el.addEventListener('input', ()=>{ v.textContent = el.value + suffix; }); }
      };
      syncText('pName','ppName');
      syncText('pPhone','ppPhone');
      syncText('pUni','ppUni');
      document.getElementById('pGolf')?.addEventListener('input', (e)=>{ const v=document.getElementById('ppGolf'); if(v) v.textContent=e.target.value||'0'; });
      document.getElementById('pCaddy')?.addEventListener('input', (e)=>{ const v=document.getElementById('ppCaddy'); if(v) v.textContent=e.target.value||'0'; });
      document.getElementById('pAppeal')?.addEventListener('input', (e)=>{ const v=document.getElementById('ppAppeal'); if(v) v.textContent=e.target.value; });
      const fileInput = document.getElementById('pAvatar');
      if (fileInput){
        fileInput.addEventListener('change', (ev)=>{
          const file = ev.target.files && ev.target.files[0];
          if(!file) return;
          const reader = new FileReader();
          reader.onload = ()=>{
            const box = document.getElementById('ppAvatar');
            if (box){ box.innerHTML = `<img src='${reader.result}' style='width:100%;height:100%;object-fit:cover;'>`; }
          };
          reader.readAsDataURL(file);
        });
      }
    }

    async function saveProfile(row,e){
      e.preventDefault();
      const payload={
        name:document.getElementById('pName').value,
        birth_date:document.getElementById('pBirth').value||null,
        phone:document.getElementById('pPhone').value,
        university:document.getElementById('pUni').value,
        golf_years:parseInt(document.getElementById('pGolf').value)||0,
        caddy_years:parseInt(document.getElementById('pCaddy').value)||0,
        appeal:document.getElementById('pAppeal').value
      };
      if(row.cid){
        const { error } = await supabase.from('caddies').update(payload).eq('cid',row.cid);
        if(error){alert(error.message);return;}
        renderProfileDisplay({...row,...payload});
      } else {
        const { data:userData } = await supabase.auth.getUser();
        const newCid='c'+userData.user.id.slice(0,6);
        const { error } = await supabase.from('caddies').insert({...payload,cid:newCid,email:userData.user.email});
        if(error){alert(error.message);return;}
        cid=newCid;
        renderProfileDisplay({...payload,cid:newCid});
      }
      const file=document.getElementById('pAvatar').files[0];
      if(file){
        // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸: ç«¶åˆã‚’é¿ã‘ã‚‹ä¸€æ„ã‚­ãƒ¼ï¼ˆãƒ•ã‚©ãƒ«ãƒ€: caddiesï¼‰
        const ext = (file.name.split('.').pop()||'jpg').toLowerCase();
        const path=`caddies/${cid||('tmp_'+Date.now())}_${Date.now()}.${ext}`;
        const { error:upErr } = await supabase.storage.from('avatars').upload(path,file,{upsert:true});
        if(!upErr){
        const { data:urlData } = supabase.storage.from('avatars').getPublicUrl(path);
        payload.avatar_url=urlData.publicUrl;
          await supabase.from('caddies').update({ avatar_url: payload.avatar_url }).eq('cid', cid);
          // ç”»é¢å³æ™‚åæ˜ ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿ã®ãŸã‚ã‚¯ã‚¨ãƒªä»˜ä¸ï¼‰
          const updated = { ...row, ...payload, cid, avatar_url: payload.avatar_url + `?v=${Date.now()}` };
          renderProfileDisplay(updated);
        }
      }
    }

    (function(){
      const btn = document.getElementById('confirmShiftBtn');
      if (btn) btn.onclick=async()=>{ alert('ã‚·ãƒ•ãƒˆã‚’ç¢ºå®šã—ã¾ã—ãŸ'); };
    })();



    /* ãƒãƒ£ãƒƒãƒˆUIç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—ãƒ»è¡¨ç¤º */
    var chatPartnerId = null; // ãƒãƒ£ãƒƒãƒˆç›¸æ‰‹ID
    var chatPartnerName = '';
    var currentBookingId = null; // ç¾åœ¨ã®äºˆå®šID

    // äºˆå®šä¸€è¦§ã‚’è¡¨ç¤º
    async function showBookingList() {
      const messagesList = document.getElementById('messagesList');
      messagesList.innerHTML = '<div style="text-align:center;color:#aaa;">èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      // ã‚­ãƒ£ãƒ‡ã‚£ã®äºˆå®šã‚’å–å¾—
      const { data: bookings, error } = await supabase
                  .from('booking_caddies')
          .select(`
            *,
            bookings (
              booking_id,
              date,
              slots,
              golf_courses (
                gid,
                name
              )
            )
          `)
          .eq('cid', cid)
          .order('date', { ascending: false, foreignTable: 'bookings' });
        
        if (error) {
        messagesList.innerHTML = `<div style='color:#e74c3c;'>ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
          return;
        }
        
      if (!bookings || bookings.length === 0) {
        messagesList.innerHTML = '<div style="text-align:center;color:#aaa;">äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</div>';
          return;
        }
        
      messagesList.innerHTML = '<h3 style="margin-bottom:16px;color:#333;">äºˆå®šä¸€è¦§</h3>';
      bookings.forEach(booking => {
        const bookingDiv = document.createElement('div');
        bookingDiv.style.cssText = `
          background: #fff;
          border: 1px solid #e0e0e0;
          border-radius: 8px;
          padding: 12px;
          margin-bottom: 8px;
          cursor: pointer;
          transition: background 0.2s;
        `;
        bookingDiv.onmouseover = () => bookingDiv.style.background = '#f5f5f5';
        bookingDiv.onmouseout = () => bookingDiv.style.background = '#fff';
        
        const golfCourseName = booking.bookings?.golf_courses?.name || 'ä¸æ˜';
        const date = booking.bookings?.date || 'ä¸æ˜';
        
        bookingDiv.innerHTML = `
          <div style="font-weight:bold;color:#333;">${golfCourseName}</div>
          <div style="color:#666;font-size:0.9rem;">${date}</div>
          <div style="color:#27ae60;font-size:0.8rem;margin-top:4px;">ã‚¿ãƒƒãƒ—ã—ã¦ãƒãƒ£ãƒƒãƒˆ</div>
        `;
        
        bookingDiv.onclick = () => {
          currentBookingId = booking.bookings?.booking_id;
          chatPartnerId = booking.bookings?.golf_courses?.gid;
          chatPartnerName = golfCourseName;
          loadChatMessages();
        };
        
        messagesList.appendChild(bookingDiv);
      });
    }

    async function loadChatMessages() {
      if (!chatPartnerId || !currentBookingId) {
        // å…¥åŠ›æ¬„ã‚’éš ã™
        document.getElementById('chatInputArea').style.display = 'none';
        showBookingList();
        return;
      }

      const messagesList = document.getElementById('messagesList');
      messagesList.innerHTML = `
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;padding:8px;background:#f0f0f0;border-radius:8px;">
          <button onclick="showBookingList()" style="background:none;border:none;cursor:pointer;font-size:1.2rem;">â†</button>
                <div>
            <div style="font-weight:bold;">${chatPartnerName}</div>
            <div style="font-size:0.8rem;color:#666;">äºˆå®šã«é–¢ã™ã‚‹é€£çµ¡</div>
                </div>
            </div>
          `;

      // å…¥åŠ›æ¬„ã‚’è¡¨ç¤º
      document.getElementById('chatInputArea').style.display = 'flex';

      // äºˆå®šã«é–¢é€£ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
      const { data: messages, error } = await supabase
        .from('messages')
        .select('*')
        .or(`and(sender_id.eq.${cid},receiver_id.eq.${chatPartnerId}),and(sender_id.eq.${chatPartnerId},receiver_id.eq.${cid})`)
        .eq('booking_id', currentBookingId)
        .order('created_at', { ascending: true });
        
        if (error) {
        messagesList.innerHTML += `<div style='color:#e74c3c;'>ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
          return;
        }
        
      if (!messages || messages.length === 0) {
        messagesList.innerHTML += '<div style="text-align:center;color:#aaa;margin-top:20px;">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
      } else {
        messages.forEach(msg => {
          const isSent = msg.sender_id === cid;
          const bubble = document.createElement('div');
          bubble.className = 'chat-bubble ' + (isSent ? 'sent' : 'received');
          bubble.innerHTML = `${msg.content}<div class='chat-meta${isSent ? '' : ' received'}'>${new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}${msg.is_read ? "<span class='chat-badge read'>æ—¢èª­</span>" : (!isSent ? "<span class='chat-badge unread'>æœªèª­</span>" : '')}</div>`;
          messagesList.appendChild(bubble);
        });
      }
      
      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æœ€ä¸‹éƒ¨ã¸
      messagesList.scrollTop = messagesList.scrollHeight;
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    async function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const content = input.value.trim();
      if (!content || !chatPartnerId || !currentBookingId) return;
      
      const { error } = await supabase.from('messages').insert({
            sender_type: 'caddy',
            sender_id: cid,
            receiver_type: 'golf_course',
        receiver_id: chatPartnerId,
        booking_id: currentBookingId,
        subject: 'äºˆå®šã«é–¢ã™ã‚‹é€£çµ¡',
        content,
        is_read: false
          });
        
        if (error) {
        alert('é€ä¿¡ã‚¨ãƒ©ãƒ¼: ' + error.message);
        return;
      }
      
      input.value = '';
      loadChatMessages();
    }

    document.getElementById('sendChatBtn').onclick = sendChatMessage;
    document.getElementById('chatInput').onkeydown = e => { if (e.key === 'Enter') sendChatMessage(); };

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ãƒ–ã‚’é–‹ã„ãŸã‚‰äºˆå®šä¸€è¦§ã‚’è¡¨ç¤º
    async function showChatWithGolfCourse() {
      showBookingList();
    }

    // LINEé€£æºé–¢é€£ã®é–¢æ•°
    const LINE_BOT_ID = '@775xibyg'; // ã‚­ãƒ£ãƒ‡ã‚£ãƒ—ãƒ©ã‚¹å…¬å¼LINE
    
    async function checkLineConnectionStatus() {
      try {
        const { data: lineIntegration } = await supabase
          .from('line_integrations')
          .select('*')
          .eq('cid', cid)
          .eq('is_active', true)
          .single();
        
        if (lineIntegration) {
          document.getElementById('lineNotConnected').style.display = 'none';
          document.getElementById('lineConnected').style.display = 'block';
        } else {
          document.getElementById('lineNotConnected').style.display = 'block';
          document.getElementById('lineConnected').style.display = 'none';
        }
      } catch (error) {
        console.log('LINE integration not found:', error);
        document.getElementById('lineNotConnected').style.display = 'block';
        document.getElementById('lineConnected').style.display = 'none';
      }
    }
    
    // ã‚­ãƒ£ãƒ‡ã‚£äºˆå®šã®æœˆç§»å‹•ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆé‡è¤‡ç™»éŒ²é˜²æ­¢ï¼‰
    function setupCaddyScheduleNavigation() {
      // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
      const prevBtn = document.getElementById('aPrevMonth');
      const nextBtn = document.getElementById('aNextMonth');
      
      if (prevBtn) {
        prevBtn.replaceWith(prevBtn.cloneNode(true));
      }
      if (nextBtn) {
        nextBtn.replaceWith(nextBtn.cloneNode(true));
      }
      
      // æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
      document.getElementById('aPrevMonth')?.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        console.log('å‰æœˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ - ç¾åœ¨ã®çŠ¶æ…‹:', { assignedCalYear, assignedCalMonth });
        
        // å‰æœˆã«ç§»å‹•
        if (assignedCalMonth > 0) {
          assignedCalMonth--;
        } else {
          assignedCalMonth = 11;
          assignedCalYear--;
        }
        
        console.log('å‰æœˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ - ç§»å‹•å¾Œã®çŠ¶æ…‹:', { assignedCalYear, assignedCalMonth });
        
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ›´æ–°
        updateAssignedCalendar();
      });
      
      document.getElementById('aNextMonth')?.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        console.log('æ¬¡æœˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ - ç¾åœ¨ã®çŠ¶æ…‹:', { assignedCalYear, assignedCalMonth });
        
        // æ¬¡æœˆã«ç§»å‹•
        if (assignedCalMonth < 11) {
          assignedCalMonth++;
        } else {
          assignedCalMonth = 0;
          assignedCalYear++;
        }
        
        console.log('æ¬¡æœˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ - ç§»å‹•å¾Œã®çŠ¶æ…‹:', { assignedCalYear, assignedCalMonth });
        
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ›´æ–°
        updateAssignedCalendar();
      });
    }
    
    // åˆæœŸè¨­å®š
    setupCaddyScheduleNavigation();
    
    // LINEé€£æºè¨­å®šãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    document.getElementById('connectLineBtn')?.addEventListener('click', () => {
      showLineIntegrationModal();
    });
    
    document.getElementById('testLineNotificationBtn')?.addEventListener('click', async () => {
      try {
        // ãƒ†ã‚¹ãƒˆé€šçŸ¥ã®é€ä¿¡ï¼ˆå®Ÿè£…æ™‚ï¼‰
        alert('ãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼LINEã‚’ã”ç¢ºèªãã ã•ã„ã€‚');
      } catch (error) {
        alert('ãƒ†ã‚¹ãƒˆé€šçŸ¥ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      }
    });
    
    document.getElementById('disconnectLineBtn')?.addEventListener('click', async () => {
      if (confirm('LINEé€£æºã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿè§£é™¤ã™ã‚‹ã¨é€šçŸ¥ã‚’å—ã‘å–ã‚Œãªããªã‚Šã¾ã™ã€‚')) {
        try {
          await supabase
            .from('line_integrations')
            .update({ is_active: false })
            .eq('cid', cid);
          
          alert('LINEé€£æºã‚’è§£é™¤ã—ã¾ã—ãŸã€‚');
          checkLineConnectionStatus();
        } catch (error) {
          alert('LINEé€£æºã®è§£é™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }
      }
    });
    
    function showLineIntegrationModal() {
      // login.htmlã¨åŒã˜LINEé€£æºãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      const linkToken = generateLinkToken();
      
      const modalHTML = `
        <div id="lineModal" style="position:fixed;inset:0;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;z-index:1000;display:flex;">
          <div style="background:#fff;padding:2rem;border-radius:12px;width:90%;max-width:400px;text-align:center;">
            <h3 style="color:#00B900;margin-bottom:1rem;">ğŸ“± LINEé€šçŸ¥ã‚’è¨­å®š</h3>
            <p style="margin-bottom:1.5rem;color:#666;line-height:1.5;">
              ã‚­ãƒ£ãƒ‡ã‚£ãƒ—ãƒ©ã‚¹å…¬å¼LINEã‚’å‹é”è¿½åŠ ã—ã¦ã€ä¸‹ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’é€ä¿¡ã—ã¦ãã ã•ã„ã€‚
            </p>
            
            <div style="margin-bottom:1.5rem;">
              <button id="addLineFriendModalBtn" style="background:#00B900;color:white;border:none;padding:0.875rem 2rem;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;width:100%;margin-bottom:1rem;">
                ğŸ¤ LINEå‹é”è¿½åŠ 
              </button>
            </div>
            
            <div style="margin-bottom:1.5rem;padding:1rem;background:#f8f9fa;border-radius:8px;">
              <p style="margin-bottom:0.5rem;font-weight:600;">é€£æºç”¨ãƒˆãƒ¼ã‚¯ãƒ³:</p>
              <code style="font-size:1.1rem;color:#00B900;font-weight:bold;">${linkToken}</code>
              <p style="font-size:0.8rem;color:#666;margin-top:0.5rem;">ã“ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’LINEã®ãƒãƒ£ãƒƒãƒˆã§é€ä¿¡ã—ã¦ãã ã•ã„</p>
            </div>
            
            <div style="display:flex;gap:1rem;">
              <button id="cancelLineModal" style="flex:1;background:#f0f0f0;color:#666;border:none;padding:0.75rem;border-radius:6px;cursor:pointer;">
                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
              </button>
              <button id="completeLineModal" style="flex:1;background:#3498db;color:white;border:none;padding:0.75rem;border-radius:6px;cursor:pointer;">
                å®Œäº†
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      
      document.getElementById('addLineFriendModalBtn').onclick = () => {
        const addFriendUrl = `https://line.me/R/ti/p/${LINE_BOT_ID}`;
        window.open(addFriendUrl, '_blank');
      };
      
      document.getElementById('cancelLineModal').onclick = () => {
        document.getElementById('lineModal').remove();
      };
      
      document.getElementById('completeLineModal').onclick = () => {
        document.getElementById('lineModal').remove();
        alert('LINEé€£æºã®è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸï¼');
        checkLineConnectionStatus();
      };
    }
    
    function generateLinkToken() {
      // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ
      const token = 'LINK:' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
      
      // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜
      saveLinkTokenToDatabase(token);
      
      return token;
    }
    
    async function saveLinkTokenToDatabase(token) {
      try {
        // LINK:ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’é™¤å»
        const cleanToken = token.replace('LINK:', '');
        
        // æœ‰åŠ¹æœŸé™ã‚’24æ™‚é–“å¾Œã«è¨­å®š
        const expiresAt = new Date();
        expiresAt.setHours(expiresAt.getHours() + 24);
        
        // line_link_tokensãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜
        const { error } = await supabase
          .from('line_link_tokens')
          .insert({
            cid: cid,
            token: cleanToken,
            expires_at: expiresAt.toISOString()
          });
        
        if (error) {
          console.error('Failed to save link token:', error);
          throw error;
        }
        
        console.log('Link token saved to database:', cleanToken);
        
      } catch (error) {
        console.error('Error saving link token:', error);
        alert('ãƒˆãƒ¼ã‚¯ãƒ³ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
      }
    }
  </script>
</body>
</html> 