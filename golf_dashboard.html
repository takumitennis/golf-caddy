<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Golf Dashboard</title>
  <style>
    body{font-family:Helvetica,Arial,sans-serif;padding:20px}
    h1{margin-bottom:20px}
    .tabs button{padding:10px 16px;margin-right:8px;border:none;border-bottom:2px solid transparent;background:#eaeaea;cursor:pointer}
    .tabs button.active{border-bottom-color:#0077cc;background:#fff}
    .hidden{display:none}
    form{margin-bottom:30px}
    input,button{padding:8px;margin-right:10px}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #ccc;padding:8px;text-align:center}
    th{background:#f2f2f2}
    .calendar th,.calendar td{width:14%;padding:6px;text-align:center;border:1px solid #ccc}
    .cal-green{background:#c8e6c9}
    .cal-yellow{background:#fff9c4}
    .cal-red{background:#ffcdd2}
  </style>
</head>
<body>
  <h1>ゴルフ場ダッシュボード</h1>
  <div id="welcome"></div>

  <!-- Tabs -->
  <div class="tabs">
    <button id="btnTab1" class="active">募集作成</button>
    <button id="btnTab2">空きキャディ確認</button>
  </div>

  <!-- Tab 1: bookings -->
  <div id="tab1">
    <form id="createForm" style="margin-top:20px;">
      <label>日付: <input type="date" id="bDate" required></label>
      <label>必要キャディ数: <input type="number" id="bSlots" min="1" required style="width:80px"></label>
      <button type="submit">募集作成</button>
    </form>

    <table>
      <thead>
        <tr><th>日付</th><th>必要人数</th><th>ステータス</th></tr>
      </thead>
      <tbody id="bookBody"></tbody>
    </table>
  </div>

  <!-- Tab 2: availability calendar -->
  <div id="tab2" class="hidden" style="margin-top:20px;">
    <div style="display:flex;align-items:center;gap:10px;">
      <button id="prevMonth">◀</button>
      <span id="calTitle"></span>
      <button id="nextMonth">▶</button>
    </div>
    <table class="calendar" id="calTable" style="margin-top:10px;border-collapse:collapse;width:100%"></table>
    <small style="display:block;margin-top:8px;">緑=3名以上, 黄=1-2名, 赤=0名</small>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabase = window.supabase.createClient(
      "https://vqjxajzaasuqfgvhvxci.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxanhhanphYXN1cWZndmh2eGNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2MjIxMzgsImV4cCI6MjA2OTE5ODEzOH0.NmKwgZA1_-TTvMTQt07QRXtIlR-DPOPATVPuQ3QuO54"
    );

    let gid;
    // 1. Check login & role
    supabase.auth.getUser().then(async ({ data }) => {
      if (!data.user) { location.href = "/"; return; }
      const role = data.user.user_metadata?.role;
      if (role !== "golf") { location.href = "dashboard.html"; return; }
      // get golf_courses row to fetch gid & name
      const { data: rows } = await supabase
        .from("golf_courses")
        .select("gid,name")
        .eq("email", data.user.email)
        .single();
      if (!rows) { alert("プロフィール未登録です"); location.href="/profile.html?role=golf"; return; }
      gid = rows.gid;
      document.getElementById("welcome").textContent = `ようこそ ${rows.name} 様`;
      loadBookings();
    });

    // 2. load bookings
    async function loadBookings(){
      const { data, error } = await supabase
        .from("bookings")
        .select("booking_id,date,slots,status")
        .eq("gid", gid)
        .order("date", { ascending: true });
      const tbody = document.getElementById("bookBody");
      tbody.innerHTML = "";
      if (error){ console.error(error); return; }
      data.forEach(b => {
        tbody.insertAdjacentHTML("beforeend",
          `<tr><td>${b.date}</td><td>${b.slots}</td><td>${b.status}</td></tr>`);
      });
    }

    // 3. create booking
    document.getElementById("createForm").onsubmit = async e => {
      e.preventDefault();
      const date = document.getElementById("bDate").value;
      const slots = parseInt(document.getElementById("bSlots").value,10);
      if (!date || !slots) return;
      const { error } = await supabase.from("bookings").insert({ gid, date, slots });
      if (error){ alert(error.message); return; }
      e.target.reset();
      loadBookings();
    };

    // --- Tabs logic ---
    const tab1=document.getElementById('tab1');
    const tab2=document.getElementById('tab2');
    document.getElementById('btnTab1').onclick=()=>{switchTab(1)};
    document.getElementById('btnTab2').onclick=()=>{switchTab(2)};

    // --- Calendar logic ---
    let calMonth = new Date().getMonth();
    let calYear = new Date().getFullYear();
    document.getElementById('prevMonth').onclick=()=>{if(--calMonth<0){calMonth=11;calYear--;} renderCal();};
    document.getElementById('nextMonth').onclick=()=>{if(++calMonth>11){calMonth=0;calYear++;} renderCal();};

    async function renderCal(){
      const first = new Date(calYear,calMonth,1);
      const last  = new Date(calYear,calMonth+1,0);
      document.getElementById('calTitle').textContent = `${calYear}年 ${calMonth+1}月`;
      // fetch availability rows for month
      const { data, error } = await supabase
        .from('caddy_availability')
        .select('date')
        .gte('date', first.toISOString().slice(0,10))
        .lte('date', last.toISOString().slice(0,10));
      const countMap = {};
      if(!error){
        data.forEach(r=>{countMap[r.date]=(countMap[r.date]||0)+1;});
      }
      // build calendar grid
      const table=document.getElementById('calTable');
      table.innerHTML='';
      const headerRow=document.createElement('tr');
      ['日','月','火','水','木','金','土'].forEach(d=>{
        const th=document.createElement('th');th.textContent=d;headerRow.appendChild(th);
      });
      table.appendChild(headerRow);
      let row=document.createElement('tr');
      const startWeekDay=first.getDay();
      for(let i=0;i<startWeekDay;i++){row.appendChild(document.createElement('td'));}
      for(let day=1;day<=last.getDate();day++){
        const dateStr=`${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const td=document.createElement('td');
        const cnt=countMap[dateStr]||0;
        const label = cnt===0 ? '×' : cnt;
        if(cnt===0){td.className='cal-red';}
        else if(cnt<3){td.className='cal-yellow';}
        else{td.className='cal-green';}
        td.innerHTML = `<small>${day}</small><br>${label}`;
        td.style.cursor='default';
        row.appendChild(td);
        if((startWeekDay+day)%7===0){table.appendChild(row);row=document.createElement('tr');}
      }
      if(row.children.length) {
        while(row.children.length<7)row.appendChild(document.createElement('td'));
        table.appendChild(row);
      }
    }
    // render calendar on tab switch
    function switchTab(idx){
      if(idx===1){tab1.classList.remove('hidden');tab2.classList.add('hidden');
        btnTab1.classList.add('active');btnTab2.classList.remove('active');}
      else{tab2.classList.remove('hidden');tab1.classList.add('hidden');
        btnTab2.classList.add('active');btnTab1.classList.remove('active');
        renderCal();}
    }
  </script>
</body>
</html> 