<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Golf Dashboard</title>
  <style>
    body{font-family:'Segoe UI',sans-serif;margin:0;background:#f5f6fa}
    h1{margin:0;padding:20px 24px;background:#2c3e50;color:#fff;font-size:1.4rem;text-wrap:balance}
    .container{padding:24px}
    .tabs-main{display:flex;gap:8px;padding:0 24px;background:#ecf0f1;flex-wrap:wrap}
    .tabs-main button{background:#ecf0f1;border:none;padding:12px 16px;font-weight:600;border-bottom:3px solid transparent;cursor:pointer;white-space:nowrap}
    .tabs-main button.active{border-color:#3498db;background:#fff;border-radius:4px 4px 0 0;color:#3498db;font-weight:bold}
    table{background:#fff;border-radius:6px;overflow:hidden}
    .tabs button{padding:10px 16px;margin-right:8px;border:none;border-bottom:2px solid transparent;background:#eaeaea;cursor:pointer}
    .tabs button.active{border-bottom-color:#0077cc;background:#fff}
    .hidden{display:none}
    form{margin-bottom:30px}
    input,button{padding:8px;margin-right:10px}
    @media (max-width: 768px){
      .tabs-main{padding:0 12px}
      .tabs-main button{padding:10px 12px;font-size:.95rem}
      table{font-size:.95rem}
      th,td{padding:6px}
    }
    th,td{border:1px solid #ccc;padding:8px;text-align:center}
    th{background:#f2f2f2}
    .calendar th,.calendar td{width:14%;padding:6px;text-align:center;border:1px solid #ccc}
    .cal-green{background:#c8e6c9}
    .cal-yellow{background:#fff9c4}
    .cal-red{background:#ffcdd2}
    .tabs-main button{padding:10px 16px;margin-right:8px;border:none;border-bottom:2px solid transparent;background:#e0e0e0;cursor:pointer}
    .tabs-main button.active{border-bottom-color:#0077cc;background:#fff}
    /* --- LINEé¢¨ãƒãƒ£ãƒƒãƒˆUI --- */
    #mainMessages {
      display: flex;
      flex-direction: column;
      height: 70vh;
      max-height: 600px;
      background: #f7f7f7;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      overflow: hidden;
      position: relative;
    }
    #messagesList {
      flex: 1;
      overflow-y: auto;
      padding: 24px 16px 16px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: #f7f7f7;
    }
    .chat-bubble {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 18px;
      font-size: 1rem;
      line-height: 1.5;
      position: relative;
      word-break: break-word;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
      margin-bottom: 2px;
    }
    .chat-bubble.sent {
      background: #d1f5d3;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    .chat-bubble.received {
      background: #fff;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      border: 1px solid #e0e0e0;
    }
    .chat-meta {
      font-size: 0.8rem;
      color: #888;
      margin-top: 2px;
      text-align: right;
    }
    .chat-meta.received {
      text-align: left;
    }
    #chatInputArea {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      background: #fff;
      border-top: 1px solid #e0e0e0;
      position: absolute;
      left: 0; right: 0; bottom: 0;
    }
    #chatInput {
      flex: 1;
      padding: 10px 14px;
      border-radius: 20px;
      border: 1px solid #ccc;
      font-size: 1rem;
      outline: none;
    }
    #sendChatBtn {
      background: #27ae60;
      color: #fff;
      border: none;
      border-radius: 20px;
      padding: 0 20px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    #sendChatBtn:hover {
      background: #219150;
    }
    /* æ—¢èª­æœªèª­ãƒãƒƒã‚¸ */
    .chat-badge {
      display: inline-block;
      font-size: 0.7rem;
      color: #fff;
      background: #aaa;
      border-radius: 8px;
      padding: 1px 6px;
      margin-left: 6px;
      vertical-align: middle;
    }
    .chat-badge.unread {
      background: #e74c3c;
    }
    .chat-badge.read {
      background: #27ae60;
    }
    /* äºˆç´„ãƒãƒ¼ */
    #reserveBar {
      position: fixed;
      left: 16px;
      right: 16px;
      bottom: 16px;
      display: none;
      background: #ffffff;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      padding: 12px 16px;
      z-index: 200;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    #reserveBar .reserve-info { color:#333; font-size: 0.95rem; }
    #reserveBar button {
      border: none; padding: 8px 14px; border-radius: 8px; cursor: pointer; font-weight: 600;
    }
    #reserveBtn { background:#27ae60; color:#fff; }
    #reserveCancel { background:#eee; color:#333; }
  </style>
</head>
<body>
  <h1>ã‚´ãƒ«ãƒ•å ´ãƒã‚¤ãƒšãƒ¼ã‚¸<!-- v=2025-08-10-01 --></h1>
  <div class="tabs-main">
    <button id="btnMainProf">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</button>
    <button id="btnMainStat" class="active">äºˆç´„ç®¡ç†</button>
    <button id="btnMainMsg" style="display:none;">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</button>
    <button id="logoutBtn" style="margin-left:auto;">Logout</button>
  </div>
  <div id="welcome" style="margin-top:10px;"></div>
  <!-- äºˆç´„ãƒãƒ¼ -->
  <div id="reserveBar">
    <div class="reserve-info"><span id="reserveDateText"></span> ã‚’äºˆç´„ã—ã¾ã™ã‹ï¼Ÿ</div>
    <div style="display:flex; gap:8px;">
      <button id="reserveCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button id="reserveBtn">äºˆç´„ã™ã‚‹</button>
    </div>
  </div>
  <!-- Profile Tab -->
  <div id="mainProfile" class="hidden" style="margin-top:15px;"></div>
  <script>
    function renderCreateProfile(email){
      const el = document.getElementById('mainProfile');
      if (!el) return;
      el.classList.remove('hidden');
      el.innerHTML = `
        <div style="max-width:560px;margin:0 auto;background:#fff;border-radius:8px;padding:16px;box-shadow:0 2px 6px rgba(0,0,0,.08)">
          <h3 style="margin-top:0">ã¾ãšã¯ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</h3>
          <form id="gcCreateForm">
            <div style="margin-bottom:12px;">
              <label style="display:block;margin-bottom:4px;">ã‚´ãƒ«ãƒ•å ´å</label>
              <input type="text" id="gcName" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;" />
            </div>
            <div style="margin-bottom:12px;">
              <label style="display:block;margin-bottom:4px;">æ‹…å½“è€…å</label>
              <input type="text" id="gcContact" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;" />
            </div>
            <div style="margin-bottom:12px;">
              <label style="display:block;margin-bottom:4px;">é›»è©±ç•ªå·</label>
              <input type="tel" id="gcPhone" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;" />
            </div>
            <div style="margin-bottom:12px;">
              <label style="display:block;margin-bottom:4px;">ç‰¹å…¸</label>
              <input type="text" id="gcPerks" placeholder="ä¾‹: æ‰“ã¡ã£ã±ãªã—ç„¡æ–™ ãªã©" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;" />
            </div>
            <div style="text-align:right;">
              <button type="submit" style="background:#27ae60;color:#fff;border:none;border-radius:6px;padding:10px 16px;">ä¿å­˜ã—ã¦äºˆç´„ç®¡ç†ã¸</button>
            </div>
          </form>
        </div>`;
      const form = document.getElementById('gcCreateForm');
      if (form){
        form.onsubmit = async (e)=>{
          e.preventDefault();
          const name = document.getElementById('gcName').value.trim();
          const contact = document.getElementById('gcContact').value.trim();
          const phone = document.getElementById('gcPhone').value.trim();
          const perks = document.getElementById('gcPerks').value.trim();
          if (!name){ alert('ã‚´ãƒ«ãƒ•å ´åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
          try{
            // gid ã‚’ç”Ÿæˆï¼ˆç°¡æ˜“ï¼‰
            const { data: u } = await supabase.auth.getUser();
            const generatedGid = 'g' + (u.user?.id||Date.now().toString()).slice(0,6);
            const { error } = await supabase.from('golf_courses').insert({ gid: generatedGid, email, name, contact_name: contact, phone, perks });
            if (error) throw error;
            gid = generatedGid; hasProfile = true;
            document.getElementById('welcome').textContent = `ã‚ˆã†ã“ã ${name} æ§˜`;
            // äºˆç´„ç®¡ç†ã‚’æœ‰åŠ¹åŒ–
            const mainStatus = document.getElementById('mainStatus');
            if (mainStatus) mainStatus.classList.remove('hidden');
            switchMain('stat');
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒ‰å†è¨­å®š
            initializeEventListeners();
          }catch(err){
            alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message||err));
          }
        };
      }
    }
  </script>
  
  <!-- Status Tab (existing content) -->
  <div id="mainStatus">
    <!-- Tabs -->
    <div class="tabs">
      <button id="btnTab1" class="active">ç©ºãã‚­ãƒ£ãƒ‡ã‚£ç¢ºèª</button>
      <button id="btnTabConfirm">äºˆç´„ç¢ºèª</button>
      <button id="btnTab3">ç ”ä¿®å¯èƒ½æ—¥è¨­å®š</button>
      <button id="btnTab4">ç ”ä¿®äºˆç´„è€…ä¸€è¦§</button>
    </div>

    <!-- Tab Confirm: äºˆç´„ç¢ºèª -->
    <div id="tabConfirm" class="hidden" style="margin-top:20px;">
      <div style="display:flex;align-items:center;gap:10px;">
        <button id="confPrev">â—€</button>
        <span id="confTitle"></span>
        <button id="confNext">â–¶</button>
        <button id="confReload" style="margin-left:auto;">å†èª­ã¿è¾¼ã¿</button>
      </div>
      <table style="margin-top:10px; width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="text-align:left; padding:6px; border-bottom:1px solid #eee;">æ—¥ä»˜</th>
            <th style="text-align:left; padding:6px; border-bottom:1px solid #eee;">ç¢ºå®šã‚­ãƒ£ãƒ‡ã‚£æ•°</th>
            <th style="text-align:left; padding:6px; border-bottom:1px solid #eee;">å‚åŠ ã‚­ãƒ£ãƒ‡ã‚£</th>
          </tr>
        </thead>
        <tbody id="confirmBody"></tbody>
      </table>
    </div>

    <!-- Tab 2: availability calendar -->
    <div id="tab2" class="hidden" style="margin-top:20px;">
      <div style="display:flex;align-items:center;gap:10px;">
        <button id="prevMonth">â—€</button>
        <span id="calTitle"></span>
        <button id="nextMonth">â–¶</button>
      </div>
      <table class="calendar" id="calTable" style="margin-top:10px;border-collapse:collapse;width:100%"></table>
      
    </div>

    <!-- Tab 3: Training availability -->
    <div id="tab3" class="hidden" style="margin-top:20px;">
      <h3>ç ”ä¿®å¯èƒ½æ—¥è¨­å®š</h3>
      <div style="display:flex;align-items:center;gap:10px;">
        <button id="prevTrainingMonth">â—€</button>
        <span id="trainingCalTitle"></span>
        <button id="nextTrainingMonth">â–¶</button>
      </div>
      <table class="calendar" id="trainingCalTable" style="margin-top:10px;border-collapse:collapse;width:100%"></table>
      <small style="display:block;margin-top:8px;">é’=è¨­å®šæ¸ˆã¿, ç™½=æœªè¨­å®š | ã‚¯ãƒªãƒƒã‚¯ã§è¨­å®š/è§£é™¤</small>
    </div>

    <!-- Tab 4: Training requests -->
    <div id="tab4" class="hidden" style="margin-top:20px;">
      <h3>ç ”ä¿®äºˆç´„è€…ä¸€è¦§</h3>
      <div id="trainingRequestsList"></div>
    </div>
  </div>

  <!-- Messages Tab -->
  <div id="mainMessages" class="hidden">
    <div id="messagesList"></div>
    <div id="chatInputArea" style="display:none;">
      <input id="chatInput" type="text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." autocomplete="off" />
      <button id="sendChatBtn">é€ä¿¡</button>
    </div>
  </div>



  <!-- Training slots modal -->
  <div id="trainingSlotsModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;z-index:100;">
    <div style="background:#fff;padding:24px;border-radius:8px;width:90%;max-width:400px;">
      <h3>ç ”ä¿®å¯èƒ½äººæ•°è¨­å®š</h3>
      <p id="modalDateDisplay"></p>
      <label for="slotsInput">åŒæ™‚å¯èƒ½äººæ•°:</label>
      <input type="number" id="slotsInput" min="1" max="10" value="1" style="width:100%;padding:8px;margin:8px 0;font-size:1rem;">
      <div style="margin-top:20px;text-align:right;">
        <button id="cancelSlotsModal" style="padding:8px 16px;border:1px solid #ccc;background:#f0f0f0;border-radius:4px;cursor:pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button id="saveSlotsModal" style="margin-left:10px;padding:8px 16px;border:none;background:#3498db;color:#fff;border-radius:4px;cursor:pointer;">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- New Message Modal -->
  <div id="newMessageModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); align-items:center; justify-content:center; z-index:100;">
    <div style="background:#fff; padding:24px; border-radius:8px; width:90%; max-width:500px;">
      <h3>æ–°è¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h3>
      <div style="margin-bottom:15px;">
        <label>é€ä¿¡å…ˆ:</label>
        <select id="messageReceiver" style="width:100%; padding:8px; margin-top:5px;">
          <option value="">é€ä¿¡å…ˆã‚’é¸æŠ</option>
        </select>
      </div>
      <div style="margin-bottom:15px;">
        <label>ä»¶å:</label>
        <input type="text" id="messageSubject" style="width:100%; padding:8px; margin-top:5px;">
      </div>
      <div style="margin-bottom:15px;">
        <label>å†…å®¹:</label>
        <textarea id="messageContent" rows="5" style="width:100%; padding:8px; margin-top:5px;"></textarea>
      </div>
      <div style="text-align:right;">
        <button id="cancelMessage" style="padding:8px 16px; border:1px solid #ccc; background:#f0f0f0; border-radius:4px; cursor:pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button id="sendMessage" style="margin-left:10px; padding:8px 16px; border:none; background:#3498db; color:#fff; border-radius:4px; cursor:pointer;">é€ä¿¡</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    /*
    Required Supabase table:
    
    CREATE TABLE IF NOT EXISTS public.training_availability (
      id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
      gid TEXT NOT NULL,
      date DATE NOT NULL,
      max_slots INT DEFAULT 1,
      created_at TIMESTAMP DEFAULT NOW(),
      UNIQUE(gid, date)
    );
    
    ALTER TABLE public.training_availability ENABLE ROW LEVEL SECURITY;
    */
    const supabase = window.supabase.createClient(
      "https://vqjxajzaasuqfgvhvxci.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxanhhanphYXN1cWZndmh2eGNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2MjIxMzgsImV4cCI6MjA2OTE5ODEzOH0.NmKwgZA1_-TTvMTQt07QRXtIlR-DPOPATVPuQ3QuO54"
    );

    let gid = null;
    let hasProfile = false;
    let isInitialized = false;
    // Month/Year state must be initialized before any render* is called
    let calMonth = new Date().getMonth();
    let calYear = new Date().getFullYear();
    let trainingCalMonth = new Date().getMonth();
    let trainingCalYear = new Date().getFullYear();
    // Training requests list month
    let trMonth = new Date().getMonth();
    let trYear = new Date().getFullYear();
    // Inline chat mode flag for training (no booking_id)
    let inlineTrainingMode = false;
    let confMonth = new Date().getMonth();
    let confYear = new Date().getFullYear();
    
    // 1. Check login & role and initialize everything
    supabase.auth.getUser().then(async ({ data }) => {
      if (!data.user) { location.href = "/"; return; }
      const role = data.user.user_metadata?.role;
      if (role !== "golf") { location.href = "dashboard.html"; return; }
      
      // get golf_courses row to fetch gid & name
      const { data: rows } = await supabase
        .from("golf_courses")
        .select("gid,name,contact_name,phone,perks,image_url,description")
        .eq("email", data.user.email)
        .single();
        
      if (!rows) {
        // æœªç™»éŒ²: ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä½œæˆãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤ºã—ã€äºˆç´„ç®¡ç†ã¯æ¡ˆå†…ã®ã¿ã«ã™ã‚‹
        hasProfile = false;
        const mainStatus = document.getElementById('mainStatus');
        if (mainStatus) mainStatus.classList.add('hidden');
        renderCreateProfile(data.user.email);
        // ã‚¿ãƒ–é·ç§»: äºˆç´„ç®¡ç†ã‚’æŠ¼ã—ãŸã‚‰ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä½œæˆã¸èª˜å°
        const btnStat = document.getElementById('btnMainStat');
        if (btnStat) btnStat.onclick = (e)=>{ e.preventDefault?.(); alert('ã¾ãšãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„'); switchMain('prof'); };
        const btnProf = document.getElementById('btnMainProf');
        if (btnProf) btnProf.onclick = (e)=>{ e.preventDefault?.(); switchMain('prof'); };
        switchMain('prof');
        return;
      }
      
      gid = rows.gid; hasProfile = true;
      document.getElementById("welcome").textContent = `ã‚ˆã†ã“ã ${rows.name} æ§˜`;
      
      // populate profile tab
      const profHtml = `
        <div style="max-width:800px;margin:0 auto;">
          <div style="display:flex;gap:20px;margin-bottom:20px;">
            <div style="flex-shrink:0;">
              <div id="profileImageContainer" style="width:200px;height:200px;border:2px dashed #ccc;border-radius:8px;display:flex;align-items:center;justify-content:center;background:#f9f9f9;position:relative;overflow:hidden;">
                ${rows.image_url ? 
                  `<img src="${rows.image_url}" alt="ã‚´ãƒ«ãƒ•å ´ç”»åƒ" style="width:100%;height:100%;object-fit:cover;">` : 
                  `<div style="text-align:center;color:#666;">
                    <div style="font-size:3rem;margin-bottom:10px;">ğŸŒï¸</div>
                    <div>ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>
                  </div>`
                }
                <input type="file" id="imageUpload" accept="image/*" style="position:absolute;inset:0;opacity:0;cursor:pointer;">
              </div>
              <div style="text-align:center;margin-top:8px;">
                <small style="color:#666;">ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç”»åƒã‚’å¤‰æ›´</small>
              </div>
            </div>
            
            <div style="flex:1;">
              <h3 style="margin-top:0;color:#2c3e50;">${rows.name}</h3>
              <div id="profileDescription" style="background:#f8f9fa;padding:15px;border-radius:6px;margin-bottom:15px;min-height:100px;">
                ${rows.description ? rows.description.replace(/\n/g, '<br>') : 'ã‚´ãƒ«ãƒ•å ´ã®èª¬æ˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...'}
              </div>
              <button id="editDescriptionBtn" style="background:#3498db;color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;">èª¬æ˜ã‚’ç·¨é›†</button>
            </div>
          </div>
          
          <div style="background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
            <h4 style="margin-top:0;color:#2c3e50;">åŸºæœ¬æƒ…å ±</h4>
            <table style="border-collapse:collapse;width:100%;">
              <tr><th style="text-align:left;padding:8px;border-bottom:1px solid #eee;width:120px;">ã‚´ãƒ«ãƒ•å ´å</th><td style="padding:8px;border-bottom:1px solid #eee;">${rows.name}</td></tr>
              <tr><th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">æ‹…å½“è€…å</th><td style="padding:8px;border-bottom:1px solid #eee;">${rows.contact_name||'æœªè¨­å®š'}</td></tr>
              <tr><th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">é›»è©±ç•ªå·</th><td style="padding:8px;border-bottom:1px solid #eee;">${rows.phone||'æœªè¨­å®š'}</td></tr>
              <tr><th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">ç‰¹å…¸</th><td style="padding:8px;border-bottom:1px solid #eee;">${rows.perks||'æœªè¨­å®š'}</td></tr>
            </table>
            <button id="editProfileBtn" style="background:#27ae60;color:#fff;border:none;padding:10px 20px;border-radius:4px;cursor:pointer;margin-top:15px;">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç·¨é›†</button>
          </div>
        </div>
        
        <!-- Description Edit Modal -->
        <div id="descriptionModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;z-index:100;">
          <div style="background:#fff;padding:24px;border-radius:8px;width:90%;max-width:500px;">
            <h3>ã‚´ãƒ«ãƒ•å ´èª¬æ˜ã®ç·¨é›†</h3>
            <textarea id="descriptionTextarea" placeholder="ã‚´ãƒ«ãƒ•å ´ã®ç‰¹å¾´ã€ã‚³ãƒ¼ã‚¹ã®é­…åŠ›ã€ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•ãªã©ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." style="width:100%;height:150px;padding:12px;border:1px solid #ddd;border-radius:4px;font-family:inherit;resize:vertical;"></textarea>
            <div style="margin-top:20px;text-align:right;">
              <button id="cancelDescriptionBtn" style="padding:8px 16px;border:1px solid #ccc;background:#f0f0f0;border-radius:4px;cursor:pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
              <button id="saveDescriptionBtn" style="margin-left:10px;padding:8px 16px;border:none;background:#3498db;color:#fff;border-radius:4px;cursor:pointer;">ä¿å­˜</button>
            </div>
          </div>
        </div>
        
        <!-- Profile Edit Modal -->
        <div id="profileEditModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;z-index:100;">
          <div style="background:#fff;padding:24px;border-radius:8px;width:90%;max-width:500px;">
            <h3>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã®ç·¨é›†</h3>
            <form id="profileEditForm">
              <div style="margin-bottom:15px;">
                <label style="display:block;margin-bottom:5px;font-weight:600;">æ‹…å½“è€…å</label>
                <input type="text" id="editContactName" value="${rows.contact_name||''}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
              </div>
              <div style="margin-bottom:15px;">
                <label style="display:block;margin-bottom:5px;font-weight:600;">é›»è©±ç•ªå·</label>
                <input type="tel" id="editPhone" value="${rows.phone||''}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
              </div>
              <div style="margin-bottom:15px;">
                <label style="display:block;margin-bottom:5px;font-weight:600;">ã‚­ãƒ£ãƒ‡ã‚£ç‰¹å…¸</label>
                <textarea id="editPerks" placeholder="æ‰“ã¡ã£ã±ãªã—ç„¡æ–™ã€é£Ÿäº‹æä¾›ãªã©..." style="width:100%;height:80px;padding:8px;border:1px solid #ddd;border-radius:4px;resize:vertical;">${rows.perks||''}</textarea>
              </div>
            </form>
            <div style="margin-top:20px;text-align:right;">
              <button id="cancelProfileEditBtn" style="padding:8px 16px;border:1px solid #ccc;background:#f0f0f0;border-radius:4px;cursor:pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
              <button id="saveProfileEditBtn" style="margin-left:10px;padding:8px 16px;border:none;background:#27ae60;color:#fff;border-radius:4px;cursor:pointer;">ä¿å­˜</button>
            </div>
          </div>
        </div>`;
      document.getElementById('mainProfile').innerHTML = profHtml;
      
      // æ—§UIã®æ®‹éª¸ã«ä¾å­˜ã—ãªã„ã‚ˆã†ã‚¬ãƒ¼ãƒ‰
      try {
      await loadBookings();
      } catch (e) {
        console.warn('loadBookings skipped:', e?.message || e);
      }
      
      // Initialize all event listeners after gid is set
      initializeEventListeners();
      isInitialized = true;
      
      // If currently on training requests tab, load the data
      if (document.getElementById('tab4').classList.contains('hidden') === false) {
        loadTrainingRequests();
      }
    });

    // 2. load bookings
    async function loadBookings(){
      // äºˆç´„ç¢ºèªã‚¿ãƒ–ã§æœ€æ–°çŠ¶æ…‹ã‚’æç”»ã™ã‚‹ãŸã‚ã®è£œåŠ©ã€‚æ—§UIè¦ç´ (bookBody)ãŒãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
      const tbody = document.getElementById('bookBody');
      if (!tbody) return;
      const { data, error } = await supabase
        .from('bookings')
        .select('booking_id,date,slots,status')
        .eq('gid', gid)
        .order('date', { ascending: true });
      tbody.innerHTML = '';
      if (error){ console.error(error); return; }
      (data||[]).forEach(b => {
        tbody.insertAdjacentHTML('beforeend',
          `<tr><td>${b.date}</td><td>${b.slots}</td><td>${b.status}</td></tr>`);
      });
    }

    // 3. create booking (UIãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ã‚»ãƒƒãƒˆ)
    const createFormEl = document.getElementById('createForm');
    if (createFormEl) {
      createFormEl.onsubmit = async e => {
      e.preventDefault();
        const date = document.getElementById('bDate')?.value;
        const slots = parseInt(document.getElementById('bSlots')?.value, 10);
      if (!date || !slots) return;
        const { error } = await supabase.from('bookings').insert({ gid, date, slots });
      if (error){ alert(error.message); return; }
      e.target.reset();
      loadBookings();
    };
    }

    // Training slots modal functions
    let currentEditingDate = null;
    
    function showTrainingSlotsModal(dateStr) {
      currentEditingDate = dateStr;
      document.getElementById('modalDateDisplay').textContent = `æ—¥ä»˜: ${dateStr}`;
      document.getElementById('slotsInput').value = 1;
      document.getElementById('trainingSlotsModal').style.display = 'flex';
    }
    
    async function removeTrainingAvailability(dateStr) {
      try {
        const { error } = await supabase
          .from('training_availability')
          .delete()
          .eq('gid', gid)
          .eq('date', dateStr);
        if (error) throw error;
        renderTrainingCal();
      } catch (error) {
        alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    }
    
    async function saveTrainingAvailability() {
      console.log('saveTrainingAvailability called');
      console.log('gid:', gid);
      console.log('currentEditingDate:', currentEditingDate);
      
      // DOMè¦ç´ ã®å­˜åœ¨ç¢ºèª
      const slotsInputElement = document.getElementById('slotsInput');
      if (!slotsInputElement) {
        alert('ã‚¨ãƒ©ãƒ¼: äººæ•°å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      const maxSlots = parseInt(slotsInputElement.value);
      console.log('maxSlots:', maxSlots);
      
      // ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
      if (!gid) {
        alert('ã‚¨ãƒ©ãƒ¼: ã‚´ãƒ«ãƒ•å ´æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      
      if (!currentEditingDate) {
        alert('ã‚¨ãƒ©ãƒ¼: ç·¨é›†å¯¾è±¡ã®æ—¥ä»˜ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }
      
      if (!maxSlots || maxSlots < 1 || maxSlots > 10) {
        alert('æœ‰åŠ¹ãªäººæ•°ï¼ˆ1-10ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      try {
        console.log('Inserting data:', { gid, date: currentEditingDate, max_slots: maxSlots });
        
        // Use a more robust approach with detailed error checking
        console.log('Attempting to save training availability...');
        
        // First check if the record exists
        const { data: existingData, error: checkError } = await supabase
          .from('training_availability')
          .select('id')
          .eq('gid', gid)
          .eq('date', currentEditingDate)
          .maybeSingle();
        
        console.log('Existing record check:', { existingData, checkError });
        
        let result;
        if (checkError) {
          console.error('Error checking existing record:', checkError);
          throw new Error(`ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${checkError.message || checkError.toString()}`);
        }
        
        if (existingData) {
          // Record exists, update it
          console.log('Updating existing record...');
          result = await supabase
            .from('training_availability')
            .update({ max_slots: maxSlots })
            .eq('gid', gid)
            .eq('date', currentEditingDate);
        } else {
          // Record doesn't exist, insert new one
          console.log('Inserting new record...');
          result = await supabase
            .from('training_availability')
            .insert({ gid, date: currentEditingDate, max_slots: maxSlots });
        }
        
        const { data, error } = result;
        console.log('Final operation result:', { data, error });
        
        if (error) {
          console.error('Supabase error details:', {
            message: error.message,
            code: error.code,
            details: error.details,
            hint: error.hint,
            full: error
          });
          
          // Specific error handling with more details
          let errorMessage = 'Unknown database error';
          
          if (error.code === '42P01') {
            errorMessage = 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ« "training_availability" ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚';
          } else if (error.code === '23505') {
            errorMessage = 'ã“ã®æ—¥ä»˜ã¯æ—¢ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚';
          } else if (error.code === '23503') {
            errorMessage = 'ã‚´ãƒ«ãƒ•å ´IDãŒç„¡åŠ¹ã§ã™ã€‚';
          } else if (error.code === '42501') {
            errorMessage = 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚RLSãƒãƒªã‚·ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
          } else if (error.message) {
            errorMessage = `ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: ${error.message}`;
          } else if (error.toString && typeof error.toString === 'function') {
            errorMessage = `ã‚¨ãƒ©ãƒ¼: ${error.toString()}`;
          }
          
          throw new Error(errorMessage);
        }
        
        console.log('Successfully saved training availability');
        document.getElementById('trainingSlotsModal').style.display = 'none';
        renderTrainingCal();
      } catch (error) {
        console.error('Full error object:', error);
        const errorMessage = error.message || error.toString() || 'Unknown error';
        alert('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + errorMessage);
      }
    }

    // Initialize all event listeners after gid is available
    function initializeEventListeners() {
      // --- Tabs logic ---
      const tab2=document.getElementById('tab2');
      const tab3=document.getElementById('tab3');
      const tab4=document.getElementById('tab4');
      const tabConfirm=document.getElementById('tabConfirm');
      const btnTab1=document.getElementById('btnTab1');
      const btnTabConfirm=document.getElementById('btnTabConfirm');
      const btnTab3=document.getElementById('btnTab3');
      const btnTab4=document.getElementById('btnTab4');
      
      if (btnTab1) btnTab1.onclick=()=>{switchTab(1)};
      if (btnTabConfirm) btnTabConfirm.onclick=()=>{switchTab(5)};
      if (btnTab3) btnTab3.onclick=()=>{switchTab(3)};
      if (btnTab4) btnTab4.onclick=()=>{switchTab(4)};

      // --- Calendar logic ---
      document.getElementById('prevMonth').onclick=()=>{if(--calMonth<0){calMonth=11;calYear--;} renderCal();};
      document.getElementById('nextMonth').onclick=()=>{if(++calMonth>11){calMonth=0;calYear++;} renderCal();};
      
      // Training calendar navigation
      document.getElementById('prevTrainingMonth').onclick=()=>{
        if(--trainingCalMonth<0){trainingCalMonth=11;trainingCalYear--;} 
        renderTrainingCal();
      };
      document.getElementById('nextTrainingMonth').onclick=()=>{
        if(++trainingCalMonth>11){trainingCalMonth=0;trainingCalYear++;} 
        renderTrainingCal();
      };

      // ---- main tabs ----
      const mainProfileDiv=document.getElementById('mainProfile');
      const mainStatusDiv=document.getElementById('mainStatus');
      const mainMessagesDiv=document.getElementById('mainMessages');
      const btnMainProf=document.getElementById('btnMainProf');
      const btnMainStat=document.getElementById('btnMainStat');
      const btnMainMsg=document.getElementById('btnMainMsg');
      
      // logout
      document.getElementById('logoutBtn').onclick=async()=>{await supabase.auth.signOut();location.href='/';};
      
      // Training slots modal events
      document.getElementById('cancelSlotsModal').onclick = () => {
        document.getElementById('trainingSlotsModal').style.display = 'none';
      };
      document.getElementById('saveSlotsModal').onclick = saveTrainingAvailability;
      
      // Profile image upload
      const imageUpload = document.getElementById('imageUpload');
      if (imageUpload) {
        imageUpload.onchange = handleImageUpload;
      }
      
      // Description edit modal events
      const editDescriptionBtn = document.getElementById('editDescriptionBtn');
      if (editDescriptionBtn) {
        editDescriptionBtn.onclick = () => {
          const currentDescription = document.getElementById('profileDescription').textContent;
          document.getElementById('descriptionTextarea').value = currentDescription;
          document.getElementById('descriptionModal').style.display = 'flex';
        };
      }
      
      document.getElementById('cancelDescriptionBtn').onclick = () => {
        document.getElementById('descriptionModal').style.display = 'none';
      };
      
      document.getElementById('saveDescriptionBtn').onclick = saveDescription;
      
      // Profile edit modal events
      const editProfileBtn = document.getElementById('editProfileBtn');
      if (editProfileBtn) {
        editProfileBtn.onclick = () => {
          document.getElementById('profileEditModal').style.display = 'flex';
        };
      }
      
      document.getElementById('cancelProfileEditBtn').onclick = () => {
        document.getElementById('profileEditModal').style.display = 'none';
      };
      
      document.getElementById('saveProfileEditBtn').onclick = saveProfileEdit;

      // åˆæœŸè¡¨ç¤ºã¯ã€Œç©ºãã‚­ãƒ£ãƒ‡ã‚£ç¢ºèªã€ã‚’é–‹ãï¼ˆå¹´/æœˆåˆæœŸåŒ–å¾Œï¼‰
      try { switchTab(1); } catch (e) { console.warn('switchTab init warn:', e?.message || e); }
      // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é ˜åŸŸã¯å¯¾è±¡ã‚¿ãƒ–ä»¥å¤–ã§ã¯è¡¨ç¤ºã•ã›ãªã„
      document.addEventListener('click', (ev)=>{
        const tgt = ev.target;
        if (!tgt) return;
        // äºˆç´„ç®¡ç†å†…ã‚¿ãƒ–åˆ‡æ›¿æ™‚
        if (tgt.id==='btnTab1' || tgt.id==='btnTab3' || tgt.id==='btnTabConfirm') {
          const inline = document.getElementById('inlineMessageArea');
          if (inline) inline.remove();
          inlineTrainingMode = false;
        }
        // ä¸Šæ®µãƒ¡ã‚¤ãƒ³ã‚¿ãƒ–åˆ‡æ›¿æ™‚
        if (tgt.id==='btnMainProf' || tgt.id==='btnMainStat' || tgt.id==='btnMainMsg') {
          const inline = document.getElementById('inlineMessageArea');
          if (inline) inline.remove();
          inlineTrainingMode = false;
        }
      }, true);
    }

    // --- Calendar variables (initialized at top) ---

    async function renderCal(){
      const first = new Date(calYear,calMonth,1);
      const last  = new Date(calYear,calMonth+1,0);
      document.getElementById('calTitle').textContent = `${calYear}å¹´ ${calMonth+1}æœˆ`;
      // fetch availability rows for month
      const { data, error } = await supabase
        .from('caddy_availability')
        .select('date')
        .gte('date', first.toISOString().slice(0,10))
        .lte('date', last.toISOString().slice(0,10));
      const countMap = {};
      if(!error){
        data.forEach(r=>{countMap[r.date]=(countMap[r.date]||0)+1;});
      }
      // build calendar grid
      const table=document.getElementById('calTable');
      table.innerHTML='';
      const headerRow=document.createElement('tr');
      ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].forEach(d=>{
        const th=document.createElement('th');th.textContent=d;headerRow.appendChild(th);
      });
      table.appendChild(headerRow);
      let row=document.createElement('tr');
      const startWeekDay=first.getDay();
      for(let i=0;i<startWeekDay;i++){row.appendChild(document.createElement('td'));}
      for(let day=1;day<=last.getDate();day++){
        const dateStr=`${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const td=document.createElement('td');
        const cnt=countMap[dateStr]||0;
        const labelHtml = cnt===0 ? 'Ã—' : `<span class="avail-count" data-date="${dateStr}" style="color:#3498db;font-weight:600">${cnt}äºº</span>`;
        if(cnt===0){td.className='cal-red';}
        else{td.className='';}
        td.innerHTML = `<small>${day}</small><br>${labelHtml}`;
        td.style.cursor='default';
        row.appendChild(td);
        if((startWeekDay+day)%7===0){table.appendChild(row);row=document.createElement('tr');}
      }
      if(row.children.length) {
        while(row.children.length<7)row.appendChild(document.createElement('td'));
        table.appendChild(row);
      }
    }
    // Training calendar variables (initialized at top)

    // render calendar on tab switch
    function switchTab(idx){
      // Query elements each time to avoid undefined references
      const tab2 = document.getElementById('tab2');
      const tabConfirm = document.getElementById('tabConfirm');
      const tab3 = document.getElementById('tab3');
      const tab4 = document.getElementById('tab4');
      const btnTab1 = document.getElementById('btnTab1');
      const btnTabConfirm = document.getElementById('btnTabConfirm');
      const btnTab3 = document.getElementById('btnTab3');
      const btnTab4 = document.getElementById('btnTab4');

      // Hide all tabs
      [tab2, tabConfirm, tab3, tab4].forEach(tab => tab && tab.classList.add('hidden'));
      [btnTab1, btnTabConfirm, btnTab3, btnTab4].forEach(btn => btn && btn.classList.remove('active'));
      
      if(idx===1){
        // ç©ºãã‚­ãƒ£ãƒ‡ã‚£ç¢ºèªã«åˆ‡ã‚Šæ›¿ãˆæ™‚ã¯ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¶ˆã™
        const inline = document.getElementById('inlineMessageArea');
        if (inline) inline.remove();
        inlineTrainingMode = false;
        if (tab2) tab2.classList.remove('hidden');
        if (btnTab1) btnTab1.classList.add('active');
        renderCal();
      } else if(idx===5){
        // äºˆç´„ç¢ºèªã«åˆ‡ã‚Šæ›¿ãˆæ™‚ã¯å‰æœˆã®ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³æ¬„ãŒæ®‹ã‚‰ãªã„ã‚ˆã†æ¶ˆå»
        const inline = document.getElementById('inlineMessageArea');
        if (inline) inline.remove();
        inlineTrainingMode = false;
        if (tabConfirm) tabConfirm.classList.remove('hidden');
        if (btnTabConfirm) btnTabConfirm.classList.add('active');
        renderConfirm();
      } else if(idx===3){
        // ç ”ä¿®å¯èƒ½æ—¥è¨­å®šã«åˆ‡ã‚Šæ›¿ã‚ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯æ¶ˆã™
        const inline = document.getElementById('inlineMessageArea');
        if (inline) inline.remove();
        inlineTrainingMode = false;
        if (tab3) tab3.classList.remove('hidden');
        if (btnTab3) btnTab3.classList.add('active');
        renderTrainingCal();
      } else if(idx===4){
        // ç ”ä¿®äºˆç´„è€…ä¸€è¦§ã«åˆ‡ã‚Šæ›¿ãˆæ™‚ã‚‚ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯æ¶ˆã™
        const inline = document.getElementById('inlineMessageArea');
        if (inline) inline.remove();
        inlineTrainingMode = false;
        if (tab4) tab4.classList.remove('hidden');
        if (btnTab4) btnTab4.classList.add('active');
        if (gid) {
          loadTrainingRequests();
        } else {
          const listEl = document.getElementById('trainingRequestsList');
          if (listEl) listEl.innerHTML = '<p>èª­ã¿è¾¼ã¿ä¸­...</p>';
          // Wait for gid to be initialized
          const checkGid = setInterval(() => {
            if (gid) {
              clearInterval(checkGid);
              loadTrainingRequests();
            }
          }, 100);
        }
      }
    }

    // ---- main tabs ----
    const mainProfileDiv=document.getElementById('mainProfile');
    const mainStatusDiv=document.getElementById('mainStatus');
    const mainMessagesDiv=document.getElementById('mainMessages');
    const btnMainProf=document.getElementById('btnMainProf');
    const btnMainStat=document.getElementById('btnMainStat');
    const btnMainMsg=document.getElementById('btnMainMsg');

    function switchMain(mode){
      // Query fresh elements in case DOM changed
      const mainProfileDiv=document.getElementById('mainProfile');
      const mainStatusDiv=document.getElementById('mainStatus');
      const mainMessagesDiv=document.getElementById('mainMessages');
      const btnMainProf=document.getElementById('btnMainProf');
      const btnMainStat=document.getElementById('btnMainStat');
      const btnMainMsg=document.getElementById('btnMainMsg');

      // hide all
      [mainProfileDiv, mainStatusDiv, mainMessagesDiv].forEach(el=>el && el.classList.add('hidden'));
      [btnMainProf, btnMainStat, btnMainMsg].forEach(btn=>btn && btn.classList.remove('active'));
      if(mode==='prof'){
        if (mainProfileDiv) mainProfileDiv.classList.remove('hidden');
        if (btnMainProf) btnMainProf.classList.add('active');
      } else if(mode==='stat'){
        if (mainStatusDiv) mainStatusDiv.classList.remove('hidden');
        if (btnMainStat) btnMainStat.classList.add('active');
      } else if(mode==='msg'){
        if (mainMessagesDiv) mainMessagesDiv.classList.remove('hidden');
        if (btnMainMsg) btnMainMsg.classList.add('active');
      }
    }

    // Main tab buttons (guarded)
    const _btnMainProf = document.getElementById('btnMainProf');
    const _btnMainStat = document.getElementById('btnMainStat');
    const _btnMainMsg = document.getElementById('btnMainMsg');
    if (_btnMainProf) _btnMainProf.onclick=(e)=>{ e.preventDefault?.(); switchMain('prof'); };
    if (_btnMainStat) _btnMainStat.onclick=(e)=>{ e.preventDefault?.(); switchMain('stat'); };
    if (_btnMainMsg) _btnMainMsg.onclick=(e)=>{ e.preventDefault?.(); /* hidden */ };

    // äºˆç´„ãƒãƒ¼åˆ¶å¾¡
    const reserveBar = document.getElementById('reserveBar');
    const reserveDateText = document.getElementById('reserveDateText');
    let pendingReserveDate = null;

    document.addEventListener('click', (e) => {
      const target = e.target;
      if (target && target.classList && target.classList.contains('avail-count')) {
        pendingReserveDate = target.getAttribute('data-date');
        const d = new Date(pendingReserveDate);
        reserveDateText.textContent = `${d.getFullYear()}å¹´ ${String(d.getMonth()+1)}æœˆ ${String(d.getDate())}æ—¥ ã‚’äºˆç´„ã—ã¾ã™ã‹ï¼Ÿ`;
        reserveBar.style.display = 'flex';
      }
    });

    document.getElementById('reserveCancel').onclick = () => {
      reserveBar.style.display = 'none';
      pendingReserveDate = null;
    };

    document.getElementById('reserveBtn').onclick = async () => {
      if (!pendingReserveDate) return;
      reserveBar.style.display = 'none';
      await reserveBooking(pendingReserveDate);
      pendingReserveDate = null;
    };

    // äºˆç´„å‡¦ç†
    async function reserveBooking(dateStr){
      try{
        // 1) ãã®æ—¥ã®ç©ºãã‚­ãƒ£ãƒ‡ã‚£ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«1åæŠ½å‡º
        const { data: avails, error: aErr } = await supabase
          .from('caddy_availability')
          .select('cid')
          .eq('date', dateStr);
        if(aErr) throw aErr;
        if(!avails || avails.length===0){ alert('ã“ã®æ—¥ã¯ç©ºãã‚­ãƒ£ãƒ‡ã‚£ãŒã„ã¾ã›ã‚“'); return; }
        const cidList = avails.map(a=> a.cid).filter(Boolean);
        const randomCid = cidList[Math.floor(Math.random()*cidList.length)];

        // 2) bookings å­˜åœ¨ç¢ºèª or ä½œæˆ
        const { data: existing, error: exErr } = await supabase
          .from('bookings')
          .select('booking_id')
          .eq('gid', gid)
          .eq('date', dateStr)
          .maybeSingle();
        if(exErr && exErr.code!=='PGRST116') throw exErr;
        let bookingId;
        if(existing){ bookingId = existing.booking_id; }
        else{
          const { data: created, error: crErr } = await supabase
            .from('bookings')
            .insert({ gid, date: dateStr, slots: 1, status: 'pending' })
            .select('booking_id')
            .single();
          if(crErr) throw crErr;
          bookingId = created.booking_id;
        }

        // 3) booking_caddies ã«å‰²å½“
        const { error: bcErr } = await supabase
          .from('booking_caddies')
          .insert({ booking_id: bookingId, cid: randomCid });
        if(bcErr) throw bcErr;

        // 4) caddy_availability ã‹ã‚‰è©²å½“cidã®ãã®æ—¥ã‚’å‰Šé™¤ï¼ˆã‚­ãƒ£ãƒ‡ã‚£å´ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åæ˜ ï¼‰
        const { error: delErr } = await supabase
          .from('caddy_availability')
          .delete()
          .eq('cid', randomCid)
          .eq('date', dateStr);
        if(delErr) throw delErr;

        alert('äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
        // UI æ›´æ–°
        await loadBookings();
        await renderCal();
      } catch(err){
        console.error(err);
        alert('äºˆç´„ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || JSON.stringify(err)));
      }
    }

    // Training calendar rendering
    async function renderTrainingCal(){
      if (!gid) {
        console.error('gid is not set yet');
        return;
      }
      
      const first = new Date(trainingCalYear, trainingCalMonth, 1);
      const last = new Date(trainingCalYear, trainingCalMonth + 1, 0);
      document.getElementById('trainingCalTitle').textContent = `${trainingCalYear}å¹´ ${trainingCalMonth + 1}æœˆ`;
      
      // Fetch existing training availability with slot counts
      const { data: availData, error } = await supabase
        .from('training_availability')
        .select('date, max_slots')
        .eq('gid', gid)
        .gte('date', first.toISOString().slice(0,10))
        .lte('date', last.toISOString().slice(0,10));
      
      const availabilityMap = new Map();
      if (!error && availData) {
        availData.forEach(r => availabilityMap.set(r.date, r.max_slots || 1));
      }
      
      // Build calendar grid
      const table = document.getElementById('trainingCalTable');
      table.innerHTML = '';
      const headerRow = document.createElement('tr');
      ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].forEach(d => {
        const th = document.createElement('th');
        th.textContent = d;
        headerRow.appendChild(th);
      });
      table.appendChild(headerRow);
      
      let row = document.createElement('tr');
      const startWeekDay = first.getDay();
      for(let i = 0; i < startWeekDay; i++){
        row.appendChild(document.createElement('td'));
      }
      
      for(let day = 1; day <= last.getDate(); day++){
        const dateStr = `${trainingCalYear}-${String(trainingCalMonth + 1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const td = document.createElement('td');
        const maxSlots = availabilityMap.get(dateStr);
        const isAvailable = maxSlots !== undefined;
        
        td.innerHTML = `<div style="padding:8px;text-align:center;">
          <div style="font-weight:bold;">${day}</div>
          ${isAvailable ? `<small>${maxSlots}äºº</small>` : ''}
        </div>`;
        td.style.cursor = 'pointer';
        td.style.backgroundColor = isAvailable ? '#3498db' : '#fff';
        td.style.color = isAvailable ? '#fff' : '#000';
        td.style.border = '1px solid #ccc';
        
        td.onclick = () => {
          if (!gid) {
            alert('ã‚´ãƒ«ãƒ•å ´æƒ…å ±ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
            return;
          }
          
          if (isAvailable) {
            // Show confirmation for removal
            if (confirm(`${dateStr} ã®ç ”ä¿®å¯èƒ½æ—¥è¨­å®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
              removeTrainingAvailability(dateStr);
            }
          } else {
            // Show slots modal for adding
            showTrainingSlotsModal(dateStr);
          }
        };
        
        row.appendChild(td);
        if((startWeekDay + day) % 7 === 0){
          table.appendChild(row);
          row = document.createElement('tr');
        }
      }
      
      if(row.children.length) {
        while(row.children.length < 7) row.appendChild(document.createElement('td'));
        table.appendChild(row);
      }
    }

    // Load training requests
    async function loadTrainingRequests(){
      console.log('Loading training requests for gid:', gid);
      
      const container = document.getElementById('trainingRequestsList');
      
      if (!gid) {
        console.error('gid is not set when loading training requests');
        container.innerHTML = '<p>ã‚´ãƒ«ãƒ•å ´æƒ…å ±ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚</p>';
        return;
      }
      
      try {
        // First get training requests
        console.log('Querying training_requests for gid:', gid);
        
        // ã¾ãšã€training_requestsãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
        const { data: tableCheck, error: tableError } = await supabase
          .from('training_requests')
          .select('id')
          .limit(1);
        
        console.log('Table check result:', { tableCheck, tableError });
        
      // å½“æœˆãƒ•ã‚£ãƒ«ã‚¿
      const first = `${trainingCalYear}-${String(trainingCalMonth+1).padStart(2,'0')}-01`;
      const lastDate = new Date(trainingCalYear, trainingCalMonth+1, 0).getDate();
      const last = `${trainingCalYear}-${String(trainingCalMonth+1).padStart(2,'0')}-${String(lastDate).padStart(2,'0')}`;
        const { data: requests, error: requestsError } = await supabase
          .from('training_requests')
          .select('id, cid, training_date, status, created_at')
          .eq('gid', gid)
          .gte('training_date', first)
          .lte('training_date', last)
          .order('training_date', { ascending: false });
        
        console.log('Training requests query result:', { requests, requestsError });
        
        if (requestsError) {
          console.error('Error loading training requests:', requestsError);
          container.innerHTML = `<p>ã‚¨ãƒ©ãƒ¼: ${requestsError.message}</p>`;
          return;
        }
        
        if (!requests || requests.length === 0) {
          console.log('No training requests found');
          container.innerHTML = '<p>ç ”ä¿®äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
          return;
        }
        
        // Then get caddy details for each request
        const cidList = requests.map(r => r.cid);
        const { data: caddies, error: caddiesError } = await supabase
          .from('caddies')
          .select('cid, name, phone, email, university, golf_years, caddy_years, appeal')
          .in('cid', cidList);
        
        console.log('Caddies query result:', { caddies, caddiesError });
        
        if (caddiesError) {
          console.error('Error loading caddies:', caddiesError);
          container.innerHTML = `<p>ã‚¨ãƒ©ãƒ¼: ${caddiesError.message}</p>`;
          return;
        }
        
        // Create a map for quick lookup
        const caddyMap = new Map();
        if (caddies) {
          caddies.forEach(c => caddyMap.set(c.cid, c));
        }
        
        // Combine the data
        const data = requests.map(request => ({
          ...request,
          caddies: caddyMap.get(request.cid) || {}
        }));
        
        console.log('Combined training requests data:', data);
        
        if (!data || data.length === 0) {
          console.log('No training requests found for this golf course');
          // Also try to load all requests to see if any exist
          const { data: allData, error: allError } = await supabase
            .from('training_requests')
            .select('id, gid, cid, training_date, status, created_at');
          
          console.log('All training requests in database:', { allData, allError });
          
          // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šç¾åœ¨ã®gidã¨ä¸€è‡´ã™ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç¢ºèª
          if (allData && allData.length > 0) {
            const matchingRequests = allData.filter(req => req.gid === gid);
            console.log('Matching requests for current gid:', matchingRequests);
          }
          
          container.innerHTML = '<p>ç ”ä¿®äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
          return;
        }
        
        let html = '';
        data.forEach((request, index) => {
        const caddy = request.caddies;
        const statusText = request.status === 'pending' ? 'ç”³è¾¼ä¸­' : 
                          request.status === 'confirmed' ? 'ç¢ºå®š' : 
                          request.status === 'completed' ? 'å®Œäº†' : 'å–æ¶ˆ';
        const statusColor = request.status === 'pending' ? '#f39c12' : 
                           request.status === 'confirmed' ? '#27ae60' : 
                           request.status === 'completed' ? '#3498db' : '#e74c3c';
        
        html += `
          <div class="training-request-item" style="border:1px solid #ddd; margin-bottom:8px; padding:12px; border-radius:6px; background:#fff; cursor:pointer;" onclick="toggleRequestDetail('${request.id}')">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div>
                <strong>${caddy?.name || 'ä¸æ˜'}</strong>
                <span style="color:#666; margin-left:10px;">å¸Œæœ›ç ”ä¿®æ—¥: ${request.training_date || 'æ—¥ä»˜æœªé¸æŠ'}</span>
              </div>
              <span style="display:flex; align-items:center; gap:8px;">
                <button class="trProfile" data-cid="${caddy?.cid||''}" onclick="event.stopPropagation()">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</button>
                <button class="trMessage" data-cid="${caddy?.cid||''}" data-date="${request.training_date}" onclick="event.stopPropagation()">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</button>
              <span style="background:${statusColor}; color:#fff; padding:4px 8px; border-radius:4px; font-size:0.9em;">${statusText}</span>
              </span>
            </div>
            
            <div id="detail-${request.id}" class="request-detail" style="display:none; margin-top:12px; padding-top:12px; border-top:1px solid #eee;">
              <h5>ã‚­ãƒ£ãƒ‡ã‚£è©³ç´°æƒ…å ±</h5>
              <p><strong>ç”³è¾¼æ—¥:</strong> ${request.created_at?.slice(0,10) || 'ä¸æ˜'}</p>
              <p><strong>é›»è©±:</strong> ${caddy?.phone || 'ä¸æ˜'}</p>
              <p><strong>ãƒ¡ãƒ¼ãƒ«:</strong> ${caddy?.email || 'ä¸æ˜'}</p>
              <p><strong>å¤§å­¦:</strong> ${caddy?.university || 'ä¸æ˜'}</p>
              <p><strong>ã‚´ãƒ«ãƒ•æ­´:</strong> ${caddy?.golf_years || 'ä¸æ˜'}å¹´</p>
              <p><strong>ã‚­ãƒ£ãƒ‡ã‚£æ­´:</strong> ${caddy?.caddy_years || 'ä¸æ˜'}å¹´</p>
              <p><strong>ã‚¢ãƒ”ãƒ¼ãƒ«:</strong> ${caddy?.appeal || 'ãªã—'}</p>
              
              ${request.status === 'pending' ? `
                <div style="margin-top:12px;">
                  <button onclick="event.stopPropagation(); updateTrainingStatus('${request.id}', 'confirmed')" style="background:#2ecc71; color:#fff; border:none; padding:8px 16px; border-radius:4px; cursor:pointer; margin-right:8px;">æ‰¿èª</button>
                  <button onclick="event.stopPropagation(); updateTrainingStatus('${request.id}', 'cancelled')" style="background:#e74c3c; color:#fff; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">æ‹’å¦</button>
                </div>
              ` : ''}
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;

      // ç ”ä¿®: ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
      Array.from(document.getElementsByClassName('trProfile')).forEach(btn=>{
        btn.onclick = async (e)=>{
          const cid = e.currentTarget.getAttribute('data-cid');
          if (!cid) return;
          const { data: caddy, error } = await supabase
            .from('caddies')
            .select('cid,name,phone,email,university,golf_years,caddy_years,appeal,avatar_url')
            .eq('cid', cid)
            .maybeSingle();
          if (error) { alert(error.message); return; }
          const modal = document.createElement('div');
          modal.style.cssText = 'position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:200;';
          modal.innerHTML = `
            <div style="background:#fff; width:92%; max-width:520px; border-radius:10px; padding:16px;">
              <h3 style="margin:0 0 8px;">ã‚­ãƒ£ãƒ‡ã‚£ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h3>
              <div style="display:flex; gap:12px;">
                <img src="${caddy?.avatar_url||''}" alt="avatar" style="width:96px;height:96px;border-radius:50%;object-fit:cover;background:#eee;"/>
                <div>
                  <div><b>æ°å:</b> ${caddy?.name||'-'}</div>
                  <div><b>å¤§å­¦:</b> ${caddy?.university||'-'}</div>
                  <div><b>ã‚´ãƒ«ãƒ•çµŒé¨“:</b> ${caddy?.golf_years||'-'} å¹´</div>
                  <div><b>ã‚­ãƒ£ãƒ‡ã‚£çµŒé¨“:</b> ${caddy?.caddy_years||'-'} å¹´</div>
                </div>
              </div>
              <div style="margin-top:10px; white-space:pre-wrap; background:#f8f9fa; border:1px solid #eee; padding:10px; border-radius:6px;">${caddy?.appeal||''}</div>
              <div style="text-align:right;margin-top:12px;">
                <button id="trProfileCloseBtn" style="background:#eee;border:1px solid #ddd;border-radius:6px;padding:8px 12px;cursor:pointer;">é–‰ã˜ã‚‹</button>
              </div>
            </div>`;
          document.body.appendChild(modal);
          document.getElementById('trProfileCloseBtn').onclick=()=>{ document.body.removeChild(modal); };
        };
      });

      // ç ”ä¿®: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆå½“æœˆãƒ»ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ï¼‰
      Array.from(document.getElementsByClassName('trMessage')).forEach(btn=>{
        btn.onclick = async (e)=>{
          const cid = e.currentTarget.getAttribute('data-cid');
          chatPartnerId = cid;
          chatPartnerName = 'ç ”ä¿®å¸Œæœ›ã‚­ãƒ£ãƒ‡ã‚£';
          currentBookingId = `training:${trainingCalYear}-${String(trainingCalMonth+1).padStart(2,'0')}`; // æ“¬ä¼¼IDï¼ˆmessagesã®booking_idåˆ—ãŒNULLè¨±å®¹ãªã‚‰åˆ¥åˆ†å²å¯ï¼‰
          const mainStatusDiv = document.getElementById('mainStatus');
          if (mainStatusDiv) {
            let inline = document.getElementById('inlineMessageArea');
            if (!inline) {
              inline = document.createElement('div');
              inline.id = 'inlineMessageArea';
              inline.innerHTML = `
                <div style=\"margin-top:12px; background:#fff; border:1px solid #eee; border-radius:8px;\">
                  <div id=\"inlineMessagesList\" style=\"max-height:260px; overflow:auto; padding:12px;\"></div>
                  <div style=\"display:flex; gap:8px; padding:12px; border-top:1px solid #eee;\">
                    <input id=\"inlineChatInput\" type=\"text\" placeholder=\"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...\" style=\"flex:1; padding:8px; border:1px solid #ccc; border-radius:6px;\" />
                    <button id=\"inlineSendChatBtn\" style=\"background:#27ae60;color:#fff;border:none;border-radius:6px;padding:8px 14px;\">é€ä¿¡</button>
                  </div>
                </div>`;
              mainStatusDiv.appendChild(inline);
            }
            inlineTrainingMode = true;
            await loadChatMessages(true);
            const sendBtn = document.getElementById('inlineSendChatBtn');
            const inputEl = document.getElementById('inlineChatInput');
            if (sendBtn && inputEl) {
              sendBtn.onclick = async ()=>{ await sendChatMessage(true); };
              inputEl.onkeydown = (ev)=>{ if (ev.key==='Enter') sendBtn.click(); };
            }
          }
        };
      });
      } catch (error) {
        console.error('Error in loadTrainingRequests:', error);
        const errorMessage = error.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
        document.getElementById('trainingRequestsList').innerHTML = `<p>èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${errorMessage}</p>`;
      }
    }

    // Toggle training request detail display
    window.toggleRequestDetail = function(requestId) {
      const detailElement = document.getElementById(`detail-${requestId}`);
      if (detailElement) {
        detailElement.style.display = detailElement.style.display === 'none' ? 'block' : 'none';
      }
    }

    // Update training request status
    window.updateTrainingStatus = async (requestId, status) => {
      const { error } = await supabase
        .from('training_requests')
        .update({ status, updated_at: new Date().toISOString() })
        .eq('id', requestId);
      
      if (error) {
        alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      } else {
        alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
        
        // æ‰¿èªã®å ´åˆã€ã‚­ãƒ£ãƒ‡ã‚£ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
        if (status === 'confirmed') {
          const request = await supabase
            .from('training_requests')
            .select('cid, training_date')
            .eq('id', requestId)
            .single();
          
          if (request.data) {
            const caddy = await supabase
              .from('caddies')
              .select('name')
              .eq('cid', request.data.cid)
              .single();
            
            if (caddy.data) {
              await sendMessageToCaddy(request.data.cid, caddy.data.name, request.data.training_date);
            }
          }
        }
        
        loadTrainingRequests(); // Reload the list
      }
    };

    // Send message to caddy when training is confirmed
    async function sendMessageToCaddy(cid, caddyName, trainingDate) {
      try {
        const { error } = await supabase
          .from('messages')
          .insert({
            sender_type: 'golf_course',
            sender_id: gid,
            receiver_type: 'caddy',
            receiver_id: cid,
            subject: 'ç ”ä¿®æ‰¿èªã®ãŠçŸ¥ã‚‰ã›',
            content: `${caddyName}æ§˜\n\nç ”ä¿®ç”³è¾¼ãŒæ‰¿èªã•ã‚Œã¾ã—ãŸã€‚\nç ”ä¿®æ—¥: ${trainingDate}\n\nè©³ç´°ã«ã¤ã„ã¦ã¯ã€ãŠé›»è©±ã¾ãŸã¯ãƒ¡ãƒ¼ãƒ«ã§ã”é€£çµ¡ã„ãŸã—ã¾ã™ã€‚\n\nã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`
          });
        
        if (error) {
          console.error('Message send error:', error);
        }
      } catch (error) {
        console.error('Message send error:', error);
      }
    }

    // Load messages
    async function loadMessages(type = 'inbox') {
      console.log('Loading messages for type:', type, 'gid:', gid);
      const messagesList = document.getElementById('messagesList');
      
      if (!messagesList) {
        console.error('messagesList element not found');
        return;
      }
      
      try {
        let query;
        if (type === 'inbox') {
          query = supabase
          .from('messages')
          .select('*')
            .eq('receiver_type', 'golf_course')
            .eq('receiver_id', gid)
          .order('created_at', { ascending: false });
        } else {
          query = supabase
            .from('messages')
            .select('*')
            .eq('sender_type', 'golf_course')
            .eq('sender_id', gid)
            .order('created_at', { ascending: false });
        }
        
        const { data: messages, error } = await query;
        
        if (error) {
          messagesList.innerHTML = `<p>ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
          return;
        }
        
        if (!messages || messages.length === 0) {
          messagesList.innerHTML = '<p>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
          return;
        }
        
        let html = '';
        messages.forEach(message => {
          const isUnread = type === 'inbox' && !message.is_read;
          html += `
            <div style="border:1px solid #ddd; margin-bottom:8px; padding:12px; border-radius:6px; background:${isUnread ? '#f8f9fa' : '#fff'};">
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                  <strong>${message.subject}</strong>
                  ${isUnread ? '<span style="background:#e74c3c; color:#fff; padding:2px 6px; border-radius:3px; font-size:0.8em; margin-left:8px;">æœªèª­</span>' : ''}
                </div>
                <small style="color:#666;">${message.created_at?.slice(0,16).replace('T', ' ')}</small>
              </div>
              <p style="margin:8px 0; color:#666;">${message.content.substring(0, 100)}${message.content.length > 100 ? '...' : ''}</p>
            </div>
          `;
        });
        
        messagesList.innerHTML = html;
      } catch (error) {
        messagesList.innerHTML = `<p>ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
      }
    }

    // Load caddies for message receiver selection
    async function loadCaddiesForMessage() {
      try {
        const { data: caddies, error } = await supabase
          .from('caddies')
          .select('cid, name, university')
          .order('name');
        
        if (error) {
          console.error('Error loading caddies:', error);
          return;
        }
        
        const select = document.getElementById('messageReceiver');
        select.innerHTML = '<option value="">é€ä¿¡å…ˆã‚’é¸æŠ</option>';
        
        if (caddies) {
          caddies.forEach(caddy => {
            select.innerHTML += `<option value="${caddy.cid}">${caddy.name} (${caddy.university})</option>`;
          });
        }
      } catch (error) {
        console.error('Error loading caddies:', error);
      }
    }

    // Send new message
    async function sendNewMessage() {
      const receiverId = document.getElementById('messageReceiver').value;
      const subject = document.getElementById('messageSubject').value.trim();
      const content = document.getElementById('messageContent').value.trim();
      
      if (!receiverId || !subject || !content) {
        alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      
      try {
        const { error } = await supabase
          .from('messages')
          .insert({
            sender_type: 'golf_course',
            sender_id: gid,
            receiver_type: 'caddy',
            receiver_id: receiverId,
            subject: subject,
            content: content
          });
        
        if (error) {
          alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        } else {
          alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã—ãŸ');
          document.getElementById('newMessageModal').style.display = 'none';
          document.getElementById('messageSubject').value = '';
          document.getElementById('messageContent').value = '';
          loadMessages('sent');
        }
      } catch (error) {
        alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // Profile image upload handler
    async function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      if (file.size > 5 * 1024 * 1024) { // 5MB limit
        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯5MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„');
        return;
      }
      
      try {
        // Upload to Supabase Storage
        const fileExt = file.name.split('.').pop();
        const fileName = `${gid}_${Date.now()}.${fileExt}`;
        
        const { data: uploadData, error: uploadError } = await supabase.storage
          .from('golf-course-images')
          .upload(fileName, file);
        
        if (uploadError) throw uploadError;
        
        // Get public URL
        const { data: urlData } = supabase.storage
          .from('golf-course-images')
          .getPublicUrl(fileName);
        
        // Update database
        const { error: updateError } = await supabase
          .from('golf_courses')
          .update({ image_url: urlData.publicUrl })
          .eq('gid', gid);
        
        if (updateError) throw updateError;
        
        // Update UI
        const container = document.getElementById('profileImageContainer');
        container.innerHTML = `<img src="${urlData.publicUrl}" alt="ã‚´ãƒ«ãƒ•å ´ç”»åƒ" style="width:100%;height:100%;object-fit:cover;">
                              <input type="file" id="imageUpload" accept="image/*" style="position:absolute;inset:0;opacity:0;cursor:pointer;">`;
        
        // Re-attach event listener
        document.getElementById('imageUpload').onchange = handleImageUpload;
        
        alert('ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
      } catch (error) {
        console.error('Image upload error:', error);
        alert('ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // Save description
    async function saveDescription() {
      const description = document.getElementById('descriptionTextarea').value.trim();
      
      try {
        const { error } = await supabase
          .from('golf_courses')
          .update({ description })
          .eq('gid', gid);
        
        if (error) throw error;
        
        // Update UI
        document.getElementById('profileDescription').innerHTML = description.replace(/\n/g, '<br>');
        document.getElementById('descriptionModal').style.display = 'none';
        
        alert('èª¬æ˜ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
      } catch (error) {
        console.error('Description save error:', error);
        alert('èª¬æ˜ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // Save profile edit
    async function saveProfileEdit() {
      const contactName = document.getElementById('editContactName').value.trim();
      const phone = document.getElementById('editPhone').value.trim();
      const perks = document.getElementById('editPerks').value.trim();
      
      try {
        const { error } = await supabase
          .from('golf_courses')
          .update({ 
            contact_name: contactName,
            phone: phone,
            perks: perks
          })
          .eq('gid', gid);
        
        if (error) throw error;
        
        // Update UI
        const profileTable = document.querySelector('#mainProfile table');
        if (profileTable) {
          const rows = profileTable.querySelectorAll('tr');
          rows[1].cells[1].textContent = contactName || 'æœªè¨­å®š';
          rows[2].cells[1].textContent = phone || 'æœªè¨­å®š';
          rows[3].cells[1].textContent = perks || 'æœªè¨­å®š';
        }
        
        document.getElementById('profileEditModal').style.display = 'none';
        
        alert('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
      } catch (error) {
        console.error('Profile edit error:', error);
        alert('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    /* --- LINEé¢¨ãƒãƒ£ãƒƒãƒˆUI --- */
    // ãƒãƒ£ãƒƒãƒˆUIç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—ãƒ»è¡¨ç¤º
    let chatPartnerId = null; // ãƒãƒ£ãƒƒãƒˆç›¸æ‰‹ID
    let chatPartnerName = '';
    let currentBookingId = null; // ç¾åœ¨ã®äºˆå®šID

    // äºˆå®šä¸€è¦§ã‚’è¡¨ç¤º
    async function showBookingList() {
      const messagesList = document.getElementById('messagesList');
      messagesList.innerHTML = '<div style="text-align:center;color:#aaa;">èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      // ã‚´ãƒ«ãƒ•å ´ã®äºˆå®šã‚’å–å¾—ï¼ˆç¾åœ¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã¯å½“æœˆã®ã¿ï¼‰
      const first = `${calYear}-${String(calMonth+1).padStart(2,'0')}-01`;
      const lastDate = new Date(calYear, calMonth+1, 0).getDate();
      const last = `${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(lastDate).padStart(2,'0')}`;
      const { data: bookings, error } = await supabase
        .from('bookings')
                  .select(`
            *,
            booking_caddies (
              cid,
              caddies (
                cid,
                name
              )
            )
          `)
        .eq('gid', gid)
        .gte('date', first)
        .lte('date', last)
        .order('date', { ascending: false });

      if (error) {
        messagesList.innerHTML = `<div style='color:#e74c3c;'>ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
        return;
      }

      if (!bookings || bookings.length === 0) {
        messagesList.innerHTML = '<div style="text-align:center;color:#aaa;">äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      messagesList.innerHTML = '<h3 style="margin-bottom:16px;color:#333;">äºˆå®šä¸€è¦§</h3>';
      bookings.forEach(booking => {
        const bookingDiv = document.createElement('div');
        bookingDiv.style.cssText = `
          background: #fff;
          border: 1px solid #e0e0e0;
          border-radius: 8px;
          padding: 12px;
          margin-bottom: 8px;
          cursor: pointer;
          transition: background 0.2s;
        `;
        bookingDiv.onmouseover = () => bookingDiv.style.background = '#f5f5f5';
        bookingDiv.onmouseout = () => bookingDiv.style.background = '#fff';
        
        const caddyNames = booking.booking_caddies?.map(bc => bc.caddies?.name).filter(Boolean).join(', ') || 'ã‚­ãƒ£ãƒ‡ã‚£æœªç¢ºå®š';
        const date = booking.date || 'ä¸æ˜';
        
        bookingDiv.innerHTML = `
          <div style="font-weight:bold;color:#333;">${date}</div>
          <div style="color:#666;font-size:0.9rem;">ã‚­ãƒ£ãƒ‡ã‚£: ${caddyNames}</div>
          <div style="color:#27ae60;font-size:0.8rem;margin-top:4px;">ã‚¿ãƒƒãƒ—ã—ã¦ãƒãƒ£ãƒƒãƒˆ</div>
        `;
        
        bookingDiv.onclick = () => {
          currentBookingId = booking.booking_id;
          // æœ€åˆã®ã‚­ãƒ£ãƒ‡ã‚£ã¨ãƒãƒ£ãƒƒãƒˆï¼ˆæœ¬æ¥ã¯é¸æŠUIãŒå¿…è¦ï¼‰
          const firstCaddy = booking.booking_caddies?.[0];
          if (firstCaddy) {
            chatPartnerId = firstCaddy.cid;
            chatPartnerName = firstCaddy.caddies?.name || 'ã‚­ãƒ£ãƒ‡ã‚£';
            loadChatMessages();
          } else {
            alert('ã“ã®äºˆå®šã«ã¯ã‚­ãƒ£ãƒ‡ã‚£ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã¾ã›ã‚“');
          }
        };
        
        messagesList.appendChild(bookingDiv);
      });
    }

    async function loadChatMessages(inline=false) {
      if (!chatPartnerId || !currentBookingId) {
        // å…¥åŠ›æ¬„ã‚’éš ã™
        const area = inline ? document.getElementById('inlineMessageArea') : document.getElementById('chatInputArea');
        if (!inline && area) area.style.display = 'none';
        if (!inline) showBookingList();
        return;
      }

      const messagesList = inline ? document.getElementById('inlineMessagesList') : document.getElementById('messagesList');
      messagesList.innerHTML = `
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;padding:8px;background:#f0f0f0;border-radius:8px;">
          <button onclick="showBookingList()" style="background:none;border:none;cursor:pointer;font-size:1.2rem;">â†</button>
          <div>
            <div style="font-weight:bold;">${chatPartnerName}</div>
            <div style="font-size:0.8rem;color:#666;">äºˆå®šã«é–¢ã™ã‚‹é€£çµ¡</div>
          </div>
        </div>
      `;

      // å…¥åŠ›æ¬„ã‚’è¡¨ç¤º
      if (!inline) document.getElementById('chatInputArea').style.display = 'flex';

      // äºˆå®šã«é–¢é€£ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
      let messages, error;
      if (inlineTrainingMode) {
        ({ data: messages, error } = await supabase
          .from('messages')
          .select('*')
          .or(`and(sender_id.eq.${gid},receiver_id.eq.${chatPartnerId}),and(sender_id.eq.${chatPartnerId},receiver_id.eq.${gid})`)
          .is('booking_id', null)
          .order('created_at', { ascending: true }));
      } else {
        ({ data: messages, error } = await supabase
          .from('messages')
          .select('*')
          .or(`and(sender_id.eq.${gid},receiver_id.eq.${chatPartnerId}),and(sender_id.eq.${chatPartnerId},receiver_id.eq.${gid})`)
          .eq('booking_id', currentBookingId)
          .order('created_at', { ascending: true }));
      }

      if (error) {
        messagesList.innerHTML += `<div style='color:#e74c3c;'>ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
        return;
      }

      if (!messages || messages.length === 0) {
        messagesList.innerHTML += '<div style="text-align:center;color:#aaa;margin-top:20px;">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
      } else {
        messages.forEach(msg => {
          const isSent = msg.sender_id === gid;
          const bubble = document.createElement('div');
          bubble.className = 'chat-bubble ' + (isSent ? 'sent' : 'received');
          bubble.innerHTML = `${msg.content}<div class='chat-meta${isSent ? '' : ' received'}'>${new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}${msg.is_read ? "<span class='chat-badge read'>æ—¢èª­</span>" : (!isSent ? "<span class='chat-badge unread'>æœªèª­</span>" : '')}</div>`;
          messagesList.appendChild(bubble);
        });
      }
      
      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æœ€ä¸‹éƒ¨ã¸
      messagesList.scrollTop = messagesList.scrollHeight;
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    async function sendChatMessage(inline=false) {
      const input = inline ? document.getElementById('inlineChatInput') : document.getElementById('chatInput');
      const content = input.value.trim();
      if (!content || !chatPartnerId || !currentBookingId) return;
      
      const { error } = await supabase.from('messages').insert({
        sender_type: 'golf_course', 
        sender_id: gid,
        receiver_type: 'caddy', 
        receiver_id: chatPartnerId,
        booking_id: inlineTrainingMode ? null : currentBookingId,
        subject: 'äºˆå®šã«é–¢ã™ã‚‹é€£çµ¡',
        content,
        is_read: false
      });
      
      if (error) {
        alert('é€ä¿¡ã‚¨ãƒ©ãƒ¼: ' + error.message);
        return;
      }
      
      input.value = '';
      loadChatMessages();
    }

    document.getElementById('sendChatBtn').onclick = sendChatMessage;
    document.getElementById('chatInput').onkeydown = e => { if (e.key === 'Enter') sendChatMessage(); };

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ãƒ–ã‚’é–‹ã„ãŸã‚‰äºˆå®šä¸€è¦§ã‚’è¡¨ç¤º
    async function showChatWithCaddy() {
      showBookingList();
    }



    // æ³¨: ãƒ©ãƒ³ãƒ€ãƒ å·®é…æ–¹é‡ã®ãŸã‚ã€ç©ºãã‚­ãƒ£ãƒ‡ã‚£ä¸€è¦§ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã¯å»ƒæ­¢
// å¿…è¦ãªå ´åˆã¯ã€ç¢ºå®šæ™‚ã«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚


    // äºˆç´„ç¢ºèªï¼šå½“æœˆã®äºˆç´„ï¼ˆbookingsï¼‹booking_caddiesï¼‹caddiesï¼‰
    async function renderConfirm(){
      const title = document.getElementById('confTitle');
      title.textContent = `${confYear}å¹´ ${confMonth+1}æœˆ`;
      const tbody = document.getElementById('confirmBody');
      tbody.innerHTML = '<tr><td colspan="3" style="padding:8px;color:#888;">èª­ã¿è¾¼ã¿ä¸­...</td></tr>';
      const first = `${confYear}-${String(confMonth+1).padStart(2,'0')}-01`;
      const lastDate = new Date(confYear, confMonth+1, 0).getDate();
      const last = `${confYear}-${String(confMonth+1).padStart(2,'0')}-${String(lastDate).padStart(2,'0')}`;
      const { data: bookings, error } = await supabase
        .from('bookings')
        .select(`
          booking_id,date,
          booking_caddies!inner (
            cid,
            caddies (cid,name,phone,email,university)
          )
        `)
        .eq('gid', gid)
        .gte('date', first)
        .lte('date', last)
        .order('date', { ascending: true });
      if(error){ tbody.innerHTML = `<tr><td colspan='3' style='padding:8px;color:#e74c3c;'>${error.message}</td></tr>`; return; }
      if(!bookings || bookings.length===0){ tbody.innerHTML = `<tr><td colspan='3' style='padding:8px;color:#888;'>å½“æœˆã®äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>`; return; }
      tbody.innerHTML='';
      bookings.forEach(b=>{
        const cList = b.booking_caddies?.map(bc => bc.caddies?.name || bc.cid).filter(Boolean) || [];
        const count = cList.length;
        const names = cList.map(n=>`<span style='margin-right:8px;'>${n}</span>`).join('');
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style='padding:8px;border-bottom:1px solid #eee;'>${b.date}</td>
          <td style='padding:8px;border-bottom:1px solid #eee;'>${count} å</td>
          <td style='padding:8px;border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; gap:8px;'>
            <span>${names}</span>
            <span>
              <button data-bid='${b.booking_id}' class='btnProfile' style='margin-right:8px;'>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</button>
              <button data-bid='${b.booking_id}' class='btnMsgToCaddies'>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</button>
            </span>
          </td>
        `;
        tbody.appendChild(tr);
      });
      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å°ç·šï¼ˆè©²å½“äºˆç´„ã®å„ã‚­ãƒ£ãƒ‡ã‚£ã¨å€‹åˆ¥ã«ï¼‰
      Array.from(document.getElementsByClassName('btnMsgToCaddies')).forEach(btn=>{
        btn.onclick = async (e)=>{
          const bid = e.currentTarget.getAttribute('data-bid');
          // äºˆç´„ã®æœ€åˆã®ã‚­ãƒ£ãƒ‡ã‚£ã¸ï¼ˆæœ¬æ¥ã¯é¸æŠUIã«æ‹¡å¼µå¯èƒ½ï¼‰
          const b = bookings.find(x=>x.booking_id===bid);
          const firstCaddy = b?.booking_caddies?.[0]?.cid;
          if(firstCaddy){
            currentBookingId = bid;
            chatPartnerId = firstCaddy;
            chatPartnerName = b.booking_caddies?.[0]?.caddies?.name || 'ã‚­ãƒ£ãƒ‡ã‚£';
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ¬„ã‚’äºˆç´„è€…ä¸€è¦§ã®ä¸‹ã«å±•é–‹
            const mainStatusDiv = document.getElementById('mainStatus');
            if (mainStatusDiv) {
              const existing = document.getElementById('inlineMessageArea');
              if (!existing) {
                const inline = document.createElement('div');
                inline.id = 'inlineMessageArea';
                inline.innerHTML = `
                  <div style="margin-top:12px; background:#fff; border:1px solid #eee; border-radius:8px;">
                    <div id="inlineMessagesList" style="max-height:260px; overflow:auto; padding:12px;"></div>
                    <div style="display:flex; gap:8px; padding:12px; border-top:1px solid #eee;">
                      <input id="inlineChatInput" type="text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." style="flex:1; padding:8px; border:1px solid #ccc; border-radius:6px;" />
                      <button id="inlineSendChatBtn" style="background:#27ae60;color:#fff;border:none;border-radius:6px;padding:8px 14px;">é€ä¿¡</button>
                    </div>
                  </div>`;
                mainStatusDiv.appendChild(inline);
              }
              inlineTrainingMode = false;
              await loadChatMessages(true);
              const sendBtn = document.getElementById('inlineSendChatBtn');
              const inputEl = document.getElementById('inlineChatInput');
              if (sendBtn && inputEl) {
                sendBtn.onclick = async ()=>{
                  await sendChatMessage(true);
                };
                inputEl.onkeydown = (ev)=>{ if (ev.key==='Enter') sendBtn.click(); };
              }
            }
          }
        };
      });

      // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ï¼ˆã‚­ãƒ£ãƒ‡ã‚£ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤ºï¼‰
      Array.from(document.getElementsByClassName('btnProfile')).forEach(btn=>{
        btn.onclick = async (e)=>{
          const bid = e.currentTarget.getAttribute('data-bid');
          const b = bookings.find(x=>x.booking_id===bid);
          const first = b?.booking_caddies?.[0]?.cid;
          if (!first) return;
          const { data: caddy, error } = await supabase
            .from('caddies')
            .select('cid,name,phone,email,university,golf_years,caddy_years,appeal,avatar_url')
            .eq('cid', first)
            .maybeSingle();
          if (error) { alert(error.message); return; }
          const modal = document.createElement('div');
          modal.style.cssText = 'position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:200;';
          modal.innerHTML = `
            <div style="background:#fff; width:92%; max-width:520px; border-radius:10px; padding:16px;">
              <h3 style="margin:0 0 8px;">ã‚­ãƒ£ãƒ‡ã‚£ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h3>
              <div style="display:flex; gap:12px;">
                <img src="${caddy?.avatar_url||''}" alt="avatar" style="width:96px;height:96px;border-radius:50%;object-fit:cover;background:#eee;"/>
                <div>
                  <div><b>æ°å:</b> ${caddy?.name||'-'}</div>
                  <div><b>å¤§å­¦:</b> ${caddy?.university||'-'}</div>
                  <div><b>ã‚´ãƒ«ãƒ•çµŒé¨“:</b> ${caddy?.golf_years||'-'} å¹´</div>
                  <div><b>ã‚­ãƒ£ãƒ‡ã‚£çµŒé¨“:</b> ${caddy?.caddy_years||'-'} å¹´</div>
                </div>
              </div>
              <div style="margin-top:10px; white-space:pre-wrap; background:#f8f9fa; border:1px solid #eee; padding:10px; border-radius:6px;">
                ${caddy?.appeal||''}
              </div>
              <div style="text-align:right;margin-top:12px;">
                <button id="profileCloseBtn" style="background:#eee;border:1px solid #ddd;border-radius:6px;padding:8px 12px;cursor:pointer;">é–‰ã˜ã‚‹</button>
              </div>
            </div>`;
          document.body.appendChild(modal);
          document.getElementById('profileCloseBtn').onclick=()=>{ document.body.removeChild(modal); };
        };
      });
    }
    const _confPrev = document.getElementById('confPrev');
    const _confNext = document.getElementById('confNext');
    const _confReload = document.getElementById('confReload');
    if (_confPrev) _confPrev.onclick=()=>{ if(--confMonth<0){confMonth=11;confYear--;} renderConfirm(); };
    if (_confNext) _confNext.onclick=()=>{ if(++confMonth>11){confMonth=0;confYear++;} renderConfirm(); };
    if (_confReload) _confReload.onclick=()=>{ renderConfirm(); };

  </script>
</body>
</html> 