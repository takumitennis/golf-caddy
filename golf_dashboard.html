<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Golf Dashboard</title>
  <style>
    body{font-family:'Segoe UI',sans-serif;margin:0;background:#f5f6fa}
    h1{margin:0;padding:20px 24px;background:#2c3e50;color:#fff;font-size:1.4rem;text-wrap:balance}
    .container{padding:24px}
    .tabs-main{display:flex;gap:8px;padding:0 24px;background:#ecf0f1;flex-wrap:wrap}
    .tabs-main button{background:#ecf0f1;border:none;padding:12px 16px;font-weight:600;border-bottom:3px solid transparent;cursor:pointer;white-space:nowrap}
    .tabs-main button.active{border-color:#3498db;background:#fff;border-radius:4px 4px 0 0;color:#3498db;font-weight:bold}
    table{background:#fff;border-radius:6px;overflow:hidden}
    .tabs button{padding:10px 16px;margin-right:8px;border:none;border-bottom:2px solid transparent;background:#eaeaea;cursor:pointer}
    .tabs button.active{border-bottom-color:#0077cc;background:#fff}
    .hidden{display:none}
    form{margin-bottom:30px}
    input,button{padding:8px;margin-right:10px}
    @media (max-width: 768px){
      .tabs-main{padding:0 12px}
      .tabs-main button{padding:10px 12px;font-size:.95rem}
      table{font-size:.95rem}
      th,td{padding:6px}
    }
    th,td{border:1px solid #ccc;padding:8px;text-align:center}
    th{background:#f2f2f2}
    .calendar th,.calendar td{width:14%;padding:6px;text-align:center;border:1px solid #ccc}
    .cal-green{background:#c8e6c9}
    .cal-yellow{background:#fff9c4}
    .cal-red{background:#ffcdd2}
    .tabs-main button{padding:10px 16px;margin-right:8px;border:none;border-bottom:2px solid transparent;background:#e0e0e0;cursor:pointer}
    .tabs-main button.active{border-bottom-color:#0077cc;background:#fff}
    /* --- LINE風チャットUI --- */
    #mainMessages {
      display: flex;
      flex-direction: column;
      height: 70vh;
      max-height: 600px;
      background: #f7f7f7;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      overflow: hidden;
      position: relative;
    }
    #messagesList {
      flex: 1;
      overflow-y: auto;
      padding: 24px 16px 16px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: #f7f7f7;
    }
    .chat-bubble {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 18px;
      font-size: 1rem;
      line-height: 1.5;
      position: relative;
      word-break: break-word;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
      margin-bottom: 2px;
    }
    .chat-bubble.sent {
      background: #d1f5d3;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    .chat-bubble.received {
      background: #fff;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      border: 1px solid #e0e0e0;
    }
    .chat-meta {
      font-size: 0.8rem;
      color: #888;
      margin-top: 2px;
      text-align: right;
    }
    .chat-meta.received {
      text-align: left;
    }
    #chatInputArea {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      background: #fff;
      border-top: 1px solid #e0e0e0;
      position: absolute;
      left: 0; right: 0; bottom: 0;
    }
    #chatInput {
      flex: 1;
      padding: 10px 14px;
      border-radius: 20px;
      border: 1px solid #ccc;
      font-size: 1rem;
      outline: none;
    }
    #sendChatBtn {
      background: #27ae60;
      color: #fff;
      border: none;
      border-radius: 20px;
      padding: 0 20px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    #sendChatBtn:hover {
      background: #219150;
    }
    /* 既読未読バッジ */
    .chat-badge {
      display: inline-block;
      font-size: 0.7rem;
      color: #fff;
      background: #aaa;
      border-radius: 8px;
      padding: 1px 6px;
      margin-left: 6px;
      vertical-align: middle;
    }
    .chat-badge.unread {
      background: #e74c3c;
    }
    .chat-badge.read {
      background: #27ae60;
    }
    /* 予約バー */
    #reserveBar {
      position: fixed;
      left: 16px;
      right: 16px;
      bottom: 16px;
      display: none;
      background: #ffffff;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      padding: 12px 16px;
      z-index: 200;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    #reserveBar .reserve-info { color:#333; font-size: 0.95rem; }
    #reserveBar button {
      border: none; padding: 8px 14px; border-radius: 8px; cursor: pointer; font-weight: 600;
    }
    #reserveBtn { background:#27ae60; color:#fff; }
    #reserveCancel { background:#eee; color:#333; }
  </style>
</head>
<body>
  <h1>ゴルフ場マイページ<!-- v=2025-08-10-01 --></h1>
  <div class="tabs-main">
    <button id="btnMainProf">プロフィール</button>
    <button id="btnMainStat" class="active">予約管理</button>
    <button id="btnMainMsg" style="display:none;">メッセージ</button>
    <button id="logoutBtn" style="margin-left:auto;">Logout</button>
  </div>
  <div id="welcome" style="margin-top:10px;"></div>
  <!-- 予約バー -->
  <div id="reserveBar">
    <div class="reserve-info"><span id="reserveDateText"></span> を予約しますか？</div>
    <div style="display:flex; gap:8px;">
      <button id="reserveCancel">キャンセル</button>
      <button id="reserveBtn">予約する</button>
    </div>
  </div>
  <!-- Profile Tab -->
  <div id="mainProfile" class="hidden" style="margin-top:15px;"></div>
  <script>
    function renderCreateProfile(email){
      const el = document.getElementById('mainProfile');
      if (!el) return;
      el.classList.remove('hidden');
      el.innerHTML = `
        <div style="max-width:560px;margin:0 auto;background:#fff;border-radius:8px;padding:16px;box-shadow:0 2px 6px rgba(0,0,0,.08)">
          <h3 style="margin-top:0">まずはプロフィールを登録してください</h3>
          <form id="gcCreateForm">
            <div style="margin-bottom:12px;">
              <label style="display:block;margin-bottom:4px;">ゴルフ場名</label>
              <input type="text" id="gcName" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;" />
            </div>
            <div style="margin-bottom:12px;">
              <label style="display:block;margin-bottom:4px;">担当者名</label>
              <input type="text" id="gcContact" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;" />
            </div>
            <div style="margin-bottom:12px;">
              <label style="display:block;margin-bottom:4px;">電話番号</label>
              <input type="tel" id="gcPhone" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;" />
            </div>
            <div style="margin-bottom:12px;">
              <label style="display:block;margin-bottom:4px;">特典</label>
              <input type="text" id="gcPerks" placeholder="例: 打ちっぱなし無料 など" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;" />
            </div>
            <div style="text-align:right;">
              <button type="submit" style="background:#27ae60;color:#fff;border:none;border-radius:6px;padding:10px 16px;">保存して予約管理へ</button>
            </div>
          </form>
        </div>`;
      const form = document.getElementById('gcCreateForm');
      if (form){
        form.onsubmit = async (e)=>{
          e.preventDefault();
          const name = document.getElementById('gcName').value.trim();
          const contact = document.getElementById('gcContact').value.trim();
          const phone = document.getElementById('gcPhone').value.trim();
          const perks = document.getElementById('gcPerks').value.trim();
          if (!name){ alert('ゴルフ場名を入力してください'); return; }
          try{
            // gid を生成（簡易）
            const { data: u } = await supabase.auth.getUser();
            const generatedGid = 'g' + (u.user?.id||Date.now().toString()).slice(0,6);
            const { error } = await supabase.from('golf_courses').insert({ gid: generatedGid, email, name, contact_name: contact, phone, perks });
            if (error) throw error;
            gid = generatedGid; hasProfile = true;
            document.getElementById('welcome').textContent = `ようこそ ${name} 様`;
            // 予約管理を有効化
            const mainStatus = document.getElementById('mainStatus');
            if (mainStatus) mainStatus.classList.remove('hidden');
            switchMain('stat');
            // イベントバインド再設定
            initializeEventListeners();
          }catch(err){
            alert('保存に失敗しました: ' + (err.message||err));
          }
        };
      }
    }
  </script>
  
  <!-- Status Tab (existing content) -->
  <div id="mainStatus">
    <!-- Tabs -->
    <div class="tabs">
      <button id="btnTab1" class="active">空きキャディ確認</button>
      <button id="btnTabConfirm">予約確認</button>
      <button id="btnTab3">研修可能日設定</button>
      <button id="btnTab4">研修予約者一覧</button>
    </div>

    <!-- Tab Confirm: 予約確認 -->
    <div id="tabConfirm" class="hidden" style="margin-top:20px;">
      <div style="display:flex;align-items:center;gap:10px;">
        <button id="confPrev">◀</button>
        <span id="confTitle"></span>
        <button id="confNext">▶</button>
        <button id="confReload" style="margin-left:auto;">再読み込み</button>
      </div>
      <table style="margin-top:10px; width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="text-align:left; padding:6px; border-bottom:1px solid #eee;">日付</th>
            <th style="text-align:left; padding:6px; border-bottom:1px solid #eee;">確定キャディ数</th>
            <th style="text-align:left; padding:6px; border-bottom:1px solid #eee;">参加キャディ</th>
          </tr>
        </thead>
        <tbody id="confirmBody"></tbody>
      </table>
    </div>

    <!-- Tab 2: availability calendar -->
    <div id="tab2" class="hidden" style="margin-top:20px;">
      <div style="display:flex;align-items:center;gap:10px;">
        <button id="prevMonth">◀</button>
        <span id="calTitle"></span>
        <button id="nextMonth">▶</button>
      </div>
      <table class="calendar" id="calTable" style="margin-top:10px;border-collapse:collapse;width:100%"></table>
      
    </div>

    <!-- Tab 3: Training availability -->
    <div id="tab3" class="hidden" style="margin-top:20px;">
      <h3>研修可能日設定</h3>
      <div style="display:flex;align-items:center;gap:10px;">
        <button id="prevTrainingMonth">◀</button>
        <span id="trainingCalTitle"></span>
        <button id="nextTrainingMonth">▶</button>
      </div>
      <table class="calendar" id="trainingCalTable" style="margin-top:10px;border-collapse:collapse;width:100%"></table>
      <small style="display:block;margin-top:8px;">青=設定済み, 白=未設定 | クリックで設定/解除</small>
    </div>

    <!-- Tab 4: Training requests -->
    <div id="tab4" class="hidden" style="margin-top:20px;">
      <h3>研修予約者一覧</h3>
      <div id="trainingRequestsList"></div>
    </div>
  </div>

  <!-- Messages Tab -->
  <div id="mainMessages" class="hidden">
    <div id="messagesList"></div>
    <div id="chatInputArea" style="display:none;">
      <input id="chatInput" type="text" placeholder="メッセージを入力..." autocomplete="off" />
      <button id="sendChatBtn">送信</button>
    </div>
  </div>



  <!-- Training slots modal -->
  <div id="trainingSlotsModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;z-index:100;">
    <div style="background:#fff;padding:24px;border-radius:8px;width:90%;max-width:400px;">
      <h3>研修可能人数設定</h3>
      <p id="modalDateDisplay"></p>
      <label for="slotsInput">同時可能人数:</label>
      <input type="number" id="slotsInput" min="1" max="10" value="1" style="width:100%;padding:8px;margin:8px 0;font-size:1rem;">
      <div style="margin-top:20px;text-align:right;">
        <button id="cancelSlotsModal" style="padding:8px 16px;border:1px solid #ccc;background:#f0f0f0;border-radius:4px;cursor:pointer;">キャンセル</button>
        <button id="saveSlotsModal" style="margin-left:10px;padding:8px 16px;border:none;background:#3498db;color:#fff;border-radius:4px;cursor:pointer;">保存</button>
      </div>
    </div>
  </div>

  <!-- New Message Modal -->
  <div id="newMessageModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); align-items:center; justify-content:center; z-index:100;">
    <div style="background:#fff; padding:24px; border-radius:8px; width:90%; max-width:500px;">
      <h3>新規メッセージ</h3>
      <div style="margin-bottom:15px;">
        <label>送信先:</label>
        <select id="messageReceiver" style="width:100%; padding:8px; margin-top:5px;">
          <option value="">送信先を選択</option>
        </select>
      </div>
      <div style="margin-bottom:15px;">
        <label>件名:</label>
        <input type="text" id="messageSubject" style="width:100%; padding:8px; margin-top:5px;">
      </div>
      <div style="margin-bottom:15px;">
        <label>内容:</label>
        <textarea id="messageContent" rows="5" style="width:100%; padding:8px; margin-top:5px;"></textarea>
      </div>
      <div style="text-align:right;">
        <button id="cancelMessage" style="padding:8px 16px; border:1px solid #ccc; background:#f0f0f0; border-radius:4px; cursor:pointer;">キャンセル</button>
        <button id="sendMessage" style="margin-left:10px; padding:8px 16px; border:none; background:#3498db; color:#fff; border-radius:4px; cursor:pointer;">送信</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    /*
    Required Supabase table:
    
    CREATE TABLE IF NOT EXISTS public.training_availability (
      id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
      gid TEXT NOT NULL,
      date DATE NOT NULL,
      max_slots INT DEFAULT 1,
      created_at TIMESTAMP DEFAULT NOW(),
      UNIQUE(gid, date)
    );
    
    ALTER TABLE public.training_availability ENABLE ROW LEVEL SECURITY;
    */
    const supabase = window.supabase.createClient(
      "https://vqjxajzaasuqfgvhvxci.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxanhhanphYXN1cWZndmh2eGNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2MjIxMzgsImV4cCI6MjA2OTE5ODEzOH0.NmKwgZA1_-TTvMTQt07QRXtIlR-DPOPATVPuQ3QuO54"
    );

    let gid = null;
    let hasProfile = false;
    let isInitialized = false;
    // Month/Year state must be initialized before any render* is called
    let calMonth = new Date().getMonth();
    let calYear = new Date().getFullYear();
    let trainingCalMonth = new Date().getMonth();
    let trainingCalYear = new Date().getFullYear();
    // Training requests list month
    let trMonth = new Date().getMonth();
    let trYear = new Date().getFullYear();
    // Inline chat mode flag for training (no booking_id)
    let inlineTrainingMode = false;
    let confMonth = new Date().getMonth();
    let confYear = new Date().getFullYear();
    
    // 1. Check login & role and initialize everything
    supabase.auth.getUser().then(async ({ data }) => {
      if (!data.user) { location.href = "/"; return; }
      const role = data.user.user_metadata?.role;
      if (role !== "golf") { location.href = "dashboard.html"; return; }
      
      // get golf_courses row to fetch gid & name
      const { data: rows } = await supabase
        .from("golf_courses")
        .select("gid,name,contact_name,phone,perks,image_url,description")
        .eq("email", data.user.email)
        .single();
        
      if (!rows) {
        // 未登録: プロフィール作成フォームを表示し、予約管理は案内のみにする
        hasProfile = false;
        const mainStatus = document.getElementById('mainStatus');
        if (mainStatus) mainStatus.classList.add('hidden');
        renderCreateProfile(data.user.email);
        // タブ遷移: 予約管理を押したらプロフィール作成へ誘導
        const btnStat = document.getElementById('btnMainStat');
        if (btnStat) btnStat.onclick = (e)=>{ e.preventDefault?.(); alert('まずプロフィールを登録してください'); switchMain('prof'); };
        const btnProf = document.getElementById('btnMainProf');
        if (btnProf) btnProf.onclick = (e)=>{ e.preventDefault?.(); switchMain('prof'); };
        switchMain('prof');
        return;
      }
      
      gid = rows.gid; hasProfile = true;
      document.getElementById("welcome").textContent = `ようこそ ${rows.name} 様`;
      
      // populate profile tab
      const profHtml = `
        <div style="max-width:800px;margin:0 auto;">
          <div style="display:flex;gap:20px;margin-bottom:20px;">
            <div style="flex-shrink:0;">
              <div id="profileImageContainer" style="width:200px;height:200px;border:2px dashed #ccc;border-radius:8px;display:flex;align-items:center;justify-content:center;background:#f9f9f9;position:relative;overflow:hidden;">
                ${rows.image_url ? 
                  `<img src="${rows.image_url}" alt="ゴルフ場画像" style="width:100%;height:100%;object-fit:cover;">` : 
                  `<div style="text-align:center;color:#666;">
                    <div style="font-size:3rem;margin-bottom:10px;">🏌️</div>
                    <div>画像をアップロード</div>
                  </div>`
                }
                <input type="file" id="imageUpload" accept="image/*" style="position:absolute;inset:0;opacity:0;cursor:pointer;">
              </div>
              <div style="text-align:center;margin-top:8px;">
                <small style="color:#666;">クリックして画像を変更</small>
              </div>
            </div>
            
            <div style="flex:1;">
              <h3 style="margin-top:0;color:#2c3e50;">${rows.name}</h3>
              <div id="profileDescription" style="background:#f8f9fa;padding:15px;border-radius:6px;margin-bottom:15px;min-height:100px;">
                ${rows.description ? rows.description.replace(/\n/g, '<br>') : 'ゴルフ場の説明を入力してください...'}
              </div>
              <button id="editDescriptionBtn" style="background:#3498db;color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;">説明を編集</button>
            </div>
          </div>
          
          <div style="background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
            <h4 style="margin-top:0;color:#2c3e50;">基本情報</h4>
            <table style="border-collapse:collapse;width:100%;">
              <tr><th style="text-align:left;padding:8px;border-bottom:1px solid #eee;width:120px;">ゴルフ場名</th><td style="padding:8px;border-bottom:1px solid #eee;">${rows.name}</td></tr>
              <tr><th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">担当者名</th><td style="padding:8px;border-bottom:1px solid #eee;">${rows.contact_name||'未設定'}</td></tr>
              <tr><th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">電話番号</th><td style="padding:8px;border-bottom:1px solid #eee;">${rows.phone||'未設定'}</td></tr>
              <tr><th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">特典</th><td style="padding:8px;border-bottom:1px solid #eee;">${rows.perks||'未設定'}</td></tr>
            </table>
            <button id="editProfileBtn" style="background:#27ae60;color:#fff;border:none;padding:10px 20px;border-radius:4px;cursor:pointer;margin-top:15px;">プロフィールを編集</button>
          </div>
        </div>
        
        <!-- Description Edit Modal -->
        <div id="descriptionModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;z-index:100;">
          <div style="background:#fff;padding:24px;border-radius:8px;width:90%;max-width:500px;">
            <h3>ゴルフ場説明の編集</h3>
            <textarea id="descriptionTextarea" placeholder="ゴルフ場の特徴、コースの魅力、アクセス方法などを入力してください..." style="width:100%;height:150px;padding:12px;border:1px solid #ddd;border-radius:4px;font-family:inherit;resize:vertical;"></textarea>
            <div style="margin-top:20px;text-align:right;">
              <button id="cancelDescriptionBtn" style="padding:8px 16px;border:1px solid #ccc;background:#f0f0f0;border-radius:4px;cursor:pointer;">キャンセル</button>
              <button id="saveDescriptionBtn" style="margin-left:10px;padding:8px 16px;border:none;background:#3498db;color:#fff;border-radius:4px;cursor:pointer;">保存</button>
            </div>
          </div>
        </div>
        
        <!-- Profile Edit Modal -->
        <div id="profileEditModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;z-index:100;">
          <div style="background:#fff;padding:24px;border-radius:8px;width:90%;max-width:500px;">
            <h3>プロフィール情報の編集</h3>
            <form id="profileEditForm">
              <div style="margin-bottom:15px;">
                <label style="display:block;margin-bottom:5px;font-weight:600;">担当者名</label>
                <input type="text" id="editContactName" value="${rows.contact_name||''}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
              </div>
              <div style="margin-bottom:15px;">
                <label style="display:block;margin-bottom:5px;font-weight:600;">電話番号</label>
                <input type="tel" id="editPhone" value="${rows.phone||''}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
              </div>
              <div style="margin-bottom:15px;">
                <label style="display:block;margin-bottom:5px;font-weight:600;">キャディ特典</label>
                <textarea id="editPerks" placeholder="打ちっぱなし無料、食事提供など..." style="width:100%;height:80px;padding:8px;border:1px solid #ddd;border-radius:4px;resize:vertical;">${rows.perks||''}</textarea>
              </div>
            </form>
            <div style="margin-top:20px;text-align:right;">
              <button id="cancelProfileEditBtn" style="padding:8px 16px;border:1px solid #ccc;background:#f0f0f0;border-radius:4px;cursor:pointer;">キャンセル</button>
              <button id="saveProfileEditBtn" style="margin-left:10px;padding:8px 16px;border:none;background:#27ae60;color:#fff;border-radius:4px;cursor:pointer;">保存</button>
            </div>
          </div>
        </div>`;
      document.getElementById('mainProfile').innerHTML = profHtml;
      
      // 旧UIの残骸に依存しないようガード
      try {
      await loadBookings();
      } catch (e) {
        console.warn('loadBookings skipped:', e?.message || e);
      }
      
      // Initialize all event listeners after gid is set
      initializeEventListeners();
      isInitialized = true;
      
      // If currently on training requests tab, load the data
      if (document.getElementById('tab4').classList.contains('hidden') === false) {
        loadTrainingRequests();
      }
    });

    // 2. load bookings
    async function loadBookings(){
      // 予約確認タブで最新状態を描画するための補助。旧UI要素(bookBody)がない場合は何もしない
      const tbody = document.getElementById('bookBody');
      if (!tbody) return;
      const { data, error } = await supabase
        .from('bookings')
        .select('booking_id,date,slots,status')
        .eq('gid', gid)
        .order('date', { ascending: true });
      tbody.innerHTML = '';
      if (error){ console.error(error); return; }
      (data||[]).forEach(b => {
        tbody.insertAdjacentHTML('beforeend',
          `<tr><td>${b.date}</td><td>${b.slots}</td><td>${b.status}</td></tr>`);
      });
    }

    // 3. create booking (UIが存在する場合のみセット)
    const createFormEl = document.getElementById('createForm');
    if (createFormEl) {
      createFormEl.onsubmit = async e => {
      e.preventDefault();
        const date = document.getElementById('bDate')?.value;
        const slots = parseInt(document.getElementById('bSlots')?.value, 10);
      if (!date || !slots) return;
        const { error } = await supabase.from('bookings').insert({ gid, date, slots });
      if (error){ alert(error.message); return; }
      e.target.reset();
      loadBookings();
    };
    }

    // Training slots modal functions
    let currentEditingDate = null;
    
    function showTrainingSlotsModal(dateStr) {
      currentEditingDate = dateStr;
      document.getElementById('modalDateDisplay').textContent = `日付: ${dateStr}`;
      document.getElementById('slotsInput').value = 1;
      document.getElementById('trainingSlotsModal').style.display = 'flex';
    }
    
    async function removeTrainingAvailability(dateStr) {
      try {
        const { error } = await supabase
          .from('training_availability')
          .delete()
          .eq('gid', gid)
          .eq('date', dateStr);
        if (error) throw error;
        renderTrainingCal();
      } catch (error) {
        alert('削除エラー: ' + error.message);
      }
    }
    
    async function saveTrainingAvailability() {
      console.log('saveTrainingAvailability called');
      console.log('gid:', gid);
      console.log('currentEditingDate:', currentEditingDate);
      
      // DOM要素の存在確認
      const slotsInputElement = document.getElementById('slotsInput');
      if (!slotsInputElement) {
        alert('エラー: 人数入力フィールドが見つかりません');
        return;
      }
      
      const maxSlots = parseInt(slotsInputElement.value);
      console.log('maxSlots:', maxSlots);
      
      // データ検証
      if (!gid) {
        alert('エラー: ゴルフ場情報が設定されていません。ページを再読み込みしてください。');
        return;
      }
      
      if (!currentEditingDate) {
        alert('エラー: 編集対象の日付が設定されていません');
        return;
      }
      
      if (!maxSlots || maxSlots < 1 || maxSlots > 10) {
        alert('有効な人数（1-10）を入力してください');
        return;
      }
      
      try {
        console.log('Inserting data:', { gid, date: currentEditingDate, max_slots: maxSlots });
        
        // Use a more robust approach with detailed error checking
        console.log('Attempting to save training availability...');
        
        // First check if the record exists
        const { data: existingData, error: checkError } = await supabase
          .from('training_availability')
          .select('id')
          .eq('gid', gid)
          .eq('date', currentEditingDate)
          .maybeSingle();
        
        console.log('Existing record check:', { existingData, checkError });
        
        let result;
        if (checkError) {
          console.error('Error checking existing record:', checkError);
          throw new Error(`データベース接続エラー: ${checkError.message || checkError.toString()}`);
        }
        
        if (existingData) {
          // Record exists, update it
          console.log('Updating existing record...');
          result = await supabase
            .from('training_availability')
            .update({ max_slots: maxSlots })
            .eq('gid', gid)
            .eq('date', currentEditingDate);
        } else {
          // Record doesn't exist, insert new one
          console.log('Inserting new record...');
          result = await supabase
            .from('training_availability')
            .insert({ gid, date: currentEditingDate, max_slots: maxSlots });
        }
        
        const { data, error } = result;
        console.log('Final operation result:', { data, error });
        
        if (error) {
          console.error('Supabase error details:', {
            message: error.message,
            code: error.code,
            details: error.details,
            hint: error.hint,
            full: error
          });
          
          // Specific error handling with more details
          let errorMessage = 'Unknown database error';
          
          if (error.code === '42P01') {
            errorMessage = 'データベーステーブル "training_availability" が存在しません。管理者にお問い合わせください。';
          } else if (error.code === '23505') {
            errorMessage = 'この日付は既に設定されています。';
          } else if (error.code === '23503') {
            errorMessage = 'ゴルフ場IDが無効です。';
          } else if (error.code === '42501') {
            errorMessage = 'データベースへのアクセス権限がありません。RLSポリシーを確認してください。';
          } else if (error.message) {
            errorMessage = `データベースエラー: ${error.message}`;
          } else if (error.toString && typeof error.toString === 'function') {
            errorMessage = `エラー: ${error.toString()}`;
          }
          
          throw new Error(errorMessage);
        }
        
        console.log('Successfully saved training availability');
        document.getElementById('trainingSlotsModal').style.display = 'none';
        renderTrainingCal();
      } catch (error) {
        console.error('Full error object:', error);
        const errorMessage = error.message || error.toString() || 'Unknown error';
        alert('保存エラー: ' + errorMessage);
      }
    }

    // Initialize all event listeners after gid is available
    function initializeEventListeners() {
      // --- Tabs logic ---
      const tab2=document.getElementById('tab2');
      const tab3=document.getElementById('tab3');
      const tab4=document.getElementById('tab4');
      const tabConfirm=document.getElementById('tabConfirm');
      const btnTab1=document.getElementById('btnTab1');
      const btnTabConfirm=document.getElementById('btnTabConfirm');
      const btnTab3=document.getElementById('btnTab3');
      const btnTab4=document.getElementById('btnTab4');
      
      if (btnTab1) btnTab1.onclick=()=>{switchTab(1)};
      if (btnTabConfirm) btnTabConfirm.onclick=()=>{switchTab(5)};
      if (btnTab3) btnTab3.onclick=()=>{switchTab(3)};
      if (btnTab4) btnTab4.onclick=()=>{switchTab(4)};

      // --- Calendar logic ---
      document.getElementById('prevMonth').onclick=()=>{if(--calMonth<0){calMonth=11;calYear--;} renderCal();};
      document.getElementById('nextMonth').onclick=()=>{if(++calMonth>11){calMonth=0;calYear++;} renderCal();};
      
      // Training calendar navigation
      document.getElementById('prevTrainingMonth').onclick=()=>{
        if(--trainingCalMonth<0){trainingCalMonth=11;trainingCalYear--;} 
        renderTrainingCal();
      };
      document.getElementById('nextTrainingMonth').onclick=()=>{
        if(++trainingCalMonth>11){trainingCalMonth=0;trainingCalYear++;} 
        renderTrainingCal();
      };

      // ---- main tabs ----
      const mainProfileDiv=document.getElementById('mainProfile');
      const mainStatusDiv=document.getElementById('mainStatus');
      const mainMessagesDiv=document.getElementById('mainMessages');
      const btnMainProf=document.getElementById('btnMainProf');
      const btnMainStat=document.getElementById('btnMainStat');
      const btnMainMsg=document.getElementById('btnMainMsg');
      
      // logout
      document.getElementById('logoutBtn').onclick=async()=>{await supabase.auth.signOut();location.href='/';};
      
      // Training slots modal events
      document.getElementById('cancelSlotsModal').onclick = () => {
        document.getElementById('trainingSlotsModal').style.display = 'none';
      };
      document.getElementById('saveSlotsModal').onclick = saveTrainingAvailability;
      
      // Profile image upload
      const imageUpload = document.getElementById('imageUpload');
      if (imageUpload) {
        imageUpload.onchange = handleImageUpload;
      }
      
      // Description edit modal events
      const editDescriptionBtn = document.getElementById('editDescriptionBtn');
      if (editDescriptionBtn) {
        editDescriptionBtn.onclick = () => {
          const currentDescription = document.getElementById('profileDescription').textContent;
          document.getElementById('descriptionTextarea').value = currentDescription;
          document.getElementById('descriptionModal').style.display = 'flex';
        };
      }
      
      document.getElementById('cancelDescriptionBtn').onclick = () => {
        document.getElementById('descriptionModal').style.display = 'none';
      };
      
      document.getElementById('saveDescriptionBtn').onclick = saveDescription;
      
      // Profile edit modal events
      const editProfileBtn = document.getElementById('editProfileBtn');
      if (editProfileBtn) {
        editProfileBtn.onclick = () => {
          document.getElementById('profileEditModal').style.display = 'flex';
        };
      }
      
      document.getElementById('cancelProfileEditBtn').onclick = () => {
        document.getElementById('profileEditModal').style.display = 'none';
      };
      
      document.getElementById('saveProfileEditBtn').onclick = saveProfileEdit;

      // 初期表示は「空きキャディ確認」を開く（年/月初期化後）
      try { switchTab(1); } catch (e) { console.warn('switchTab init warn:', e?.message || e); }
      // インラインメッセージ領域は対象タブ以外では表示させない
      document.addEventListener('click', (ev)=>{
        const tgt = ev.target;
        if (!tgt) return;
        // 予約管理内タブ切替時
        if (tgt.id==='btnTab1' || tgt.id==='btnTab3' || tgt.id==='btnTabConfirm') {
          const inline = document.getElementById('inlineMessageArea');
          if (inline) inline.remove();
          inlineTrainingMode = false;
        }
        // 上段メインタブ切替時
        if (tgt.id==='btnMainProf' || tgt.id==='btnMainStat' || tgt.id==='btnMainMsg') {
          const inline = document.getElementById('inlineMessageArea');
          if (inline) inline.remove();
          inlineTrainingMode = false;
        }
      }, true);
    }

    // --- Calendar variables (initialized at top) ---

    async function renderCal(){
      const first = new Date(calYear,calMonth,1);
      const last  = new Date(calYear,calMonth+1,0);
      document.getElementById('calTitle').textContent = `${calYear}年 ${calMonth+1}月`;
      // fetch availability rows for month
      const { data, error } = await supabase
        .from('caddy_availability')
        .select('date')
        .gte('date', first.toISOString().slice(0,10))
        .lte('date', last.toISOString().slice(0,10));
      const countMap = {};
      if(!error){
        data.forEach(r=>{countMap[r.date]=(countMap[r.date]||0)+1;});
      }
      // build calendar grid
      const table=document.getElementById('calTable');
      table.innerHTML='';
      const headerRow=document.createElement('tr');
      ['日','月','火','水','木','金','土'].forEach(d=>{
        const th=document.createElement('th');th.textContent=d;headerRow.appendChild(th);
      });
      table.appendChild(headerRow);
      let row=document.createElement('tr');
      const startWeekDay=first.getDay();
      for(let i=0;i<startWeekDay;i++){row.appendChild(document.createElement('td'));}
      for(let day=1;day<=last.getDate();day++){
        const dateStr=`${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const td=document.createElement('td');
        const cnt=countMap[dateStr]||0;
        const labelHtml = cnt===0 ? '×' : `<span class="avail-count" data-date="${dateStr}" style="color:#3498db;font-weight:600">${cnt}人</span>`;
        if(cnt===0){td.className='cal-red';}
        else{td.className='';}
        td.innerHTML = `<small>${day}</small><br>${labelHtml}`;
        td.style.cursor='default';
        row.appendChild(td);
        if((startWeekDay+day)%7===0){table.appendChild(row);row=document.createElement('tr');}
      }
      if(row.children.length) {
        while(row.children.length<7)row.appendChild(document.createElement('td'));
        table.appendChild(row);
      }
    }
    // Training calendar variables (initialized at top)

    // render calendar on tab switch
    function switchTab(idx){
      // Query elements each time to avoid undefined references
      const tab2 = document.getElementById('tab2');
      const tabConfirm = document.getElementById('tabConfirm');
      const tab3 = document.getElementById('tab3');
      const tab4 = document.getElementById('tab4');
      const btnTab1 = document.getElementById('btnTab1');
      const btnTabConfirm = document.getElementById('btnTabConfirm');
      const btnTab3 = document.getElementById('btnTab3');
      const btnTab4 = document.getElementById('btnTab4');

      // Hide all tabs
      [tab2, tabConfirm, tab3, tab4].forEach(tab => tab && tab.classList.add('hidden'));
      [btnTab1, btnTabConfirm, btnTab3, btnTab4].forEach(btn => btn && btn.classList.remove('active'));
      
      if(idx===1){
        // 空きキャディ確認に切り替え時はインラインメッセージを消す
        const inline = document.getElementById('inlineMessageArea');
        if (inline) inline.remove();
        inlineTrainingMode = false;
        if (tab2) tab2.classList.remove('hidden');
        if (btnTab1) btnTab1.classList.add('active');
        renderCal();
      } else if(idx===5){
        // 予約確認に切り替え時は前月のインライン欄が残らないよう消去
        const inline = document.getElementById('inlineMessageArea');
        if (inline) inline.remove();
        inlineTrainingMode = false;
        if (tabConfirm) tabConfirm.classList.remove('hidden');
        if (btnTabConfirm) btnTabConfirm.classList.add('active');
        renderConfirm();
      } else if(idx===3){
        // 研修可能日設定に切り替わるタイミングでインラインメッセージは消す
        const inline = document.getElementById('inlineMessageArea');
        if (inline) inline.remove();
        inlineTrainingMode = false;
        if (tab3) tab3.classList.remove('hidden');
        if (btnTab3) btnTab3.classList.add('active');
        renderTrainingCal();
      } else if(idx===4){
        // 研修予約者一覧に切り替え時もインラインメッセージは消す
        const inline = document.getElementById('inlineMessageArea');
        if (inline) inline.remove();
        inlineTrainingMode = false;
        if (tab4) tab4.classList.remove('hidden');
        if (btnTab4) btnTab4.classList.add('active');
        if (gid) {
          loadTrainingRequests();
        } else {
          const listEl = document.getElementById('trainingRequestsList');
          if (listEl) listEl.innerHTML = '<p>読み込み中...</p>';
          // Wait for gid to be initialized
          const checkGid = setInterval(() => {
            if (gid) {
              clearInterval(checkGid);
              loadTrainingRequests();
            }
          }, 100);
        }
      }
    }

    // ---- main tabs ----
    const mainProfileDiv=document.getElementById('mainProfile');
    const mainStatusDiv=document.getElementById('mainStatus');
    const mainMessagesDiv=document.getElementById('mainMessages');
    const btnMainProf=document.getElementById('btnMainProf');
    const btnMainStat=document.getElementById('btnMainStat');
    const btnMainMsg=document.getElementById('btnMainMsg');

    function switchMain(mode){
      // Query fresh elements in case DOM changed
      const mainProfileDiv=document.getElementById('mainProfile');
      const mainStatusDiv=document.getElementById('mainStatus');
      const mainMessagesDiv=document.getElementById('mainMessages');
      const btnMainProf=document.getElementById('btnMainProf');
      const btnMainStat=document.getElementById('btnMainStat');
      const btnMainMsg=document.getElementById('btnMainMsg');

      // hide all
      [mainProfileDiv, mainStatusDiv, mainMessagesDiv].forEach(el=>el && el.classList.add('hidden'));
      [btnMainProf, btnMainStat, btnMainMsg].forEach(btn=>btn && btn.classList.remove('active'));
      if(mode==='prof'){
        if (mainProfileDiv) mainProfileDiv.classList.remove('hidden');
        if (btnMainProf) btnMainProf.classList.add('active');
      } else if(mode==='stat'){
        if (mainStatusDiv) mainStatusDiv.classList.remove('hidden');
        if (btnMainStat) btnMainStat.classList.add('active');
      } else if(mode==='msg'){
        if (mainMessagesDiv) mainMessagesDiv.classList.remove('hidden');
        if (btnMainMsg) btnMainMsg.classList.add('active');
      }
    }

    // Main tab buttons (guarded)
    const _btnMainProf = document.getElementById('btnMainProf');
    const _btnMainStat = document.getElementById('btnMainStat');
    const _btnMainMsg = document.getElementById('btnMainMsg');
    if (_btnMainProf) _btnMainProf.onclick=(e)=>{ e.preventDefault?.(); switchMain('prof'); };
    if (_btnMainStat) _btnMainStat.onclick=(e)=>{ e.preventDefault?.(); switchMain('stat'); };
    if (_btnMainMsg) _btnMainMsg.onclick=(e)=>{ e.preventDefault?.(); /* hidden */ };

    // 予約バー制御
    const reserveBar = document.getElementById('reserveBar');
    const reserveDateText = document.getElementById('reserveDateText');
    let pendingReserveDate = null;

    document.addEventListener('click', (e) => {
      const target = e.target;
      if (target && target.classList && target.classList.contains('avail-count')) {
        pendingReserveDate = target.getAttribute('data-date');
        const d = new Date(pendingReserveDate);
        reserveDateText.textContent = `${d.getFullYear()}年 ${String(d.getMonth()+1)}月 ${String(d.getDate())}日 を予約しますか？`;
        reserveBar.style.display = 'flex';
      }
    });

    document.getElementById('reserveCancel').onclick = () => {
      reserveBar.style.display = 'none';
      pendingReserveDate = null;
    };

    document.getElementById('reserveBtn').onclick = async () => {
      if (!pendingReserveDate) return;
      reserveBar.style.display = 'none';
      await reserveBooking(pendingReserveDate);
      pendingReserveDate = null;
    };

    // 予約処理
    async function reserveBooking(dateStr){
      try{
        // 1) その日の空きキャディからランダムに1名抽出
        const { data: avails, error: aErr } = await supabase
          .from('caddy_availability')
          .select('cid')
          .eq('date', dateStr);
        if(aErr) throw aErr;
        if(!avails || avails.length===0){ alert('この日は空きキャディがいません'); return; }
        const cidList = avails.map(a=> a.cid).filter(Boolean);
        const randomCid = cidList[Math.floor(Math.random()*cidList.length)];

        // 2) bookings 存在確認 or 作成
        const { data: existing, error: exErr } = await supabase
          .from('bookings')
          .select('booking_id')
          .eq('gid', gid)
          .eq('date', dateStr)
          .maybeSingle();
        if(exErr && exErr.code!=='PGRST116') throw exErr;
        let bookingId;
        if(existing){ bookingId = existing.booking_id; }
        else{
          const { data: created, error: crErr } = await supabase
            .from('bookings')
            .insert({ gid, date: dateStr, slots: 1, status: 'pending' })
            .select('booking_id')
            .single();
          if(crErr) throw crErr;
          bookingId = created.booking_id;
        }

        // 3) booking_caddies に割当
        const { error: bcErr } = await supabase
          .from('booking_caddies')
          .insert({ booking_id: bookingId, cid: randomCid });
        if(bcErr) throw bcErr;

        // 4) caddy_availability から該当cidのその日を削除（キャディ側スケジュール反映）
        const { error: delErr } = await supabase
          .from('caddy_availability')
          .delete()
          .eq('cid', randomCid)
          .eq('date', dateStr);
        if(delErr) throw delErr;

        alert('予約が完了しました！');
        // UI 更新
        await loadBookings();
        await renderCal();
      } catch(err){
        console.error(err);
        alert('予約に失敗しました: ' + (err.message || JSON.stringify(err)));
      }
    }

    // Training calendar rendering
    async function renderTrainingCal(){
      if (!gid) {
        console.error('gid is not set yet');
        return;
      }
      
      const first = new Date(trainingCalYear, trainingCalMonth, 1);
      const last = new Date(trainingCalYear, trainingCalMonth + 1, 0);
      document.getElementById('trainingCalTitle').textContent = `${trainingCalYear}年 ${trainingCalMonth + 1}月`;
      
      // Fetch existing training availability with slot counts
      const { data: availData, error } = await supabase
        .from('training_availability')
        .select('date, max_slots')
        .eq('gid', gid)
        .gte('date', first.toISOString().slice(0,10))
        .lte('date', last.toISOString().slice(0,10));
      
      const availabilityMap = new Map();
      if (!error && availData) {
        availData.forEach(r => availabilityMap.set(r.date, r.max_slots || 1));
      }
      
      // Build calendar grid
      const table = document.getElementById('trainingCalTable');
      table.innerHTML = '';
      const headerRow = document.createElement('tr');
      ['日','月','火','水','木','金','土'].forEach(d => {
        const th = document.createElement('th');
        th.textContent = d;
        headerRow.appendChild(th);
      });
      table.appendChild(headerRow);
      
      let row = document.createElement('tr');
      const startWeekDay = first.getDay();
      for(let i = 0; i < startWeekDay; i++){
        row.appendChild(document.createElement('td'));
      }
      
      for(let day = 1; day <= last.getDate(); day++){
        const dateStr = `${trainingCalYear}-${String(trainingCalMonth + 1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const td = document.createElement('td');
        const maxSlots = availabilityMap.get(dateStr);
        const isAvailable = maxSlots !== undefined;
        
        td.innerHTML = `<div style="padding:8px;text-align:center;">
          <div style="font-weight:bold;">${day}</div>
          ${isAvailable ? `<small>${maxSlots}人</small>` : ''}
        </div>`;
        td.style.cursor = 'pointer';
        td.style.backgroundColor = isAvailable ? '#3498db' : '#fff';
        td.style.color = isAvailable ? '#fff' : '#000';
        td.style.border = '1px solid #ccc';
        
        td.onclick = () => {
          if (!gid) {
            alert('ゴルフ場情報が読み込まれていません。ページを再読み込みしてください。');
            return;
          }
          
          if (isAvailable) {
            // Show confirmation for removal
            if (confirm(`${dateStr} の研修可能日設定を削除しますか？`)) {
              removeTrainingAvailability(dateStr);
            }
          } else {
            // Show slots modal for adding
            showTrainingSlotsModal(dateStr);
          }
        };
        
        row.appendChild(td);
        if((startWeekDay + day) % 7 === 0){
          table.appendChild(row);
          row = document.createElement('tr');
        }
      }
      
      if(row.children.length) {
        while(row.children.length < 7) row.appendChild(document.createElement('td'));
        table.appendChild(row);
      }
    }

    // Load training requests
    async function loadTrainingRequests(){
      console.log('Loading training requests for gid:', gid);
      
      const container = document.getElementById('trainingRequestsList');
      
      if (!gid) {
        console.error('gid is not set when loading training requests');
        container.innerHTML = '<p>ゴルフ場情報が読み込まれていません。ページを再読み込みしてください。</p>';
        return;
      }
      
      try {
        // First get training requests
        console.log('Querying training_requests for gid:', gid);
        
        // まず、training_requestsテーブルが存在するか確認
        const { data: tableCheck, error: tableError } = await supabase
          .from('training_requests')
          .select('id')
          .limit(1);
        
        console.log('Table check result:', { tableCheck, tableError });
        
      // 当月フィルタ
      const first = `${trainingCalYear}-${String(trainingCalMonth+1).padStart(2,'0')}-01`;
      const lastDate = new Date(trainingCalYear, trainingCalMonth+1, 0).getDate();
      const last = `${trainingCalYear}-${String(trainingCalMonth+1).padStart(2,'0')}-${String(lastDate).padStart(2,'0')}`;
        const { data: requests, error: requestsError } = await supabase
          .from('training_requests')
          .select('id, cid, training_date, status, created_at')
          .eq('gid', gid)
          .gte('training_date', first)
          .lte('training_date', last)
          .order('training_date', { ascending: false });
        
        console.log('Training requests query result:', { requests, requestsError });
        
        if (requestsError) {
          console.error('Error loading training requests:', requestsError);
          container.innerHTML = `<p>エラー: ${requestsError.message}</p>`;
          return;
        }
        
        if (!requests || requests.length === 0) {
          console.log('No training requests found');
          container.innerHTML = '<p>研修予約はありません。</p>';
          return;
        }
        
        // Then get caddy details for each request
        const cidList = requests.map(r => r.cid);
        const { data: caddies, error: caddiesError } = await supabase
          .from('caddies')
          .select('cid, name, phone, email, university, golf_years, caddy_years, appeal')
          .in('cid', cidList);
        
        console.log('Caddies query result:', { caddies, caddiesError });
        
        if (caddiesError) {
          console.error('Error loading caddies:', caddiesError);
          container.innerHTML = `<p>エラー: ${caddiesError.message}</p>`;
          return;
        }
        
        // Create a map for quick lookup
        const caddyMap = new Map();
        if (caddies) {
          caddies.forEach(c => caddyMap.set(c.cid, c));
        }
        
        // Combine the data
        const data = requests.map(request => ({
          ...request,
          caddies: caddyMap.get(request.cid) || {}
        }));
        
        console.log('Combined training requests data:', data);
        
        if (!data || data.length === 0) {
          console.log('No training requests found for this golf course');
          // Also try to load all requests to see if any exist
          const { data: allData, error: allError } = await supabase
            .from('training_requests')
            .select('id, gid, cid, training_date, status, created_at');
          
          console.log('All training requests in database:', { allData, allError });
          
          // デバッグ用：現在のgidと一致するリクエストを確認
          if (allData && allData.length > 0) {
            const matchingRequests = allData.filter(req => req.gid === gid);
            console.log('Matching requests for current gid:', matchingRequests);
          }
          
          container.innerHTML = '<p>研修予約はありません。</p>';
          return;
        }
        
        let html = '';
        data.forEach((request, index) => {
        const caddy = request.caddies;
        const statusText = request.status === 'pending' ? '申込中' : 
                          request.status === 'confirmed' ? '確定' : 
                          request.status === 'completed' ? '完了' : '取消';
        const statusColor = request.status === 'pending' ? '#f39c12' : 
                           request.status === 'confirmed' ? '#27ae60' : 
                           request.status === 'completed' ? '#3498db' : '#e74c3c';
        
        html += `
          <div class="training-request-item" style="border:1px solid #ddd; margin-bottom:8px; padding:12px; border-radius:6px; background:#fff; cursor:pointer;" onclick="toggleRequestDetail('${request.id}')">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div>
                <strong>${caddy?.name || '不明'}</strong>
                <span style="color:#666; margin-left:10px;">希望研修日: ${request.training_date || '日付未選択'}</span>
              </div>
              <span style="display:flex; align-items:center; gap:8px;">
                <button class="trProfile" data-cid="${caddy?.cid||''}" onclick="event.stopPropagation()">プロフィール</button>
                <button class="trMessage" data-cid="${caddy?.cid||''}" data-date="${request.training_date}" onclick="event.stopPropagation()">メッセージ</button>
              <span style="background:${statusColor}; color:#fff; padding:4px 8px; border-radius:4px; font-size:0.9em;">${statusText}</span>
              </span>
            </div>
            
            <div id="detail-${request.id}" class="request-detail" style="display:none; margin-top:12px; padding-top:12px; border-top:1px solid #eee;">
              <h5>キャディ詳細情報</h5>
              <p><strong>申込日:</strong> ${request.created_at?.slice(0,10) || '不明'}</p>
              <p><strong>電話:</strong> ${caddy?.phone || '不明'}</p>
              <p><strong>メール:</strong> ${caddy?.email || '不明'}</p>
              <p><strong>大学:</strong> ${caddy?.university || '不明'}</p>
              <p><strong>ゴルフ歴:</strong> ${caddy?.golf_years || '不明'}年</p>
              <p><strong>キャディ歴:</strong> ${caddy?.caddy_years || '不明'}年</p>
              <p><strong>アピール:</strong> ${caddy?.appeal || 'なし'}</p>
              
              ${request.status === 'pending' ? `
                <div style="margin-top:12px;">
                  <button onclick="event.stopPropagation(); updateTrainingStatus('${request.id}', 'confirmed')" style="background:#2ecc71; color:#fff; border:none; padding:8px 16px; border-radius:4px; cursor:pointer; margin-right:8px;">承認</button>
                  <button onclick="event.stopPropagation(); updateTrainingStatus('${request.id}', 'cancelled')" style="background:#e74c3c; color:#fff; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">拒否</button>
                </div>
              ` : ''}
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;

      // 研修: プロフィール
      Array.from(document.getElementsByClassName('trProfile')).forEach(btn=>{
        btn.onclick = async (e)=>{
          const cid = e.currentTarget.getAttribute('data-cid');
          if (!cid) return;
          const { data: caddy, error } = await supabase
            .from('caddies')
            .select('cid,name,phone,email,university,golf_years,caddy_years,appeal,avatar_url')
            .eq('cid', cid)
            .maybeSingle();
          if (error) { alert(error.message); return; }
          const modal = document.createElement('div');
          modal.style.cssText = 'position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:200;';
          modal.innerHTML = `
            <div style="background:#fff; width:92%; max-width:520px; border-radius:10px; padding:16px;">
              <h3 style="margin:0 0 8px;">キャディプロフィール</h3>
              <div style="display:flex; gap:12px;">
                <img src="${caddy?.avatar_url||''}" alt="avatar" style="width:96px;height:96px;border-radius:50%;object-fit:cover;background:#eee;"/>
                <div>
                  <div><b>氏名:</b> ${caddy?.name||'-'}</div>
                  <div><b>大学:</b> ${caddy?.university||'-'}</div>
                  <div><b>ゴルフ経験:</b> ${caddy?.golf_years||'-'} 年</div>
                  <div><b>キャディ経験:</b> ${caddy?.caddy_years||'-'} 年</div>
                </div>
              </div>
              <div style="margin-top:10px; white-space:pre-wrap; background:#f8f9fa; border:1px solid #eee; padding:10px; border-radius:6px;">${caddy?.appeal||''}</div>
              <div style="text-align:right;margin-top:12px;">
                <button id="trProfileCloseBtn" style="background:#eee;border:1px solid #ddd;border-radius:6px;padding:8px 12px;cursor:pointer;">閉じる</button>
              </div>
            </div>`;
          document.body.appendChild(modal);
          document.getElementById('trProfileCloseBtn').onclick=()=>{ document.body.removeChild(modal); };
        };
      });

      // 研修: メッセージ（当月・インライン）
      Array.from(document.getElementsByClassName('trMessage')).forEach(btn=>{
        btn.onclick = async (e)=>{
          const cid = e.currentTarget.getAttribute('data-cid');
          chatPartnerId = cid;
          chatPartnerName = '研修希望キャディ';
          currentBookingId = `training:${trainingCalYear}-${String(trainingCalMonth+1).padStart(2,'0')}`; // 擬似ID（messagesのbooking_id列がNULL許容なら別分岐可）
          const mainStatusDiv = document.getElementById('mainStatus');
          if (mainStatusDiv) {
            let inline = document.getElementById('inlineMessageArea');
            if (!inline) {
              inline = document.createElement('div');
              inline.id = 'inlineMessageArea';
              inline.innerHTML = `
                <div style=\"margin-top:12px; background:#fff; border:1px solid #eee; border-radius:8px;\">
                  <div id=\"inlineMessagesList\" style=\"max-height:260px; overflow:auto; padding:12px;\"></div>
                  <div style=\"display:flex; gap:8px; padding:12px; border-top:1px solid #eee;\">
                    <input id=\"inlineChatInput\" type=\"text\" placeholder=\"メッセージを入力...\" style=\"flex:1; padding:8px; border:1px solid #ccc; border-radius:6px;\" />
                    <button id=\"inlineSendChatBtn\" style=\"background:#27ae60;color:#fff;border:none;border-radius:6px;padding:8px 14px;\">送信</button>
                  </div>
                </div>`;
              mainStatusDiv.appendChild(inline);
            }
            inlineTrainingMode = true;
            await loadChatMessages(true);
            const sendBtn = document.getElementById('inlineSendChatBtn');
            const inputEl = document.getElementById('inlineChatInput');
            if (sendBtn && inputEl) {
              sendBtn.onclick = async ()=>{ await sendChatMessage(true); };
              inputEl.onkeydown = (ev)=>{ if (ev.key==='Enter') sendBtn.click(); };
            }
          }
        };
      });
      } catch (error) {
        console.error('Error in loadTrainingRequests:', error);
        const errorMessage = error.message || '不明なエラーが発生しました';
        document.getElementById('trainingRequestsList').innerHTML = `<p>読み込みエラー: ${errorMessage}</p>`;
      }
    }

    // Toggle training request detail display
    window.toggleRequestDetail = function(requestId) {
      const detailElement = document.getElementById(`detail-${requestId}`);
      if (detailElement) {
        detailElement.style.display = detailElement.style.display === 'none' ? 'block' : 'none';
      }
    }

    // Update training request status
    window.updateTrainingStatus = async (requestId, status) => {
      const { error } = await supabase
        .from('training_requests')
        .update({ status, updated_at: new Date().toISOString() })
        .eq('id', requestId);
      
      if (error) {
        alert('ステータス更新に失敗しました: ' + error.message);
      } else {
        alert('ステータスを更新しました');
        
        // 承認の場合、キャディにメッセージを送信
        if (status === 'confirmed') {
          const request = await supabase
            .from('training_requests')
            .select('cid, training_date')
            .eq('id', requestId)
            .single();
          
          if (request.data) {
            const caddy = await supabase
              .from('caddies')
              .select('name')
              .eq('cid', request.data.cid)
              .single();
            
            if (caddy.data) {
              await sendMessageToCaddy(request.data.cid, caddy.data.name, request.data.training_date);
            }
          }
        }
        
        loadTrainingRequests(); // Reload the list
      }
    };

    // Send message to caddy when training is confirmed
    async function sendMessageToCaddy(cid, caddyName, trainingDate) {
      try {
        const { error } = await supabase
          .from('messages')
          .insert({
            sender_type: 'golf_course',
            sender_id: gid,
            receiver_type: 'caddy',
            receiver_id: cid,
            subject: '研修承認のお知らせ',
            content: `${caddyName}様\n\n研修申込が承認されました。\n研修日: ${trainingDate}\n\n詳細については、お電話またはメールでご連絡いたします。\n\nよろしくお願いいたします。`
          });
        
        if (error) {
          console.error('Message send error:', error);
        }
      } catch (error) {
        console.error('Message send error:', error);
      }
    }

    // Load messages
    async function loadMessages(type = 'inbox') {
      console.log('Loading messages for type:', type, 'gid:', gid);
      const messagesList = document.getElementById('messagesList');
      
      if (!messagesList) {
        console.error('messagesList element not found');
        return;
      }
      
      try {
        let query;
        if (type === 'inbox') {
          query = supabase
          .from('messages')
          .select('*')
            .eq('receiver_type', 'golf_course')
            .eq('receiver_id', gid)
          .order('created_at', { ascending: false });
        } else {
          query = supabase
            .from('messages')
            .select('*')
            .eq('sender_type', 'golf_course')
            .eq('sender_id', gid)
            .order('created_at', { ascending: false });
        }
        
        const { data: messages, error } = await query;
        
        if (error) {
          messagesList.innerHTML = `<p>エラー: ${error.message}</p>`;
          return;
        }
        
        if (!messages || messages.length === 0) {
          messagesList.innerHTML = '<p>メッセージはありません。</p>';
          return;
        }
        
        let html = '';
        messages.forEach(message => {
          const isUnread = type === 'inbox' && !message.is_read;
          html += `
            <div style="border:1px solid #ddd; margin-bottom:8px; padding:12px; border-radius:6px; background:${isUnread ? '#f8f9fa' : '#fff'};">
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                  <strong>${message.subject}</strong>
                  ${isUnread ? '<span style="background:#e74c3c; color:#fff; padding:2px 6px; border-radius:3px; font-size:0.8em; margin-left:8px;">未読</span>' : ''}
                </div>
                <small style="color:#666;">${message.created_at?.slice(0,16).replace('T', ' ')}</small>
              </div>
              <p style="margin:8px 0; color:#666;">${message.content.substring(0, 100)}${message.content.length > 100 ? '...' : ''}</p>
            </div>
          `;
        });
        
        messagesList.innerHTML = html;
      } catch (error) {
        messagesList.innerHTML = `<p>エラー: ${error.message}</p>`;
      }
    }

    // Load caddies for message receiver selection
    async function loadCaddiesForMessage() {
      try {
        const { data: caddies, error } = await supabase
          .from('caddies')
          .select('cid, name, university')
          .order('name');
        
        if (error) {
          console.error('Error loading caddies:', error);
          return;
        }
        
        const select = document.getElementById('messageReceiver');
        select.innerHTML = '<option value="">送信先を選択</option>';
        
        if (caddies) {
          caddies.forEach(caddy => {
            select.innerHTML += `<option value="${caddy.cid}">${caddy.name} (${caddy.university})</option>`;
          });
        }
      } catch (error) {
        console.error('Error loading caddies:', error);
      }
    }

    // Send new message
    async function sendNewMessage() {
      const receiverId = document.getElementById('messageReceiver').value;
      const subject = document.getElementById('messageSubject').value.trim();
      const content = document.getElementById('messageContent').value.trim();
      
      if (!receiverId || !subject || !content) {
        alert('すべての項目を入力してください。');
        return;
      }
      
      try {
        const { error } = await supabase
          .from('messages')
          .insert({
            sender_type: 'golf_course',
            sender_id: gid,
            receiver_type: 'caddy',
            receiver_id: receiverId,
            subject: subject,
            content: content
          });
        
        if (error) {
          alert('メッセージ送信に失敗しました: ' + error.message);
        } else {
          alert('メッセージを送信しました');
          document.getElementById('newMessageModal').style.display = 'none';
          document.getElementById('messageSubject').value = '';
          document.getElementById('messageContent').value = '';
          loadMessages('sent');
        }
      } catch (error) {
        alert('メッセージ送信に失敗しました: ' + error.message);
      }
    }

    // Profile image upload handler
    async function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      if (file.size > 5 * 1024 * 1024) { // 5MB limit
        alert('ファイルサイズは5MB以下にしてください');
        return;
      }
      
      try {
        // Upload to Supabase Storage
        const fileExt = file.name.split('.').pop();
        const fileName = `${gid}_${Date.now()}.${fileExt}`;
        
        const { data: uploadData, error: uploadError } = await supabase.storage
          .from('golf-course-images')
          .upload(fileName, file);
        
        if (uploadError) throw uploadError;
        
        // Get public URL
        const { data: urlData } = supabase.storage
          .from('golf-course-images')
          .getPublicUrl(fileName);
        
        // Update database
        const { error: updateError } = await supabase
          .from('golf_courses')
          .update({ image_url: urlData.publicUrl })
          .eq('gid', gid);
        
        if (updateError) throw updateError;
        
        // Update UI
        const container = document.getElementById('profileImageContainer');
        container.innerHTML = `<img src="${urlData.publicUrl}" alt="ゴルフ場画像" style="width:100%;height:100%;object-fit:cover;">
                              <input type="file" id="imageUpload" accept="image/*" style="position:absolute;inset:0;opacity:0;cursor:pointer;">`;
        
        // Re-attach event listener
        document.getElementById('imageUpload').onchange = handleImageUpload;
        
        alert('画像をアップロードしました');
      } catch (error) {
        console.error('Image upload error:', error);
        alert('画像アップロードに失敗しました: ' + error.message);
      }
    }

    // Save description
    async function saveDescription() {
      const description = document.getElementById('descriptionTextarea').value.trim();
      
      try {
        const { error } = await supabase
          .from('golf_courses')
          .update({ description })
          .eq('gid', gid);
        
        if (error) throw error;
        
        // Update UI
        document.getElementById('profileDescription').innerHTML = description.replace(/\n/g, '<br>');
        document.getElementById('descriptionModal').style.display = 'none';
        
        alert('説明を保存しました');
      } catch (error) {
        console.error('Description save error:', error);
        alert('説明の保存に失敗しました: ' + error.message);
      }
    }

    // Save profile edit
    async function saveProfileEdit() {
      const contactName = document.getElementById('editContactName').value.trim();
      const phone = document.getElementById('editPhone').value.trim();
      const perks = document.getElementById('editPerks').value.trim();
      
      try {
        const { error } = await supabase
          .from('golf_courses')
          .update({ 
            contact_name: contactName,
            phone: phone,
            perks: perks
          })
          .eq('gid', gid);
        
        if (error) throw error;
        
        // Update UI
        const profileTable = document.querySelector('#mainProfile table');
        if (profileTable) {
          const rows = profileTable.querySelectorAll('tr');
          rows[1].cells[1].textContent = contactName || '未設定';
          rows[2].cells[1].textContent = phone || '未設定';
          rows[3].cells[1].textContent = perks || '未設定';
        }
        
        document.getElementById('profileEditModal').style.display = 'none';
        
        alert('プロフィールを更新しました');
      } catch (error) {
        console.error('Profile edit error:', error);
        alert('プロフィールの更新に失敗しました: ' + error.message);
      }
    }

    /* --- LINE風チャットUI --- */
    // チャットUI用メッセージ取得・表示
    let chatPartnerId = null; // チャット相手ID
    let chatPartnerName = '';
    let currentBookingId = null; // 現在の予定ID

    // 予定一覧を表示
    async function showBookingList() {
      const messagesList = document.getElementById('messagesList');
      messagesList.innerHTML = '<div style="text-align:center;color:#aaa;">読み込み中...</div>';
      
      // ゴルフ場の予定を取得（現在のメッセージ表示は当月のみ）
      const first = `${calYear}-${String(calMonth+1).padStart(2,'0')}-01`;
      const lastDate = new Date(calYear, calMonth+1, 0).getDate();
      const last = `${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(lastDate).padStart(2,'0')}`;
      const { data: bookings, error } = await supabase
        .from('bookings')
                  .select(`
            *,
            booking_caddies (
              cid,
              caddies (
                cid,
                name
              )
            )
          `)
        .eq('gid', gid)
        .gte('date', first)
        .lte('date', last)
        .order('date', { ascending: false });

      if (error) {
        messagesList.innerHTML = `<div style='color:#e74c3c;'>エラー: ${error.message}</div>`;
        return;
      }

      if (!bookings || bookings.length === 0) {
        messagesList.innerHTML = '<div style="text-align:center;color:#aaa;">予定はありません</div>';
        return;
      }

      messagesList.innerHTML = '<h3 style="margin-bottom:16px;color:#333;">予定一覧</h3>';
      bookings.forEach(booking => {
        const bookingDiv = document.createElement('div');
        bookingDiv.style.cssText = `
          background: #fff;
          border: 1px solid #e0e0e0;
          border-radius: 8px;
          padding: 12px;
          margin-bottom: 8px;
          cursor: pointer;
          transition: background 0.2s;
        `;
        bookingDiv.onmouseover = () => bookingDiv.style.background = '#f5f5f5';
        bookingDiv.onmouseout = () => bookingDiv.style.background = '#fff';
        
        const caddyNames = booking.booking_caddies?.map(bc => bc.caddies?.name).filter(Boolean).join(', ') || 'キャディ未確定';
        const date = booking.date || '不明';
        
        bookingDiv.innerHTML = `
          <div style="font-weight:bold;color:#333;">${date}</div>
          <div style="color:#666;font-size:0.9rem;">キャディ: ${caddyNames}</div>
          <div style="color:#27ae60;font-size:0.8rem;margin-top:4px;">タップしてチャット</div>
        `;
        
        bookingDiv.onclick = () => {
          currentBookingId = booking.booking_id;
          // 最初のキャディとチャット（本来は選択UIが必要）
          const firstCaddy = booking.booking_caddies?.[0];
          if (firstCaddy) {
            chatPartnerId = firstCaddy.cid;
            chatPartnerName = firstCaddy.caddies?.name || 'キャディ';
            loadChatMessages();
          } else {
            alert('この予定にはキャディが割り当てられていません');
          }
        };
        
        messagesList.appendChild(bookingDiv);
      });
    }

    async function loadChatMessages(inline=false) {
      if (!chatPartnerId || !currentBookingId) {
        // 入力欄を隠す
        const area = inline ? document.getElementById('inlineMessageArea') : document.getElementById('chatInputArea');
        if (!inline && area) area.style.display = 'none';
        if (!inline) showBookingList();
        return;
      }

      const messagesList = inline ? document.getElementById('inlineMessagesList') : document.getElementById('messagesList');
      messagesList.innerHTML = `
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;padding:8px;background:#f0f0f0;border-radius:8px;">
          <button onclick="showBookingList()" style="background:none;border:none;cursor:pointer;font-size:1.2rem;">←</button>
          <div>
            <div style="font-weight:bold;">${chatPartnerName}</div>
            <div style="font-size:0.8rem;color:#666;">予定に関する連絡</div>
          </div>
        </div>
      `;

      // 入力欄を表示
      if (!inline) document.getElementById('chatInputArea').style.display = 'flex';

      // 予定に関連するメッセージを取得
      let messages, error;
      if (inlineTrainingMode) {
        ({ data: messages, error } = await supabase
          .from('messages')
          .select('*')
          .or(`and(sender_id.eq.${gid},receiver_id.eq.${chatPartnerId}),and(sender_id.eq.${chatPartnerId},receiver_id.eq.${gid})`)
          .is('booking_id', null)
          .order('created_at', { ascending: true }));
      } else {
        ({ data: messages, error } = await supabase
          .from('messages')
          .select('*')
          .or(`and(sender_id.eq.${gid},receiver_id.eq.${chatPartnerId}),and(sender_id.eq.${chatPartnerId},receiver_id.eq.${gid})`)
          .eq('booking_id', currentBookingId)
          .order('created_at', { ascending: true }));
      }

      if (error) {
        messagesList.innerHTML += `<div style='color:#e74c3c;'>エラー: ${error.message}</div>`;
        return;
      }

      if (!messages || messages.length === 0) {
        messagesList.innerHTML += '<div style="text-align:center;color:#aaa;margin-top:20px;">メッセージはありません</div>';
      } else {
        messages.forEach(msg => {
          const isSent = msg.sender_id === gid;
          const bubble = document.createElement('div');
          bubble.className = 'chat-bubble ' + (isSent ? 'sent' : 'received');
          bubble.innerHTML = `${msg.content}<div class='chat-meta${isSent ? '' : ' received'}'>${new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}${msg.is_read ? "<span class='chat-badge read'>既読</span>" : (!isSent ? "<span class='chat-badge unread'>未読</span>" : '')}</div>`;
          messagesList.appendChild(bubble);
        });
      }
      
      // スクロール最下部へ
      messagesList.scrollTop = messagesList.scrollHeight;
    }

    // メッセージ送信
    async function sendChatMessage(inline=false) {
      const input = inline ? document.getElementById('inlineChatInput') : document.getElementById('chatInput');
      const content = input.value.trim();
      if (!content || !chatPartnerId || !currentBookingId) return;
      
      const { error } = await supabase.from('messages').insert({
        sender_type: 'golf_course', 
        sender_id: gid,
        receiver_type: 'caddy', 
        receiver_id: chatPartnerId,
        booking_id: inlineTrainingMode ? null : currentBookingId,
        subject: '予定に関する連絡',
        content,
        is_read: false
      });
      
      if (error) {
        alert('送信エラー: ' + error.message);
        return;
      }
      
      input.value = '';
      loadChatMessages();
    }

    document.getElementById('sendChatBtn').onclick = sendChatMessage;
    document.getElementById('chatInput').onkeydown = e => { if (e.key === 'Enter') sendChatMessage(); };

    // メッセージタブを開いたら予定一覧を表示
    async function showChatWithCaddy() {
      showBookingList();
    }



    // 注: ランダム差配方針のため、空きキャディ一覧のポップアップは廃止
// 必要な場合は、確定時にプロフィールを表示します。


    // 予約確認：当月の予約（bookings＋booking_caddies＋caddies）
    async function renderConfirm(){
      const title = document.getElementById('confTitle');
      title.textContent = `${confYear}年 ${confMonth+1}月`;
      const tbody = document.getElementById('confirmBody');
      tbody.innerHTML = '<tr><td colspan="3" style="padding:8px;color:#888;">読み込み中...</td></tr>';
      const first = `${confYear}-${String(confMonth+1).padStart(2,'0')}-01`;
      const lastDate = new Date(confYear, confMonth+1, 0).getDate();
      const last = `${confYear}-${String(confMonth+1).padStart(2,'0')}-${String(lastDate).padStart(2,'0')}`;
      const { data: bookings, error } = await supabase
        .from('bookings')
        .select(`
          booking_id,date,
          booking_caddies!inner (
            cid,
            caddies (cid,name,phone,email,university)
          )
        `)
        .eq('gid', gid)
        .gte('date', first)
        .lte('date', last)
        .order('date', { ascending: true });
      if(error){ tbody.innerHTML = `<tr><td colspan='3' style='padding:8px;color:#e74c3c;'>${error.message}</td></tr>`; return; }
      if(!bookings || bookings.length===0){ tbody.innerHTML = `<tr><td colspan='3' style='padding:8px;color:#888;'>当月の予約はありません</td></tr>`; return; }
      tbody.innerHTML='';
      bookings.forEach(b=>{
        const cList = b.booking_caddies?.map(bc => bc.caddies?.name || bc.cid).filter(Boolean) || [];
        const count = cList.length;
        const names = cList.map(n=>`<span style='margin-right:8px;'>${n}</span>`).join('');
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style='padding:8px;border-bottom:1px solid #eee;'>${b.date}</td>
          <td style='padding:8px;border-bottom:1px solid #eee;'>${count} 名</td>
          <td style='padding:8px;border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; gap:8px;'>
            <span>${names}</span>
            <span>
              <button data-bid='${b.booking_id}' class='btnProfile' style='margin-right:8px;'>プロフィール</button>
              <button data-bid='${b.booking_id}' class='btnMsgToCaddies'>メッセージ</button>
            </span>
          </td>
        `;
        tbody.appendChild(tr);
      });
      // メッセージ導線（該当予約の各キャディと個別に）
      Array.from(document.getElementsByClassName('btnMsgToCaddies')).forEach(btn=>{
        btn.onclick = async (e)=>{
          const bid = e.currentTarget.getAttribute('data-bid');
          // 予約の最初のキャディへ（本来は選択UIに拡張可能）
          const b = bookings.find(x=>x.booking_id===bid);
          const firstCaddy = b?.booking_caddies?.[0]?.cid;
          if(firstCaddy){
            currentBookingId = bid;
            chatPartnerId = firstCaddy;
            chatPartnerName = b.booking_caddies?.[0]?.caddies?.name || 'キャディ';
            // メッセージ欄を予約者一覧の下に展開
            const mainStatusDiv = document.getElementById('mainStatus');
            if (mainStatusDiv) {
              const existing = document.getElementById('inlineMessageArea');
              if (!existing) {
                const inline = document.createElement('div');
                inline.id = 'inlineMessageArea';
                inline.innerHTML = `
                  <div style="margin-top:12px; background:#fff; border:1px solid #eee; border-radius:8px;">
                    <div id="inlineMessagesList" style="max-height:260px; overflow:auto; padding:12px;"></div>
                    <div style="display:flex; gap:8px; padding:12px; border-top:1px solid #eee;">
                      <input id="inlineChatInput" type="text" placeholder="メッセージを入力..." style="flex:1; padding:8px; border:1px solid #ccc; border-radius:6px;" />
                      <button id="inlineSendChatBtn" style="background:#27ae60;color:#fff;border:none;border-radius:6px;padding:8px 14px;">送信</button>
                    </div>
                  </div>`;
                mainStatusDiv.appendChild(inline);
              }
              inlineTrainingMode = false;
              await loadChatMessages(true);
              const sendBtn = document.getElementById('inlineSendChatBtn');
              const inputEl = document.getElementById('inlineChatInput');
              if (sendBtn && inputEl) {
                sendBtn.onclick = async ()=>{
                  await sendChatMessage(true);
                };
                inputEl.onkeydown = (ev)=>{ if (ev.key==='Enter') sendBtn.click(); };
              }
            }
          }
        };
      });

      // プロフィールボタン（キャディプロフィール表示）
      Array.from(document.getElementsByClassName('btnProfile')).forEach(btn=>{
        btn.onclick = async (e)=>{
          const bid = e.currentTarget.getAttribute('data-bid');
          const b = bookings.find(x=>x.booking_id===bid);
          const first = b?.booking_caddies?.[0]?.cid;
          if (!first) return;
          const { data: caddy, error } = await supabase
            .from('caddies')
            .select('cid,name,phone,email,university,golf_years,caddy_years,appeal,avatar_url')
            .eq('cid', first)
            .maybeSingle();
          if (error) { alert(error.message); return; }
          const modal = document.createElement('div');
          modal.style.cssText = 'position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:200;';
          modal.innerHTML = `
            <div style="background:#fff; width:92%; max-width:520px; border-radius:10px; padding:16px;">
              <h3 style="margin:0 0 8px;">キャディプロフィール</h3>
              <div style="display:flex; gap:12px;">
                <img src="${caddy?.avatar_url||''}" alt="avatar" style="width:96px;height:96px;border-radius:50%;object-fit:cover;background:#eee;"/>
                <div>
                  <div><b>氏名:</b> ${caddy?.name||'-'}</div>
                  <div><b>大学:</b> ${caddy?.university||'-'}</div>
                  <div><b>ゴルフ経験:</b> ${caddy?.golf_years||'-'} 年</div>
                  <div><b>キャディ経験:</b> ${caddy?.caddy_years||'-'} 年</div>
                </div>
              </div>
              <div style="margin-top:10px; white-space:pre-wrap; background:#f8f9fa; border:1px solid #eee; padding:10px; border-radius:6px;">
                ${caddy?.appeal||''}
              </div>
              <div style="text-align:right;margin-top:12px;">
                <button id="profileCloseBtn" style="background:#eee;border:1px solid #ddd;border-radius:6px;padding:8px 12px;cursor:pointer;">閉じる</button>
              </div>
            </div>`;
          document.body.appendChild(modal);
          document.getElementById('profileCloseBtn').onclick=()=>{ document.body.removeChild(modal); };
        };
      });
    }
    const _confPrev = document.getElementById('confPrev');
    const _confNext = document.getElementById('confNext');
    const _confReload = document.getElementById('confReload');
    if (_confPrev) _confPrev.onclick=()=>{ if(--confMonth<0){confMonth=11;confYear--;} renderConfirm(); };
    if (_confNext) _confNext.onclick=()=>{ if(++confMonth>11){confMonth=0;confYear++;} renderConfirm(); };
    if (_confReload) _confReload.onclick=()=>{ renderConfirm(); };

  </script>
</body>
</html> 